/*! researchflow - v1.0.0 - 2026-02-16 */
window.versionInfo&&console.log("Utils.js module loaded");let DEFAULT_PROJECT_SCHEMA={metadata:{title:"",description:"",goal:"",created:null,modified:null,version:"1.0"},plan:{templateName:"",templateDisplayName:"",ideas:[],outline:[],customSectionTitles:{},customSectionDescriptions:{}},write:{content:"",wordCount:0},edit:{content:"",suggestions:[]},chatHistory:[],ui:{currentTab:"plan"}};function createElement(tag,className,textContent=""){tag=document.createElement(tag);return className&&(tag.className=className),textContent&&(tag.textContent=textContent),tag}function generateId(){return Date.now().toString()+Math.random().toString(36).substr(2,9)}function formatDate(date){return new Date(date).toISOString()}function calculateWordCount(text){return text.trim().split(/\s+/).filter(word=>0<word.length).length}function deepClone(obj){return JSON.parse(JSON.stringify(obj))}function mergeObjects(target,source){return{...target,...source}}function validateRequiredFields(obj,requiredFields){requiredFields=requiredFields.filter(field=>!obj[field]);if(0<requiredFields.length)throw new Error("Missing required fields: "+requiredFields.join(", "));return!0}function sanitizeHtml(html){var div=document.createElement("div");return div.innerHTML=html,div.textContent||div.innerText||""}function truncateText(text,maxLength=100){return text.length<=maxLength?text:text.substr(0,maxLength)+"..."}function isElementInViewport(element){element=element.getBoundingClientRect();return 0<=element.top&&0<=element.left&&element.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&element.right<=(window.innerWidth||document.documentElement.clientWidth)}function scrollToElement(element,offset=0){element=element.getBoundingClientRect().top+window.pageYOffset-offset;window.scrollTo({top:element,behavior:"smooth"})}function throttle(func,limit){let inThrottle;return function(){var args=arguments;inThrottle||(func.apply(this,args),inThrottle=!0,setTimeout(()=>inThrottle=!1,limit))}}window.versionInfo&&console.log("API.js module loaded");class ProjectAPI{constructor(){this.ajaxUrl=window.ajaxUrl,this.apiEndpoint=window.apiEndpoint,this.sesskey=window.sesskey,this.cmId=window.cmId,null===this.apiEndpoint||""===this.apiEndpoint||"null"===this.apiEndpoint?(console.warn("⚠️ API Endpoint is not configured. AI features will not be available."),console.warn("Please configure the API endpoint in Site Administration → Plugins → Activity modules → AI Writing Assistant"),this.apiEndpoint=null):console.log("API Endpoint configured:",this.apiEndpoint),this.ajaxUrl&&this.sesskey&&this.cmId||console.error("Missing required API configuration")}async loadProject(){try{var result,formData=new URLSearchParams,response=(formData.append("action","load_project"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success?result.project:null;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(error){return console.error("Failed to load project:",error),null}}async loadChatHistoryOnly(sessionId=null){try{var result,formData=new URLSearchParams,response=(formData.append("action","load_chat_history_only"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),sessionId&&formData.append("session_id",sessionId),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success?result.chatHistory:[];throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(error){return console.error("Failed to load chat history:",error),[]}}async loadChatHistoryPage(limit=50,beforeTimestamp=null,timeoutMs=0,sessionId=null){try{var formData=new URLSearchParams;formData.append("action","load_chat_history_only"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),null!==limit&&0<limit&&formData.append("limit",String(limit)),null!==beforeTimestamp&&formData.append("before",String(beforeTimestamp)),sessionId&&formData.append("session_id",sessionId);let controller=0<timeoutMs?new AbortController:null,timeoutId=null;controller&&(timeoutId=setTimeout(()=>controller.abort(),timeoutMs));var response=await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData,signal:controller?controller.signal:void 0});if(timeoutId&&clearTimeout(timeoutId),!response.ok)throw new Error(`HTTP ${response.status}: `+response.statusText);var result=await response.json();let filtered=Array.isArray(result.chatHistory)?result.chatHistory:[];if(null!==beforeTimestamp){let beforeTime="string"==typeof beforeTimestamp?Date.parse(beforeTimestamp):beforeTimestamp<1e10?1e3*beforeTimestamp:beforeTimestamp;(filtered=filtered.filter(m=>("string"==typeof m.timestamp?Date.parse(m.timestamp):"number"==typeof m.timestamp?m.timestamp<1e10?1e3*m.timestamp:m.timestamp:0)<beforeTime)).length>limit&&(filtered=filtered.slice(0,limit))}else filtered.length>limit&&(filtered=filtered.slice(0,limit));return filtered}catch(e){return console.error("Failed to load chat history page:",e),[]}}async appendChatMessage(sessionId,role,content,timestamp=(new Date).toISOString()){try{var result,formData=new URLSearchParams,response=(formData.append("action","append_message"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("session_id",sessionId||"default"),formData.append("role",role),formData.append("content",content),formData.append("timestamp",String(timestamp)),console.log("appendChatMessage sending:",{sessionId:sessionId,role:role,contentLength:content.length,timestamp:timestamp}),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success||console.error("appendChatMessage returned success=false:",result),!!result.success;var errorText=await response.text();console.error("appendChatMessage HTTP error:",response.status,errorText);try{var errorJson=JSON.parse(errorText);console.error("appendChatMessage error details:",errorJson)}catch(e){}throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to append chat message:",e),!1}}async deleteIdea(ideaOrId){try{var formData=new URLSearchParams;if(formData.append("action","delete_idea"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),"number"==typeof ideaOrId||"string"==typeof ideaOrId&&/^\d+$/.test(ideaOrId))formData.append("idea_id",String(ideaOrId));else{if(!ideaOrId||"object"!=typeof ideaOrId)throw new Error("Invalid deleteIdea payload");var{content="",location="brainstorm",sectionId=""}=ideaOrId;formData.append("content",content),formData.append("location",location),sectionId&&formData.append("sectionId",sectionId)}var response=await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData});if(response.ok)return!!(await response.json()).success;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to delete idea:",e),!1}}async saveProject(projectData){try{projectData.metadata&&(projectData.metadata.modified=formatDate(new Date));var projectDataString=JSON.stringify(projectData),formData=(console.log("ProjectAPI.saveProject(): Sending data, size:",projectDataString.length,"bytes"),console.log("ProjectAPI.saveProject(): plan outline count:",projectData?.plan?.outline?.length||0),console.log("ProjectAPI.saveProject(): customSections count:",projectData?.plan?.customSections?.length||0),new URLSearchParams);formData.append("action","save_project"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("project_data",projectDataString),console.log("ProjectAPI.saveProject(): Making fetch request to:",this.ajaxUrl),console.log("ProjectAPI.saveProject(): Form data size:",formData.toString().length,"bytes");let response;try{response=await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData,mode:"same-origin"})}catch(networkError){throw console.error("ProjectAPI.saveProject(): Network error:",networkError),console.error("ProjectAPI.saveProject(): Error name:",networkError.name),console.error("ProjectAPI.saveProject(): Error message:",networkError.message),new Error("Network error: "+networkError.message)}console.log("ProjectAPI.saveProject(): Response status:",response.status,response.statusText);var responseText=await response.text(),contentType=(console.log("ProjectAPI.saveProject(): Response text length:",responseText.length),console.log("ProjectAPI.saveProject(): Response text (first 500 chars):",responseText.substring(0,500)),response.headers.get("content-type"));if(!contentType||!contentType.includes("application/json"))throw console.error("ProjectAPI.saveProject(): Received non-JSON response:",contentType),console.error("ProjectAPI.saveProject(): Response body:",responseText.substring(0,500)),new Error("Expected JSON but got "+contentType);if(!response.ok){console.error("ProjectAPI.saveProject(): Response error:",responseText);try{var errorJson=JSON.parse(responseText);throw console.error("ProjectAPI.saveProject(): Error JSON:",errorJson),new Error(errorJson.error||`HTTP ${response.status}: `+response.statusText)}catch(e){if(e.message&&e.message.includes("Error JSON"))throw e;throw new Error(`HTTP ${response.status}: `+response.statusText)}}let result;try{result=JSON.parse(responseText),console.log("ProjectAPI.saveProject(): Response success:",result.success),console.log("ProjectAPI.saveProject(): Full result:",JSON.stringify(result,null,2))}catch(parseError){throw console.error("ProjectAPI.saveProject(): JSON parse error:",parseError),console.error("ProjectAPI.saveProject(): Response text that failed to parse:",responseText),new Error("Failed to parse response as JSON: "+parseError.message)}if(result.success)return result;throw console.error("Save failed:",result.error||"Unknown error"),console.error("Full result:",JSON.stringify(result,null,2)),new Error(result.error||"Save failed")}catch(error){return console.error("Failed to save project:",error),console.error("Error stack:",error.stack),!1}}async logActivity(activities){try{var formData=new URLSearchParams,response=(formData.append("action","log_activity"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("activities",JSON.stringify(activities)),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(!response.ok)throw new Error("HTTP error! status: "+response.status);var result=await response.json();if(result.success)return result;throw new Error(result.error||"Failed to log activity")}catch(error){throw console.error("ProjectAPI: Error logging activity:",error),error}}async deleteProject(){try{var formData=new URLSearchParams,response=(formData.append("action","delete_project"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return!0===(await response.json()).success;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(error){return console.error("Failed to delete project:",error),!1}}async loadTemplate(templateId){try{if(window.templateData&&window.templateData.sections)return console.log("Using embedded template data"),window.templateData;var templateUrl=window.location.origin+`/mod/researchflow/data/templates/${templateId}.json`,response=await fetch(templateUrl,{cache:"no-store",credentials:"same-origin"});if(response.ok)return await response.json();throw new Error("Failed to load template: "+response.status)}catch(error){return console.error("Failed to load template:",error),{name:"Empty Template",sections:[]}}}async testConnection(){try{var result=await(await fetch(this.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin",body:new URLSearchParams({action:"test",cmid:this.cmId,sesskey:this.sesskey})})).json();return console.log("AJAX test result:",result),result.success}catch(error){return console.error("AJAX test failed:",error),!1}}async sendChatMessage(userMessage,currentProject=null){if(!this.ajaxUrl||!this.sesskey||!this.cmId)return console.error("Missing required API configuration"),{assistantReply:"Configuration error. Please refresh the page and try again.",updatedProject:null};currentProject=this.sanitizeProjectForAPI(currentProject);let projectDataString;try{projectDataString=JSON.stringify(currentProject||{})}catch(serializeError){return console.error("Failed to serialize request data:",serializeError),{assistantReply:"Error: Could not prepare request data for AI service.",updatedProject:null}}try{var result,formData=new URLSearchParams,response=(formData.append("action","proxy_chat"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("user_input",userMessage),formData.append("project_data",projectDataString),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData})),contentType=response.headers.get("content-type");return contentType&&contentType.includes("application/json")?(result=await response.json()).success?{assistantReply:result.assistantReply||null,updatedProject:result.project||null}:{assistantReply:result.assistantReply||result.error||"AI service error.",updatedProject:result.project||null}:{assistantReply:`API Error: Received ${response.status} ${response.statusText}. Expected JSON but got `+contentType,updatedProject:null}}catch(error){return console.error("Chat message failed:",error),{assistantReply:null,updatedProject:null}}}sanitizeProjectForAPI(project){if(!project)return null;project=JSON.parse(JSON.stringify(project));let htmlToText=html=>{var tempDiv;return html&&"string"==typeof html?((tempDiv=document.createElement("div")).innerHTML=html,tempDiv.textContent||tempDiv.innerText||""):html};if(project.write&&project.write.content&&(project.write.content=htmlToText(project.write.content)),project.edit&&project.edit.content&&(project.edit.content=htmlToText(project.edit.content)),project.plan&&project.plan.ideas){let ideasArray;ideasArray=Array.isArray(project.plan.ideas)?project.plan.ideas:"object"==typeof project.plan.ideas&&null!==project.plan.ideas?Object.values(project.plan.ideas):[],project.plan.ideas=ideasArray.map(idea=>({...idea,content:htmlToText(idea.content)}))}project.plan&&project.plan.outline&&(project.plan.outline=project.plan.outline.map(section=>({...section,title:htmlToText(section.title),description:htmlToText(section.description),bubbles:section.bubbles?section.bubbles.map(bubble=>({...bubble,content:htmlToText(bubble.content)})):[]})));let cleanObject=obj=>{if(null===obj||"object"!=typeof obj)return obj;if(Array.isArray(obj))return obj.map(cleanObject);var key,value,cleaned={};for([key,value]of Object.entries(obj))"function"==typeof value||value instanceof HTMLElement||(cleaned[key]=cleanObject(value));return cleaned};return cleanObject(project)}mergeUpdatedProject(currentProject,updatedProject){if(!updatedProject)return currentProject;let merged=JSON.parse(JSON.stringify(currentProject));return Object.keys(updatedProject).forEach(key=>{if("chatHistory"===key){if(Array.isArray(updatedProject[key])){let existingMessages=merged[key]||[];updatedProject[key].forEach(newMsg=>{existingMessages.some(existingMsg=>existingMsg.role===newMsg.role&&existingMsg.content===newMsg.content&&existingMsg.timestamp===newMsg.timestamp)||existingMessages.push(newMsg)}),merged[key]=existingMessages}}else"object"==typeof updatedProject[key]&&null!==updatedProject[key]?merged[key]=this.deepMerge(merged[key]||{},updatedProject[key]):merged[key]=updatedProject[key]}),merged}deepMerge(target,source){var key,result={...target};for(key in source)source[key]&&"object"==typeof source[key]&&!Array.isArray(source[key])?result[key]=this.deepMerge(target[key]||{},source[key]):result[key]=source[key];return result}async getVersionHistory(phase){try{var result,formData=new URLSearchParams,response=(formData.append("action","get_version_history"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("phase",phase),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success?result.versions:[];throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to get version history:",e),[]}}async getVersion(phase,versionNumber){try{var result,formData=new URLSearchParams,response=(formData.append("action","get_version"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("phase",phase),formData.append("version_number",String(versionNumber)),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success?result.version:null;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to get version:",e),null}}async restoreVersion(phase,versionNumber){try{var formData=new URLSearchParams,response=(formData.append("action","restore_version"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("phase",phase),formData.append("version_number",String(versionNumber)),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return!0===(await response.json()).success;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to restore version:",e),!1}}async checkAIHealth(){if(!this.apiEndpoint||null===this.apiEndpoint||""===this.apiEndpoint||"null"===this.apiEndpoint)return{available:!1,message:"AI endpoint not configured. Please contact your site administrator."};var cleanEndpoint=this.apiEndpoint;try{var response=await fetch(cleanEndpoint+"/health",{method:"GET",timeout:5e3});return{available:response.ok,message:response.ok?"AI endpoint is available":"AI endpoint not responding"}}catch(error){return{available:!1,message:"AI endpoint error: "+error.message}}}async saveInstructorGoal(tab,goalValue){try{var formData=new URLSearchParams,response=(formData.append("action","save_instructor_goal"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("tab",tab),formData.append("goal",goalValue),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(!response.ok)throw new Error(`HTTP ${response.status}: `+response.statusText);var errorMsg,result=await response.json();if(result.success)return!0;throw errorMsg=result.error||"Failed to save instructor goal",console.error("ProjectAPI.saveInstructorGoal(): Server error:",errorMsg),new Error(errorMsg)}catch(error){throw console.error("ProjectAPI.saveInstructorGoal():",error),error}}async submitProject(){try{var formData=new URLSearchParams,response=(formData.append("action","submit_project"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return!0===(await response.json()).success;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(error){return console.error("Failed to submit project:",error),!1}}}window.versionInfo&&console.log("DOM.js module loaded");let Size=Quill.import("attributors/style/size"),quillConfig=(Size.whitelist=["8pt","10pt","12pt","14pt","16pt","18pt","24pt","36pt"],Quill.register(Size,!0),{theme:"snow",modules:{toolbar:[["bold","italic","underline","strike"],["blockquote","code-block"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{size:["8pt","10pt","12pt","14pt","16pt","18pt","24pt","36pt"]}],[{header:[1,2,3,4,5,6,!1]}],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],["clean"]]}});class DOMManager{constructor(){this.elements={},this.eventListeners=new Map}getElement(id,selector=null){return this.elements[id]||((selector=selector?document.querySelector(selector):document.getElementById(id))&&(this.elements[id]=selector),selector)}clearCache(){this.elements={}}addEventListener(element,event,handler,options={}){var key,handlers;element&&(key=`${element.id||"unknown"}_`+event,(handlers=this.eventListeners.get(key)||[]).includes(handler)||(handlers.push(handler),this.eventListeners.set(key,handlers),element.addEventListener(event,handler,options)))}removeEventListeners(element,event=null){var key=event?`${element.id||"unknown"}_`+event:element.id||"unknown",handlers=this.eventListeners.get(key);handlers&&(handlers.forEach(handler=>element.removeEventListener(event,handler)),this.eventListeners.delete(key))}cleanup(){this.eventListeners.forEach((handlers,key)=>{let[elementId,event]=key.split("_"),element=this.getElement(elementId);handlers.forEach(handler=>element?.removeEventListener(event,handler))}),this.eventListeners.clear()}}class BubbleComponent{constructor(content=" ",id=null,aiGenerated=!1){this.id=id||generateId(),this.content=content,this.aiGenerated=aiGenerated,this.element=this.createBubble()}createBubble(){let bubble=createElement("div","idea-bubble"),contentDiv=(bubble.dataset.id=this.id,this.aiGenerated&&(bubble.classList.add("ai-generated"),bubble.dataset.aiGenerated="true"),createElement("div","bubble-content",this.content));var deleteBtn=createElement("button","delete-bubble-btn","×");return deleteBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.delete()}),bubble.appendChild(contentDiv),bubble.appendChild(deleteBtn),this.aiGenerated?(deleteBtn=createElement("span","ai-label","AI"),contentDiv.appendChild(deleteBtn)):(contentDiv.contentEditable=!0,contentDiv.addEventListener("input",()=>{this.content=contentDiv.textContent,bubble.dispatchEvent(new CustomEvent("bubbleContentChanged",{detail:{bubbleId:this.id,content:this.content},bubbles:!0,composed:!0}))})),bubble}setContent(content){this.content=content;var contentDiv=this.element.querySelector(".bubble-content");contentDiv&&(contentDiv.textContent=content)}getContent(){var contentDiv=this.element.querySelector(".bubble-content");return contentDiv?contentDiv.textContent:this.content}setLocation(location,sectionId=null){this.location=location,this.sectionId=sectionId,this.element.dataset.location=location,sectionId&&(this.element.dataset.sectionId=sectionId)}delete(){this.element.dispatchEvent(new CustomEvent("bubbleDeleted",{detail:{bubbleId:this.id},bubbles:!0,composed:!0}))}destroy(){this.element.parentNode&&this.element.parentNode.removeChild(this.element)}}class SectionComponent{constructor(sectionData){this.id=sectionData.id,this.title=sectionData.title,this.description=sectionData.description,this.required=sectionData.required||!1,this.isCustom=sectionData.isCustom||!1,this.element=this.createSection()}createSection(){var sectionDiv=createElement("div","template-section"),sectionHeader=(sectionDiv.dataset.sectionId=this.id,createElement("div","section-header"));let sectionTitle=createElement("h4","section-title",this.title);sectionTitle.contentEditable=!0,sectionTitle.dataset.sectionId=this.id,sectionTitle.setAttribute("spellcheck","false");sectionTitle.addEventListener("input",()=>{}),sectionTitle.addEventListener("blur",()=>{var event,newTitle=sectionTitle.textContent.trim();newTitle&&newTitle!==this.title?(this.title=newTitle,event=new CustomEvent("sectionTitleChanged",{detail:{sectionId:this.id,newTitle:newTitle},bubbles:!0}),sectionTitle.dispatchEvent(event)):newTitle||(sectionTitle.textContent=this.title)}),sectionHeader.appendChild(sectionTitle);var deleteBtn=createElement("button","section-delete-btn"),sectionHeader=(deleteBtn.innerHTML='<svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3L3 9M3 3l6 6"/></svg>',deleteBtn.title=this.isCustom?"Delete this section":"Remove this section from outline",deleteBtn.setAttribute("aria-label","Delete section"),deleteBtn.dataset.sectionId=this.id,deleteBtn.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault();e=new CustomEvent("sectionDeleted",{detail:{sectionId:this.id,isCustom:this.isCustom},bubbles:!0,composed:!0});this.element.dispatchEvent(e)}),sectionHeader.appendChild(deleteBtn),sectionDiv.appendChild(sectionHeader),this.description&&(deleteBtn=createElement("p","section-description",this.description),sectionDiv.appendChild(deleteBtn)),createElement("div","outline-container outline-dropzone")),deleteBtn=(sectionHeader.dataset.sectionId=this.id,sectionHeader.classList.add("empty"),createElement("div","dropzone-placeholder","Drop ideas here to create outline items"));return deleteBtn.draggable=!1,sectionHeader.appendChild(deleteBtn),sectionDiv.appendChild(sectionHeader),sectionDiv}addBubble(bubble){var outlineContainer=this.element.querySelector(".outline-container");outlineContainer&&(outlineContainer.classList.contains("empty")&&(outlineContainer.classList.remove("empty"),outlineContainer.innerHTML=""),outlineContainer.appendChild(bubble.element))}removeBubble(bubbleId){var placeholder,bubbleId=this.element.querySelector(`[data-id="${bubbleId}"]`);bubbleId&&(bubbleId.remove(),bubbleId=this.element.querySelector(".outline-container"))&&0===bubbleId.children.length&&(bubbleId.classList.add("empty"),(placeholder=createElement("div","dropzone-placeholder","Drop ideas here to create outline items")).draggable=!1,bubbleId.appendChild(placeholder))}getBubbles(){var outlineContainer=this.element.querySelector(".outline-container");return outlineContainer?Array.from(outlineContainer.querySelectorAll(".idea-bubble")).map(bubble=>({id:bubble.dataset.id,content:bubble.querySelector(".bubble-content").textContent,aiGenerated:"true"===bubble.dataset.aiGenerated})):[]}setTitle(title){this.title=title;var titleElement=this.element.querySelector(".section-title");titleElement&&(titleElement.textContent=title)}destroy(){this.element.parentNode&&this.element.parentNode.removeChild(this.element)}}class TabManager{constructor(globalState,projectManager){console.log(">>> TabManager constructor called - CACHE REFRESH TEST"),this.globalState=globalState,this.projectManager=projectManager,this.currentTab="plan",this.init(),console.log(">>> TabManager initialized - CACHE REFRESH TEST")}init(){this.ensureGoalIsReadOnly(),this.setupTabs()}ensureGoalIsReadOnly(){var div,currentTab,goalElement=document.getElementById("assignmentGoal");goalElement&&"DIV"!==goalElement.tagName&&((div=document.createElement("div")).id="assignmentGoal",div.className="goal-field goal-field-readonly",currentTab=this.currentTab||"plan",(currentTab=(window.instructorGoals||{})[currentTab]||goalElement.value||"")?div.textContent=currentTab:div.innerHTML="<em>No goal set for this phase.</em>",currentTab=goalElement.parentNode)&&(currentTab.replaceChild(div,goalElement),console.log("TabManager: Replaced textarea with read-only div for goal element"))}setupTabs(){console.log("=== Setting up tabs ===");var tabButtons=document.querySelectorAll(".tab-btn"),tabButtons=(console.log("Found",tabButtons.length,"tab buttons"),tabButtons.forEach(button=>{let tabId=button.getAttribute("data-tab");console.log("Setting up tab:",tabId,"Button:",button),button.addEventListener("click",e=>{e.preventDefault(),console.log("Tab clicked:",tabId),this.switchTab(tabId)})}),localStorage.getItem("researchflow_activeTab")),tabButtons=tabButtons||"plan";console.log("Restoring tab from localStorage:",tabButtons),this.switchTab(tabButtons),console.log("=== Tab setup complete ===")}switchTab(tabId){console.log("=== Switching to tab:",tabId,"===");var allTabButtons=document.querySelectorAll(".tab-btn"),allTabButtons=(console.log("Found",allTabButtons.length,"tab buttons"),allTabButtons.forEach(btn=>{console.log("Removing active from:",btn.dataset.tab,"Classes:",btn.classList.toString()),btn.classList.remove("active")}),document.querySelector(`[data-tab="${tabId}"]`));allTabButtons?(allTabButtons.classList.add("active"),console.log("Added active to:",tabId,"Classes:",allTabButtons.classList.toString())):console.error("Could not find button for tab:",tabId);document.querySelectorAll(".tab-content").forEach(content=>{content.classList.remove("active")});allTabButtons=document.getElementById(tabId);allTabButtons&&allTabButtons.classList.add("active"),document.body.className=document.body.className.replace(/activity-\w+/g,""),document.body.classList.add("activity-"+tabId),console.log("Updated body class to:",document.body.className),"write"===tabId&&(this.populateWriteOutline(),setTimeout(()=>{var writeModule,range;window.aiWritingAssistant&&window.aiWritingAssistant.modules&&window.aiWritingAssistant.modules.write&&(writeModule=window.aiWritingAssistant.modules.write).editor&&(range=writeModule.editor.getSelection(),writeModule.updateAIToolButtons(range))},100)),"edit"===tabId&&setTimeout(()=>{if(window.aiWritingAssistant&&window.aiWritingAssistant.modules&&window.aiWritingAssistant.modules.edit){let editModule=window.aiWritingAssistant.modules.edit;var importBtn=document.getElementById("importWriteContentBtn");importBtn&&!importBtn.hasAttribute("data-listener-attached")&&(importBtn.addEventListener("click",()=>editModule.importWriteContent()),importBtn.setAttribute("data-listener-attached","true"))}},100),this.updateGoalForTab(tabId),localStorage.setItem("researchflow_activeTab",tabId),this.currentTab=tabId,console.log("=== Tab switch complete ===")}updateGoalForTab(tabId){var instructorGoals=window.instructorGoals||{},goalElement=(console.log("TabManager.updateGoalForTab():",{tabId:tabId,instructorGoals:instructorGoals,hasGoals:!!instructorGoals[tabId]}),document.getElementById("assignmentGoal"));goalElement?(instructorGoals=instructorGoals[tabId]||"","DIV"===goalElement.tagName?instructorGoals?goalElement.textContent=instructorGoals:goalElement.innerHTML="<em>No goal set for this phase.</em>":((tabId=document.createElement("div")).id="assignmentGoal",tabId.className="goal-field goal-field-readonly",instructorGoals?tabId.textContent=instructorGoals:tabId.innerHTML="<em>No goal set for this phase.</em>",(instructorGoals=goalElement.parentNode)&&instructorGoals.replaceChild(tabId,goalElement))):console.warn("TabManager.updateGoalForTab(): Goal element not found")}restoreGoalFromState(){}populateWriteOutline(){let outlineSidebar=document.getElementById("outlineSidebar");if(outlineSidebar){let state;if(this.projectManager?(state=this.projectManager.collectAllData(),console.log("DEBUG: populateWriteOutline - fetched fresh state from ProjectManager")):(state=this.globalState.getState(),console.log("DEBUG: populateWriteOutline - fetched state from GlobalState")),console.log("DEBUG: populateWriteOutline - state:",state),console.log("DEBUG: populateWriteOutline - plan.ideas:",state?.plan?.ideas),state&&state.plan&&state.plan.ideas){let ideasArray;if(Array.isArray(state.plan.ideas))ideasArray=state.plan.ideas;else{if("object"!=typeof state.plan.ideas||null===state.plan.ideas)return void console.warn("Invalid ideas format:",typeof state.plan.ideas);ideasArray=Object.values(state.plan.ideas),console.log("DEBUG: Converted ideas object to array:",ideasArray)}outlineSidebar.innerHTML="<h3>My Outline</h3>";let sections=this.getOutlineSections(state);sections&&0<sections.length&&((insertTemplateBtn=document.createElement("button")).className="insert-template-btn",insertTemplateBtn.textContent="Insert Outline Template",insertTemplateBtn.title="Insert outline section headings into the editor",insertTemplateBtn.addEventListener("click",()=>{window.aiWritingAssistant&&window.aiWritingAssistant.modules&&window.aiWritingAssistant.modules.write&&window.aiWritingAssistant.modules.write.insertOutlineTemplate()}),outlineSidebar.appendChild(insertTemplateBtn));var noOutline,insertTemplateBtn=ideasArray.filter(bubble=>"outline"===bubble.location&&bubble.sectionId);if(console.log("DEBUG: outlineBubbles found:",insertTemplateBtn.length,insertTemplateBtn),0===insertTemplateBtn.length)(noOutline=document.createElement("p")).textContent="No outline items yet. Go back to Plan & Organize to add ideas to your outline.",noOutline.style.color="var(--text-secondary)",noOutline.style.fontStyle="italic",noOutline.style.padding="var(--spacing-md)",outlineSidebar.appendChild(noOutline);else{let sectionsMap=new Map;(sections=sections&&0!==sections.length?sections:this.getOutlineSections(state)).forEach(section=>{sectionsMap.set(section.id,{title:section.title,bubbles:[]})}),insertTemplateBtn.forEach(bubble=>{bubble.sectionId&&sectionsMap.has(bubble.sectionId)&&sectionsMap.get(bubble.sectionId).bubbles.push(bubble)}),sectionsMap.forEach((sectionData,sectionId)=>{if(0<sectionData.bubbles.length){var sectionDiv=document.createElement("div"),sectionTitle=document.createElement("h4");sectionTitle.textContent=sectionData.title,sectionDiv.appendChild(sectionTitle);let bubbleList=document.createElement("ul");sectionData.bubbles.forEach(bubble=>{var bubbleItem=document.createElement("li"),bubble=bubble.content.trim();bubbleItem.textContent=80<bubble.length?bubble.substring(0,80)+"...":bubble,bubbleItem.title=bubble,bubbleList.appendChild(bubbleItem)}),sectionDiv.appendChild(bubbleList),outlineSidebar.appendChild(sectionDiv)}})}}else console.warn("No plan data available")}else console.warn("Outline sidebar not found")}getOutlineSections(state){if(window.aiWritingAssistant&&window.aiWritingAssistant.modules.plan){var planModule=window.aiWritingAssistant.modules.plan;if(planModule.sections){let sections=[];return planModule.sections.forEach((section,id)=>{sections.push({id:section.id,title:section.title,description:section.description})}),sections}}return window.templateData&&window.templateData.sections?window.templateData.sections:[{id:"introduction",title:"Introduction"},{id:"main-arguments",title:"Main Arguments"},{id:"conclusion",title:"Conclusion"}]}getCurrentTab(){return this.currentTab}}class ChatManager{constructor(globalState){this.globalState=globalState,this.messages=[],this.elements={chatMessages:document.getElementById("chatMessages"),userInput:document.getElementById("userInput"),sendButton:document.getElementById("sendMessage"),regenerateGlobalBtn:document.getElementById("regenerateGlobalBtn")},this.elements.chatMessages&&this.elements.userInput&&this.elements.sendButton||console.warn("ChatManager: Some required elements not found"),this.init()}init(){this.setupEventListeners(),this.subscribeToGlobalState()}subscribeToGlobalState(){this.globalState&&this.globalState.subscribe("stateChanged",state=>{this.syncWithGlobalState(state)})}syncWithGlobalState(state){if(state.chatHistory&&Array.isArray(state.chatHistory)&&state.chatHistory.length>this.messages.length){console.log("ChatManager: Adding new messages, current:",this.messages.length,"total:",state.chatHistory.length);for(let i=this.messages.length;i<state.chatHistory.length;i++){var msg=state.chatHistory[i];this.messages.push(msg),this.renderMessage(msg)}}}setupEventListeners(){this.removeEventListeners(),this.elements.sendButton&&(this.sendButtonHandler=()=>this.sendMessage(),this.elements.sendButton.addEventListener("click",this.sendButtonHandler)),this.elements.userInput&&(this.userInputHandler=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())},this.elements.userInput.addEventListener("keypress",this.userInputHandler)),this.elements.regenerateGlobalBtn&&(this.regenerateButtonHandler=()=>this.regenerateLastMessage(),this.elements.regenerateGlobalBtn.addEventListener("click",this.regenerateButtonHandler))}removeEventListeners(){this.elements.sendButton&&this.sendButtonHandler&&this.elements.sendButton.removeEventListener("click",this.sendButtonHandler),this.elements.userInput&&this.userInputHandler&&this.elements.userInput.removeEventListener("keypress",this.userInputHandler),this.elements.regenerateGlobalBtn&&this.regenerateButtonHandler&&this.elements.regenerateGlobalBtn.removeEventListener("click",this.regenerateButtonHandler)}addMessage(role,content,timestamp=0){console.warn("ChatManager.addMessage() is deprecated. Messages are now handled by global state sync.")}renderMessage(message){if(this.elements.chatMessages){var messageDiv=createElement("div","message "+message.role),messageContent=createElement("div","message-content");if("undefined"!=typeof marked&&"undefined"!=typeof DOMPurify)try{marked.setOptions({breaks:!0,gfm:!0});var rawHtml=marked.parse(message.content),cleanHtml=DOMPurify.sanitize(rawHtml);messageContent.innerHTML=cleanHtml,messageContent.classList.add("markdown-rendered")}catch(e){console.error("ChatManager: Error parsing markdown:",e),messageContent.textContent=message.content}else messageContent.textContent=message.content;messageDiv.appendChild(messageContent),this.elements.chatMessages.appendChild(messageDiv),this.elements.chatMessages.scrollTop=this.elements.chatMessages.scrollHeight}else console.error("ChatManager: chatMessages element not found, cannot render message")}sendMessage(){var message;this.elements.userInput&&(message=this.elements.userInput.value.trim())&&(console.log("ChatManager: Sending message:",message),this.elements.userInput.value="",document.dispatchEvent(new CustomEvent("messageSent",{detail:{message:message,role:"user"}})))}regenerateLastMessage(){var last,prev;this.messages.length<2||(last=this.messages[this.messages.length-1],prev=this.messages[this.messages.length-2],"assistant"===last.role&&"user"===prev.role&&(this.messages.pop(),this.elements.chatMessages.lastChild&&this.elements.chatMessages.removeChild(this.elements.chatMessages.lastChild),document.dispatchEvent(new CustomEvent("regenerateRequested",{detail:{message:prev.content}}))))}updateRegenerateButton(){var last;this.elements.regenerateGlobalBtn&&(last=this.messages[this.messages.length-1],this.elements.regenerateGlobalBtn.disabled=!(last&&"assistant"===last.role))}loadMessages(messages){this.elements.chatMessages||(console.warn("ChatManager: Reinitializing elements as chatMessages was not found"),this.elements.chatMessages=document.getElementById("chatMessages")),this.messages=[],this.elements.chatMessages?(this.elements.chatMessages.innerHTML="",this.updateRegenerateButton(),messages&&Array.isArray(messages)?messages.forEach((msg,index)=>{this.addMessage(msg.role,msg.content,msg.timestamp)}):console.warn("ChatManager: Invalid messages array")):console.error("ChatManager: chatMessages element still not found after reinit, cannot clear messages")}getMessages(){return[...this.messages]}collectData(){return{chatHistory:this.getMessages()}}}let TS={toISO(ts){if(null!=ts&&""!==ts){var d;if("number"==typeof ts)return Number.isNaN(ts)||(d=new Date(ts<1e10?1e3*ts:ts),isNaN(d.getTime()))?null:d.toISOString();if("string"==typeof ts&&ts){if(ts.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/)){let d=new Date(ts.replace(" ","T"));return isNaN(d.getTime())?null:d.toISOString()}var parsed=parseInt(ts,10);if(!Number.isNaN(parsed)&&/^\d+$/.test(String(ts).trim()))return TS.toISO(parsed);let d=new Date(ts);return isNaN(d.getTime())?null:d.toISOString()}}return null},formatForDisplay(ts){var ts="string"==typeof ts&&ts.includes("T")?ts:TS.toISO(ts);return!ts||(ts=new Date(ts),isNaN(ts.getTime()))?"":ts.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}};class ChatTabManager{constructor(chatSystem){this.chatSystem=chatSystem,this.chats=new Map,this.currentChatId="chat-1",this.chatCounter=1,this.elements={chatTabs:document.querySelector(".chat-tabs"),chatContent:document.querySelector(".chat-content"),clearChatBtn:document.getElementById("clearChatBtn")},this.init()}init(){this.currentChatId="chat-1",this.setupEventListeners(),setTimeout(()=>{this.switchToChat("chat-1")},100)}setupEventListeners(){this.elements.chatTabs&&this.elements.chatTabs.addEventListener("click",e=>{if(e.target.classList.contains("chat-tab")){var chatId=e.target.dataset.chatId;this.switchToChat(chatId)}else if(e.target.classList.contains("chat-tab-close")){let chatId=e.target.dataset.chatId;this.deleteChat(chatId)}}),this.elements.clearChatBtn&&this.elements.clearChatBtn.addEventListener("click",()=>this.clearCurrentChat())}createNewChat(){this.chatCounter++;var chatId="chat-"+this.chatCounter,chatTitle="Chat "+this.chatCounter;this.createChat(chatId,chatTitle),this.switchToChat(chatId)}createChat(chatId,title){if("chat-1"===chatId){let chatInstance={id:chatId,title:title,messages:new Map,tab:null,messagesContainer:document.getElementById("chatMessages")};return this.chats.set(chatId,chatInstance),chatInstance}var chatTab=document.createElement("div"),chatMessages=(chatTab.className="chat-tab",chatTab.dataset.chatId=chatId,chatTab.innerHTML=`
            <span class="chat-tab-title">${title}</span>
            <button class="chat-tab-close" data-chat-id="${chatId}" title="Close chat" aria-label="Close chat">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor">
                    <path d="M9 3L3 9M3 3l6 6" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </button>
        `,this.elements.chatTabs.insertBefore(chatTab,this.elements.newChatBtn),document.createElement("div"));chatMessages.className="chat-messages",chatMessages.id="chatMessages-"+chatId,chatMessages.dataset.chatId=chatId,this.elements.chatContent.insertBefore(chatMessages,this.elements.chatContent.querySelector(".chat-actions-row"));let chatInstance={id:chatId,title:title,messages:new Map,tab:chatTab,messagesContainer:chatMessages};return this.chats.set(chatId,chatInstance),chatInstance}switchToChat(chatId){if(!this.chats.has(chatId)){if("chat-1"!==chatId)return;this.createChat(chatId,"New Chat")}this.elements.chatTabs&&(document.querySelectorAll(".chat-tab").forEach(tab=>{tab.classList.remove("active")}),activeTab=document.querySelector(`[data-chat-id="${chatId}"]`))&&activeTab.classList.add("active"),document.querySelectorAll(".chat-messages").forEach(container=>{container.classList.remove("active")});var activeTab="chat-1"===chatId?document.getElementById("chatMessages"):document.getElementById("chatMessages-"+chatId);activeTab&&activeTab.classList.add("active"),this.currentChatId=chatId,this.chatSystem&&(this.chatSystem.currentChatId=chatId,this.chatSystem.messages=this.chats.get(chatId).messages,this.chatSystem.elements)&&(this.chatSystem.elements.chatMessages=activeTab),console.log("Switched to chat: "+chatId)}deleteChat(chatId){var chat;this.chats.has(chatId)&&(this.chats.size<=1?console.log("Cannot delete the last chat"):((chat=this.chats.get(chatId)).tab&&chat.tab.remove(),chat.messagesContainer.remove(),this.chats.delete(chatId),this.currentChatId===chatId&&0<(chat=Array.from(this.chats.keys())).length&&this.switchToChat(chat[0]),console.log("Deleted chat: "+chatId)))}clearCurrentChat(){var currentChat=this.chats.get(this.currentChatId);currentChat&&(currentChat.messages.clear(),currentChat.messagesContainer.innerHTML="",this.chatSystem.messages=currentChat.messages,console.log("Cleared chat: "+this.currentChatId))}updateChatTitle(chatId,newTitle){var chatId=this.chats.get(chatId);chatId&&(chatId.title=newTitle,chatId.tab)&&(chatId=chatId.tab.querySelector(".chat-tab-title"))&&(chatId.textContent=newTitle)}}class CompleteChatSystem{constructor(globalState,api,projectManager){this.globalState=globalState,this.api=api,this.projectManager=projectManager,this.currentChatId="chat-1",this.messages=new Map,this.isInitialized=!1,this.isProcessing=!1,this.eventHandlers=new Map,this.messageQueue=[],this.retryCount=0,this.maxRetries=3,this.chatHistoryLoaded=!1,this.isLoadingHistory=!1,this.allChatMessages=[],this.renderedMessageCount=0,this.isLoadingFromDatabase=!1,this.pageSize=50,this.isFetchingOlder=!1,this.hasMore=!0,this.oldestTimestampLoaded=null,this.messageKeys=new Set,this.makeMessageKey=m=>{var ts=TS.toISO(m.timestamp)||"epoch";return m.role+`|${ts}|`+m.content},setTimeout(()=>{this.tabManager=new ChatTabManager(this)},200),this.elements={chatMessages:document.getElementById("chatMessages"),userInput:document.getElementById("userInput"),sendButton:document.getElementById("sendMessage"),clearChatButton:document.getElementById("clearChatBtn"),typingIndicator:null},this.createTypingIndicator(),setTimeout(()=>{this.init()},100)}init(){this.isInitialized?console.warn("CompleteChatSystem: Already initialized"):this.elements.chatMessages?(this.setupEventListeners(),this.setupAutoSave(),this.loadChatHistory(),this.isInitialized=!0):console.error("CompleteChatSystem: chatMessages element not found!")}destroy(){console.log("CompleteChatSystem: Destroying..."),this.removeAllEventListeners(),this.messages.clear(),this.messageQueue=[],this.isInitialized=!1}async sendMessage(content){if(content&&content.trim())if(this.isProcessing)this.messageQueue.push(content);else{this.isProcessing=!0,this.disableInput(!0);try{var userMessage=this.createMessage("user",content.trim()),aiResponse=(await this.addMessage(userMessage),this.showTypingIndicator(),await this.getAIResponse(content)),assistantMessage=(this.hideTypingIndicator(),this.createMessage("assistant",aiResponse));await this.addMessage(assistantMessage),this.processMessageQueue()}catch(error){console.error("CompleteChatSystem: Error sending message:",error),this.hideTypingIndicator(),await this.addMessage(this.createMessage("assistant","Sorry, I encountered an error. Please try again."))}finally{this.isProcessing=!1,this.disableInput(!1)}}}async getAIResponse(userMessage){try{var currentProject=this.globalState.getState(),response=await this.api.sendChatMessage(userMessage,currentProject);if(response&&response.assistantReply)return response.assistantReply;throw new Error("No response from AI")}catch(error){throw console.error("CompleteChatSystem: AI response error:",error),error}}processMessageQueue(){if(0<this.messageQueue.length&&!this.isProcessing){let nextMessage=this.messageQueue.shift();setTimeout(()=>this.sendMessage(nextMessage),100)}}createMessage(role,content,metadata={}){var timestamp=(new Date).toISOString();return{id:`${role}_${Date.now()}_`+Math.random().toString(36).substr(2,9),role:role,content:content,timestamp:timestamp,metadata:{...metadata,retryCount:0,status:"sent"}}}async addMessage(message){var key;return console.log("CHAT DEBUG: addMessage called with:",message),this.validateMessage(message)?this.isDuplicate(message)?(console.log("CHAT DEBUG: Duplicate message detected, skipping"),!1):(key=this.makeMessageKey(message),!this.messageKeys.has(key)&&(this.messageKeys.add(key),this.messages.set(message.id,message),this.renderMessage(message),await this.updateGlobalState(),"loaded"!==message.metadata?.status&&await this.saveToDatabase(message),!0)):(console.warn("CompleteChatSystem: Invalid message:",message),!1)}validateMessage(message){return message&&message.id&&message.role&&message.content&&message.timestamp&&["user","assistant"].includes(message.role)}isDuplicate(message){if(this.messages.has(message.id))return!0;let normalizeTimestamp=ts=>{var parsed;return ts?"string"==typeof ts?(parsed=Date.parse(ts),isNaN(parsed)?Date.now():parsed):"number"==typeof ts?ts<1e10?1e3*ts:ts:Date.now():Date.now()};normalizeTimestamp(message.timestamp);let now=Date.now();return Array.from(this.messages.values()).filter(msg=>msg.role===message.role&&(msg=normalizeTimestamp(msg.timestamp),now-msg<5e3)).some(msg=>msg.content===message.content)}renderMessage(message,prepend=!1){var stateEl,typingEl;this.elements.chatMessages?((stateEl=this.elements.chatMessages.querySelector(".chat-state"))&&stateEl.remove(),this.elements.chatMessages.querySelector(`[data-message-id="${message.id}"]`)||(stateEl=this.createMessageElement(message),message=this.elements.chatMessages,typingEl=this.elements.typingIndicator,prepend?message.insertBefore(stateEl,message.firstChild):(typingEl&&message.contains(typingEl)?message.insertBefore(stateEl,typingEl):message.appendChild(stateEl),this.scrollToBottom()))):console.error("CompleteChatSystem: Chat messages container not found")}createMessageElement(message){var messageDiv=createElement("div","message "+message.role),contentDiv=(messageDiv.setAttribute("data-message-id",message.id),createElement("div","message-content"));if("undefined"!=typeof marked&&"undefined"!=typeof DOMPurify)try{marked.setOptions({breaks:!0,gfm:!0});var rawHtml=marked.parse(message.content),cleanHtml=DOMPurify.sanitize(rawHtml);contentDiv.innerHTML=cleanHtml,contentDiv.classList.add("markdown-rendered")}catch(e){console.error("CompleteChatSystem: Error parsing markdown:",e),contentDiv.textContent=message.content}else contentDiv.textContent=message.content;rawHtml=createElement("div","message-time",TS.formatForDisplay(message.timestamp));return messageDiv.appendChild(contentDiv),messageDiv.appendChild(rawHtml),"assistant"===message.role&&(cleanHtml=createElement("div","message-actions"),(contentDiv=createElement("button","regenerate-btn","↻")).title="Regenerate this response",contentDiv.addEventListener("click",()=>this.regenerateMessage(message)),cleanHtml.appendChild(contentDiv),messageDiv.appendChild(cleanHtml)),messageDiv}createTypingIndicator(){this.elements.chatMessages&&(this.elements.typingIndicator=createElement("div","typing-indicator"),this.elements.typingIndicator.innerHTML=`
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text">AI is thinking...</span>
        `,this.elements.typingIndicator.style.display="none",this.elements.chatMessages.appendChild(this.elements.typingIndicator))}showTypingIndicator(){this.elements.typingIndicator&&(this.ensureTypingIndicatorAtBottom(),this.elements.typingIndicator.style.display="flex",this.scrollToBottom())}hideTypingIndicator(){this.elements.typingIndicator&&(this.elements.typingIndicator.style.display="none")}ensureTypingIndicatorAtBottom(){var container=this.elements.chatMessages,typing=this.elements.typingIndicator;typing&&container&&(container.contains(typing),container.appendChild(typing))}scrollToBottom(){this.elements.chatMessages&&(this.elements.chatMessages.scrollTop=this.elements.chatMessages.scrollHeight)}formatTime(timestamp){return TS.formatForDisplay(timestamp)}setupEventListeners(){this.elements.sendButton&&(this.sendHandler=e=>{e.preventDefault();e=this.elements.userInput.value.trim();e&&(this.elements.userInput.value="",this.elements.userInput.style.height="auto",this.sendMessage(e))},this.elements.sendButton.addEventListener("click",this.sendHandler),this.eventHandlers.set("sendButton",{element:this.elements.sendButton,handler:this.sendHandler,event:"click"})),this.elements.userInput&&(this.autoResizeHandler=()=>{var textarea=this.elements.userInput,newHeight=(textarea.style.height="auto",Math.min(textarea.scrollHeight,120));textarea.style.height=newHeight+"px"},this.elements.userInput.addEventListener("input",this.autoResizeHandler),this.keypressHandler=e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),e=this.elements.userInput.value.trim())&&(this.elements.userInput.value="",this.elements.userInput.style.height="auto",this.sendMessage(e))},this.elements.userInput.addEventListener("keypress",this.keypressHandler),this.eventHandlers.set("userInput",{element:this.elements.userInput,handler:this.keypressHandler,event:"keypress"}),this.eventHandlers.set("userInputResize",{element:this.elements.userInput,handler:this.autoResizeHandler,event:"input"})),this.elements.clearChatButton&&(this.clearChatHandler=e=>{e.preventDefault(),this.clearChat()},this.elements.clearChatButton.addEventListener("click",this.clearChatHandler),this.eventHandlers.set("clearChatButton",{element:this.elements.clearChatButton,handler:this.clearChatHandler,event:"click"}))}removeAllEventListeners(){this.eventHandlers.forEach(({element,handler,event})=>{element.removeEventListener(event,handler)}),this.eventHandlers.clear()}disableInput(disabled){this.elements.userInput&&(this.elements.userInput.disabled=disabled),this.elements.sendButton&&(this.elements.sendButton.disabled=disabled)}subscribeToGlobalState(){this.globalState&&(this.stateChangeHandler&&this.globalState.unsubscribe("stateChanged",this.stateChangeHandler),this.stateChangeHandler=state=>this.handleStateChange(state),this.globalState.subscribe("stateChanged",this.stateChangeHandler))}handleStateChange(state){this.chatHistoryLoaded||this.isLoadingFromDatabase||state.chatHistory&&Array.isArray(state.chatHistory)&&this.syncWithGlobalState(state.chatHistory)}syncWithGlobalState(chatHistory){if(!this.chatHistoryLoaded){var currentCount=this.messages.size,newCount=chatHistory.length;if(currentCount<newCount)for(let i=currentCount;i<newCount;i++){var ts,message=chatHistory[i];this.messages.has(message.id)||("string"==typeof(ts=message.timestamp)&&ts||"number"==typeof ts&&0<ts?(this.messages.set(message.id,message),this.renderMessage(message)):console.warn("CompleteChatSystem: Skipping message with invalid timestamp from state sync"))}}}async updateGlobalState(){var currentState;this.isLoadingFromDatabase||((currentState=this.globalState.getState()).chatHistory=Array.from(this.messages.values()).map(msg=>{var ts=TS.toISO(msg.timestamp);return{role:msg.role,content:msg.content,timestamp:ts||""}}),this.globalState.setState(currentState))}async saveToDatabase(message){try{var ts,sessionId;return message&&message.role&&message.content?(ts=TS.toISO(message.timestamp)||(new Date).toISOString(),sessionId=this.currentChatId||"default",!!await this.api.appendChatMessage(sessionId,message.role,message.content,ts)||(console.error("CompleteChatSystem: appendChatMessage reported failure"),!1)):(console.warn("CompleteChatSystem: saveToDatabase called with invalid message:",message),!1)}catch(error){return console.error("CompleteChatSystem: Failed to append chat message:",error),console.error("CompleteChatSystem: Error stack:",error.stack),!1}}async loadChatHistory(forceReload=!1){if(forceReload||!this.isLoadingHistory&&!this.chatHistoryLoaded){forceReload&&(this.chatHistoryLoaded=!1,this.allChatMessages=[],this.renderedMessageCount=0,this.messageKeys.clear(),this.messages.clear(),this.elements.chatMessages)&&(this.elements.chatMessages.innerHTML=""),this.isLoadingHistory=!0,this.isLoadingFromDatabase=!0;try{var loadingDiv;this.elements.chatMessages&&!this.elements.chatMessages.querySelector(".chat-loading")&&((loadingDiv=document.createElement("div")).className="chat-loading chat-state",loadingDiv.innerHTML=`
                    <div class="chat-loading-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span>Loading conversation...</span>
                `,this.elements.chatMessages.appendChild(loadingDiv));let container=this.elements.chatMessages;this.api.loadChatHistoryPage(this.pageSize,null,0,this.currentChatId||"chat-1").then(async chatHistoryArray=>{var loadingDiv=container?.querySelector(".chat-loading, .chat-state");loadingDiv&&loadingDiv.remove();let data=Array.isArray(chatHistoryArray)?chatHistoryArray:[];if(0===data.length)try{data=await this.api.loadChatHistoryPage(this.pageSize,null,0,null)}catch(_){}var loadingDiv=Array.isArray(data)?data:[];0<loadingDiv.length?(chatHistoryArray=loadingDiv.map(m=>{let ts=TS.toISO(m.timestamp)||TS.toISO(m.created_at);return ts=ts||null,{id:m.id||`${m.role}_${ts?Date.parse(ts):0}_`+Math.random().toString(36).substr(2,5),role:m.role,content:m.content,timestamp:ts,metadata:{status:"loaded"}}}).filter(m=>m.role&&null!=m.content).sort((a,b)=>{var timeA=Date.parse(a.timestamp||0),timeB=Date.parse(b.timestamp||0);return timeA!==timeB?timeA-timeB:(parseInt(a.id)||0)-(parseInt(b.id)||0)}),this.allChatMessages=chatHistoryArray,this.oldestTimestampLoaded=chatHistoryArray.length?chatHistoryArray[0].timestamp:null,this.hasMore=chatHistoryArray.length>=this.pageSize,this.renderedMessageCount=0,this.messageKeys.clear(),this.messages.clear(),(loadingDiv=this.elements.chatMessages)&&(loadingDiv.innerHTML=""),this.chatHistoryLoaded=!0,requestAnimationFrame(()=>{this.renderNextBatch(this.allChatMessages.length),this.ensureTypingIndicatorAtBottom(),this.updateGlobalState()}),this.setupScrollListener()):(this.chatHistoryLoaded=!0,this.showEmptyState(container)),this.isLoadingHistory=!1,this.isLoadingFromDatabase=!1}).catch(err=>{var loadingDiv=container?.querySelector(".chat-loading, .chat-state");loadingDiv&&loadingDiv.remove(),this.showErrorState(container,err),this.isLoadingHistory=!1,this.isLoadingFromDatabase=!1,this.chatHistoryLoaded=!0})}catch(error){console.error("CompleteChatSystem: Failed to start chat history load:",error),this.isLoadingHistory=!1,this.isLoadingFromDatabase=!1}}}showEmptyState(container){var el;container&&!container.querySelector(".chat-empty, .chat-state")&&((el=document.createElement("div")).className="chat-state chat-empty",el.innerHTML=`
            <div class="chat-empty-icon">💬</div>
            <p class="chat-empty-title">No messages yet</p>
            <p class="chat-empty-subtitle">Start a conversation by typing below</p>
            <div class="chat-suggestions">
                ${["Help me improve this paragraph","Check my grammar","Suggest better word choices"].map(s=>`<span class="chat-suggestion" data-suggestion="${s.replace(/"/g,"&quot;")}">${s}</span>`).join("")}
            </div>
        `,el.querySelectorAll(".chat-suggestion").forEach(btn=>{btn.addEventListener("click",()=>{var text=btn.getAttribute("data-suggestion");text&&this.elements.userInput&&(this.elements.userInput.value=text,this.elements.userInput.focus())})}),container.appendChild(el),this.elements.typingIndicator&&!container.contains(this.elements.typingIndicator))&&container.appendChild(this.elements.typingIndicator)}showErrorState(container,err){var existing;container&&((existing=container.querySelector(".chat-error, .chat-state"))&&existing.remove(),(existing=document.createElement("div")).className="chat-state chat-error",err=err&&(err.message||err.toString)?err.message||err.toString():"Failed to load chat",err=String(err).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"),existing.innerHTML=`
            <div class="chat-error-icon">⚠️</div>
            <p class="chat-error-title">Could not load chat</p>
            <p class="chat-error-message">${err}</p>
            <button type="button" class="chat-retry-btn">Retry</button>
        `,(err=existing.querySelector(".chat-retry-btn"))&&err.addEventListener("click",()=>this.loadChatHistory(!0)),container.appendChild(existing))}setupScrollListener(){if(this.elements.chatMessages){let messagesContainer=this.elements.chatMessages,isScrolling=!1;messagesContainer.addEventListener("scroll",()=>{isScrolling||(isScrolling=!0,requestAnimationFrame(()=>{messagesContainer.scrollTop<100&&this.fetchOlderMessages(),isScrolling=!1}))})}}renderNextBatch(batchSize=10){var startIndex=this.renderedMessageCount,endIndex=Math.min(startIndex+batchSize,this.allChatMessages.length);if(this.elements.chatMessages){var fragment=document.createDocumentFragment();let renderedCount=0;for(let i=startIndex;i<endIndex;i++){var ts,key,message=this.allChatMessages[i];message&&message.role&&message.content?(ts=TS.toISO(message.timestamp)||message.timestamp,ts={id:message.id||`${message.role}_${ts?Date.parse(ts):0}_`+Math.random().toString(36).substr(2,9),role:message.role,content:message.content,timestamp:ts,metadata:{retryCount:0,status:"loaded"}},key=this.makeMessageKey(ts),this.messageKeys.has(key)||(this.messageKeys.add(key),this.messages.set(ts.id,ts),key=this.createMessageElement(ts),fragment.appendChild(key),renderedCount++)):console.warn("CompleteChatSystem: Skipping invalid message at index",i,message)}0<renderedCount&&(this.elements.chatMessages.appendChild(fragment),this.ensureTypingIndicatorAtBottom(),this.scrollToBottom()),this.renderedMessageCount=endIndex,this.renderedMessageCount>=this.allChatMessages.length&&(this.chatHistoryLoaded=!0)}}async fetchOlderMessages(){if(!this.isFetchingOlder&&this.hasMore){this.isFetchingOlder=!0;try{var older,normalized,before=this.oldestTimestampLoaded;before?(older=await this.api.loadChatHistoryPage(this.pageSize,before,0,this.currentChatId||"chat-1"))&&0!==older.length?(normalized=older.map(m=>{var ts=TS.toISO(m.timestamp)||TS.toISO(m.created_at);return{id:m.id||`${m.role}_${ts?Date.parse(ts):0}_`+Math.random().toString(36).substr(2,5),role:m.role,content:m.content,timestamp:ts,metadata:{status:"loaded"}}}).filter(m=>m.role&&m.content).sort((a,b)=>Date.parse(a.timestamp||0)-Date.parse(b.timestamp||0)),this.allChatMessages=[...normalized,...this.allChatMessages],this.oldestTimestampLoaded=this.allChatMessages[0]?.timestamp||this.oldestTimestampLoaded,normalized.forEach(msg=>{var key;this.messages.has(msg.id)||(key=this.makeMessageKey(msg),this.messageKeys.has(key))||(this.messageKeys.add(key),this.messages.set(msg.id,msg),this.renderMessage(msg,!0))})):this.hasMore=!1:this.hasMore=!1}catch(e){console.error("fetchOlderMessages failed:",e)}finally{this.isFetchingOlder=!1}}}setupAutoSave(){}async regenerateMessage(message){if("assistant"===message.role)try{var userMessage,aiResponse,newAssistantMessage,messagesArray=Array.from(this.messages.values()),messageIndex=messagesArray.findIndex(msg=>msg.id===message.id);0<messageIndex&&"user"===(userMessage=messagesArray[messageIndex-1]).role&&(this.removeMessage(message.id),this.showTypingIndicator(),aiResponse=await this.getAIResponse(userMessage.content),this.hideTypingIndicator(),newAssistantMessage=this.createMessage("assistant",aiResponse),await this.addMessage(newAssistantMessage))}catch(error){console.error("CompleteChatSystem: Error regenerating message:",error),this.hideTypingIndicator()}}async regenerateLastMessage(){var messagesArray=Array.from(this.messages.values());2<=messagesArray.length&&(messagesArray=messagesArray[messagesArray.length-1],await this.regenerateMessage(messagesArray))}clearChat(){this.messages.clear(),this.elements.chatMessages&&(this.elements.chatMessages.innerHTML=""),this.updateGlobalState()}removeMessage(messageId){this.messages.delete(messageId);messageId=this.elements.chatMessages.querySelector(`[data-message-id="${messageId}"]`);messageId&&messageId.remove(),this.updateGlobalState()}getMessages(){return Array.from(this.messages.values())}getMessageCount(){return this.messages.size}clearMessages(){this.messages.clear(),this.elements.chatMessages&&(this.elements.chatMessages.innerHTML=""),this.updateGlobalState()}loadMessages(messages){Array.isArray(messages)?this.isLoadingHistory||this.isLoadingFromDatabase||this.chatHistoryLoaded||(this.messages.clear(),this.elements.chatMessages&&(this.elements.chatMessages.innerHTML=""),messages.forEach(message=>{var ts;message.role&&message.content&&(ts=TS.toISO(message.timestamp),ts={id:message.id||`${message.role}_${Date.now()}_`+Math.random().toString(36).substr(2,9),role:message.role,content:message.content,timestamp:ts||null,metadata:message.metadata||{retryCount:0,status:"loaded"}},this.messages.set(ts.id,ts),this.renderMessage(ts))}),this.updateGlobalState()):console.warn("CompleteChatSystem: loadMessages called with non-array:",messages)}}window.addEventListener("error",event=>{if(event.message&&event.message.includes("addRange(): The given range isn't in document"))return event.preventDefault(),console.warn("Suppressed addRange() error from Quill editor"),!1});class GlobalState{constructor(){this.state=deepClone(DEFAULT_PROJECT_SCHEMA),this.listeners=new Map,this.silentMode=!1}getState(){return deepClone(this.state)}setState(newState,silent=!1){this.state=deepClone(newState),silent||this.silentMode||this.notifyListeners("stateChanged",this.state)}updateState(updates,silent=!1){this.setState({...this.state,...updates},silent)}setSilentMode(enabled){this.silentMode=enabled}subscribe(event,callback){this.listeners.has(event)||this.listeners.set(event,[]),this.listeners.get(event).push(callback)}notifyListeners(event,data){this.silentMode||this.listeners.get(event)?.forEach(callback=>{try{callback(data)}catch(error){console.error(`Event handler error for ${event}:`,error)}})}}class ProjectManager{constructor(globalState,api){this.globalState=globalState,this.api=api,this.isReady=!1,this.isSaving=!1,this.saveQueued=!1,this.lastSaveTime=null,this.modules=new Map,this.autosaveTimer=null,this.autosavePending=!1,this.autosaveDebounceMs=1e3,this.autosaveMinIntervalMs=3e4,this.isOnline=navigator.onLine,window.addEventListener("online",()=>{this.isOnline=!0,!this.autosavePending&&null!==this.autosaveTimer||this.scheduleAutoSave("online-retry")}),window.addEventListener("offline",()=>{this.isOnline=!1,this.globalState.notifyListeners("autosave_offline",{})}),this.init()}async init(){try{console.log("Testing AJAX connection...");var connectionTest=await this.api.testConnection();console.log("AJAX connection test:",connectionTest?"PASSED":"FAILED"),await this.loadProject(),this.isReady=!0,this.globalState.notifyListeners("ready",this.globalState.getState())}catch(error){console.error("ProjectManager: Initialization failed:",error),this.globalState.notifyListeners("error",error)}}async loadProject(){try{var project=await this.api.loadProject();project?(project.metadata||(project.metadata={}),null==project.metadata.goal?project.metadata.goal="":project.metadata.goal=String(project.metadata.goal),this.globalState.setState(project),this.globalState.notifyListeners("ready",project)):this.createNewProject()}catch(error){console.error("Failed to load project:",error),this.createNewProject()}}createNewProject(){var newProject=deepClone(DEFAULT_PROJECT_SCHEMA);return newProject.metadata.created=formatDate(new Date),newProject.metadata.modified=formatDate(new Date),newProject.metadata.currentTab="plan",newProject.metadata.instructorInstructions=window.instructorDescription||"",this.globalState.setState(newProject),newProject}registerModule(name,module){this.modules.set(name,module)}collectAllData(){var currentTab;let collectedData=deepClone(this.globalState.getState());return collectedData.metadata.modified=formatDate(new Date),this.modules.forEach((module,moduleName)=>{try{if("function"==typeof module.collectData){let moduleData=module.collectData();moduleData&&Object.keys(moduleData).forEach(key=>{collectedData[key]?collectedData[key]={...collectedData[key],...moduleData[key]}:collectedData[key]=moduleData[key]})}}catch(error){console.error(`ProjectManager: Error collecting data from ${moduleName}:`,error)}}),window.aiWritingAssistant&&window.aiWritingAssistant.tabManager?(currentTab=window.aiWritingAssistant.tabManager.getCurrentTab(),collectedData.metadata={...collectedData.metadata,currentTab:currentTab,instructorInstructions:window.instructorDescription||""}):collectedData.metadata={...collectedData.metadata},collectedData.chatHistory&&delete collectedData.chatHistory,collectedData}async saveProject(){if(this.isSaving)return this.saveQueued=!0;this.isSaving=!0;try{this.globalState.notifyListeners("autosave_saving",{reason:"direct"});var completeProjectData=this.collectAllData(),result=(this.globalState.setState(completeProjectData,!0),await this.api.saveProject(completeProjectData));if(result&&result.success)return result.ideaMappings&&this.modules.has("plan")&&this.modules.get("plan").updateBubbleIds(result.ideaMappings),this.lastSaveTime=new Date,this.globalState.notifyListeners("saved",completeProjectData),this.globalState.notifyListeners("autosave_saved",{reason:"direct",at:(new Date).toISOString()}),!0;throw new Error("Save failed")}catch(error){return console.error("ProjectManager: Failed to save project:",error),this.globalState.notifyListeners("error",error),!1}finally{this.isSaving=!1,this.saveQueued&&(this.saveQueued=!1,this.saveProject().catch(()=>{}))}}scheduleAutoSave(reason="unspecified",force=!1){var elapsed=Date.now()-(this.lastSaveTime?this.lastSaveTime.getTime():0);if(this.isOnline){this.autosaveTimer&&(clearTimeout(this.autosaveTimer),this.autosaveTimer=null);let delay=this.autosaveDebounceMs;!force&&elapsed<this.autosaveMinIntervalMs&&(force=this.autosaveMinIntervalMs-elapsed,delay=Math.max(this.autosaveDebounceMs,force)),this.autosavePending=!0,this.globalState.notifyListeners("autosave_scheduled",{reason:reason,delay:delay}),this.autosaveTimer=setTimeout(async()=>{try{this.globalState.notifyListeners("autosave_saving",{reason:reason}),await this.saveProject(),this.globalState.notifyListeners("autosave_saved",{reason:reason,at:(new Date).toISOString()})}catch(e){this.globalState.notifyListeners("autosave_error",{reason:reason,error:e})}finally{this.autosavePending=!1,this.autosaveTimer=null}},delay)}else this.autosavePending=!0,this.globalState.notifyListeners("autosave_offline",{reason:reason})}getProject(){return this.globalState.getState()}updateMetadata(metadata){var currentState=this.globalState.getState();currentState.metadata={...currentState.metadata,...metadata,modified:formatDate(new Date)},this.globalState.setState(currentState,!0)}updatePlan(planData){var currentState=this.globalState.getState();currentState.plan={...currentState.plan,...planData},this.globalState.setState(currentState,!0)}updateWrite(writeData){var currentState=this.globalState.getState();currentState.write={...currentState.write,...writeData},this.globalState.setState(currentState,!0)}updateEdit(editData){var currentState=this.globalState.getState();currentState.edit={...currentState.edit,...editData},this.globalState.setState(currentState,!0)}updateUI(uiData){var currentState=this.globalState.getState();currentState.ui={...currentState.ui,...uiData},this.globalState.setState(currentState,!0)}async addChatMessage(role,content){var currentState=this.globalState.getState(),content={role:role,content:content,timestamp:formatDate(new Date),id:`${role}_${Date.now()}_`+Math.random().toString(36).substr(2,9)};if(currentState.chatHistory.push(content),this.globalState.setState(currentState),"assistant"===role)try{await this.saveProject()}catch(error){console.warn("ProjectManager: Failed to save project after assistant message:",error.message)}}ready(){return this.isReady}}class PlanModule{constructor(globalState,projectManager,api){this.globalState=globalState,this.projectManager=projectManager,this.api=api,this.domManager=new DOMManager,this.bubbles=new Map,this.sections=new Map,this.isInitialized=!1,this.isDragging=!1,this.restoreTimeout=null,this.handleAddIdeaClick=this.handleAddIdeaClick.bind(this),this.projectManager.registerModule("plan",this),this.init()}init(){this.setupEventDelegation(),this.setupElements(),this.setupDragAndDrop(),this.setupEventListeners(),this.setupStateSync(),this.isInitialized=!0;var currentState=this.globalState.getState();currentState.plan&&(currentState.plan.customSections||currentState.plan.removedSections)?this.loadSections():this.globalState.subscribe("ready",()=>{this.loadSections()}),setTimeout(()=>{this.updateAskAIButtonState(),this.updateAskAIOutlineButtonState()},200)}setupEventDelegation(){this.eventDelegationSetup||(this.eventDelegationSetup=!0,console.log("Setting up event delegation for Ask AI button"),this.delegationHandler=e=>{var targetId=e.target.id,isAskAI="askAIButton"===targetId||e.target.closest("#askAIButton"),isAskAIOutline="askAIOutlineButton"===targetId||e.target.closest("#askAIOutlineButton"),isAddIdea="addIdeaBubble"===targetId,isAddSection="addCustomSection"===targetId||e.target.closest("#addCustomSection");if(isAskAI||isAskAIOutline||isAddIdea||isAddSection){if(isAskAI){isAskAI="askAIButton"===targetId?e.target:e.target.closest("#askAIButton");if(isAskAI)return isAskAI.disabled||isAskAI.classList.contains("disabled")?(e.preventDefault(),void e.stopPropagation()):(e.preventDefault(),e.stopPropagation(),console.log("Ask AI button clicked via event delegation - calling handleAskAIClick"),void this.handleAskAIClick())}if(isAskAIOutline){isAskAI="askAIOutlineButton"===targetId?e.target:e.target.closest("#askAIOutlineButton");if(isAskAI)return isAskAI.disabled||isAskAI.classList.contains("disabled")?(e.preventDefault(),void e.stopPropagation()):(e.preventDefault(),e.stopPropagation(),console.log("Ask AI Outline button clicked via event delegation - calling handleAskAIOutlineClick"),void this.handleAskAIOutlineClick())}isAddIdea?(e.preventDefault(),e.stopPropagation(),this.handleAddIdeaClick(e)):isAddSection&&(e.preventDefault(),e.stopPropagation(),this.addCustomSection())}},document.addEventListener("click",this.delegationHandler))}setupElements(){this.elements={ideaBubbles:this.domManager.getElement("ideaBubbles"),outlineItems:this.domManager.getElement("outlineItems"),addIdeaBubbleBtn:this.domManager.getElement("addIdeaBubble")},this.elements.addIdeaBubbleBtn&&document.getElementById("addCustomSection")||setTimeout(()=>{this.elements.addIdeaBubbleBtn=this.domManager.getElement("addIdeaBubble"),this.elements.addIdeaBubbleBtn&&this.domManager.addEventListener(this.elements.addIdeaBubbleBtn,"click",this.handleAddIdeaClick);var addCustomSectionBtn=document.getElementById("addCustomSection");addCustomSectionBtn&&addCustomSectionBtn.addEventListener("click",()=>{this.addCustomSection()})},200)}setupDragAndDrop(){"undefined"==typeof Sortable?console.error("Sortable.js not loaded"):this.elements.ideaBubbles&&new Sortable(this.elements.ideaBubbles,{group:{name:"bubbles",pull:!0,put:["bubbles"]},sort:!1,animation:150,onStart:evt=>{this.isDragging=!0},onEnd:evt=>{this.isDragging=!1,this.handleDragEnd(evt)}})}setupEventListeners(){let retryCount=0,trySetupButtons=()=>{retryCount++;let btnFound=!1;this.elements.addIdeaBubbleBtn?btnFound=!0:(btn=document.getElementById("addIdeaBubble"))&&(this.elements.addIdeaBubbleBtn=btn,this.domManager.addEventListener(btn,"click",e=>{e.preventDefault(),e.stopPropagation(),this.handleAddIdeaClick(e)}),btnFound=!0);let sectionBtnFound=!1;var btn=document.getElementById("addCustomSection"),btn=(btn&&(newBtn=btn.cloneNode(!0),btn.parentNode.replaceChild(newBtn,btn),newBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.addCustomSection()}),sectionBtnFound=!0),document.getElementById("askAIButton")),newBtn=(btn&&this.updateAskAIButtonState(),document.getElementById("askAIOutlineButton"));return newBtn&&this.updateAskAIOutlineButtonState(),!(!btnFound||!sectionBtnFound)||(retryCount<5&&setTimeout(trySetupButtons,300),!1)};trySetupButtons()}async saveInstructorGoal(tab,goalValue){if(window.canEditGoals)try{var api=this.projectManager?.api;api&&(await api.saveInstructorGoal(tab,goalValue),window.instructorGoals)&&(window.instructorGoals[tab]=goalValue)}catch(error){throw console.error("Failed to save instructor goal:",error),error}}setupEventListeners(){document.addEventListener("bubbleContentChanged",event=>{var{bubbleId:event,content}=event.detail,event=this.bubbles.get(event);event&&(event.content=content)}),document.addEventListener("bubbleDeleted",event=>{event=event.detail.bubbleId;this.handleBubbleDeleted(event)})}handleAddIdeaClick(e){e&&(e.preventDefault(),e.stopPropagation()),this.addIdeaBubble()}async handleBubbleDeleted(bubbleId){try{var node,bubble=this.bubbles.get(bubbleId),payload=bubble?{id:bubbleId,content:bubble.content||"",location:bubble.location||"brainstorm",sectionId:bubble.sectionId||""}:bubbleId;await this.api.deleteIdea(payload)?(this.bubbles.delete(bubbleId),(node=document.querySelector(`.idea-bubble[data-id="${bubbleId}"]`))&&node.parentNode&&node.parentNode.removeChild(node),this.updateAskAIButtonState(),this.updateAskAIOutlineButtonState()):console.warn("PlanModule: Backend delete returned false for",bubbleId)}catch(e){console.warn("PlanModule: Delete idea failed:",e?.message||e)}}triggerAutoSave(){this.projectManager.scheduleAutoSave("plan",!0)}setupStateSync(){this.globalState.subscribe("ready",async state=>{this.isInitialized&&(this.loadSections(),await new Promise(resolve=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{resolve()})})})),this.isInitialized&&state.plan&&state.plan.ideas&&this.restoreBubblesFromState(state.plan.ideas)}),this.globalState.subscribe("aiUpdate",updatedProject=>{this.isInitialized&&updatedProject.plan&&updatedProject.plan.ideas&&this.handleAIUpdates(updatedProject.plan.ideas)})}handleAIUpdates(ideas){Array.isArray(ideas)&&ideas.filter(idea=>idea.aiGenerated&&"brainstorm"===idea.location&&!this.bubbles.has(idea.id)).forEach(idea=>{idea=new BubbleComponent(idea.content,idea.id,!0);this.bubbles.set(idea.id,idea),this.elements.ideaBubbles&&this.elements.ideaBubbles.appendChild(idea.element)})}restoreBubblesFromState(ideas){let ideasArray;if(Array.isArray(ideas))ideasArray=ideas;else{if("object"!=typeof ideas||null===ideas)return;ideasArray=Object.values(ideas)}this.clearAllBubbles(),ideasArray.forEach(idea=>{var bubble,contentDiv,placeholder;idea.id&&idea.content?(bubble=new BubbleComponent(idea.content,idea.id,idea.aiGenerated||!1),this.bubbles.set(bubble.id,bubble),"brainstorm"===idea.location?(bubble.setLocation("brainstorm",null),this.elements.ideaBubbles&&this.elements.ideaBubbles.appendChild(bubble.element),(contentDiv=bubble.element.querySelector(".bubble-content"))&&(bubble.element.addEventListener("bubbleContentChanged",()=>{this.updateAskAIButtonState(),this.updateAskAIOutlineButtonState()}),contentDiv.addEventListener("input",()=>{this.updateAskAIButtonState(),this.updateAskAIOutlineButtonState()}))):"outline"===idea.location&&idea.sectionId?(bubble.setLocation("outline",idea.sectionId),(contentDiv=this.sections.get(idea.sectionId))&&contentDiv.element?(contentDiv=contentDiv.element.querySelector(".outline-container"))?(contentDiv.appendChild(bubble.element),(placeholder=contentDiv.querySelector(".dropzone-placeholder"))&&placeholder.remove(),contentDiv.classList.remove("empty")):(bubble.setLocation("brainstorm",null),this.elements.ideaBubbles&&this.elements.ideaBubbles.appendChild(bubble.element)):(console.warn("Section not found for bubble:",idea.sectionId,"- bubble will be added to brainstorm as fallback"),bubble.setLocation("brainstorm",null),this.elements.ideaBubbles&&this.elements.ideaBubbles.appendChild(bubble.element))):(console.warn("Invalid bubble location or missing sectionId:",idea),bubble.setLocation("brainstorm",null),this.elements.ideaBubbles&&this.elements.ideaBubbles.appendChild(bubble.element))):console.warn("Invalid idea data:",idea)}),setTimeout(()=>{this.updateAskAIButtonState(),this.updateAskAIOutlineButtonState()},100)}clearAllBubbles(){this.elements.ideaBubbles&&(this.elements.ideaBubbles.innerHTML=""),this.sections.forEach(section=>{var placeholder,section=section.element.querySelector(".outline-container");section&&(section.innerHTML="",section.classList.add("empty"),(placeholder=createElement("div","dropzone-placeholder","Drop ideas here to create outline items")).draggable=!1,section.appendChild(placeholder))}),this.bubbles.clear()}async handleDragEnd(evt){var bubbleId=evt.item.dataset.id,bubble=this.bubbles.get(bubbleId);if(bubble)if(evt.to===this.elements.ideaBubbles)bubble.setLocation("brainstorm",null);else{var sectionElement=evt.to.closest(".template-section");if(sectionElement){sectionElement=sectionElement.dataset.sectionId;sectionElement?bubble.setLocation("outline",sectionElement):console.warn("PlanModule.handleDragEnd(): Section element found but no sectionId")}else{sectionElement=evt.to.closest(".outline-container");if(sectionElement&&sectionElement.dataset.sectionId){let sectionId=sectionElement.dataset.sectionId;bubble.setLocation("outline",sectionId)}else console.warn("PlanModule.handleDragEnd(): Could not find section element for dropped bubble")}}else console.warn("PlanModule.handleDragEnd(): Bubble not found in bubbles map:",bubbleId);try{await this.projectManager.saveProject()}catch(e){console.warn("PlanModule.handleDragEnd(): Save after drag failed:",e?.message||e)}}loadSections(){try{if(!this.sectionsLoading){this.sectionsLoading=!0;var state=this.globalState.getState(),savedSections=state.plan?.customSections||[];let customTitles=state.plan?.customSectionTitles||{},removedSections=state.plan?.removedSections||[];var sectionsWithCustomTitles=this.getDefaultExampleSections().filter(section=>!removedSections.includes(section.id)).map(section=>({...section,title:customTitles[section.id]||section.title,isCustom:!1})),customSectionsWithDefaults=savedSections.filter(cs=>!removedSections.includes(cs.id)).map(cs=>({...cs,required:!1,allowMultiple:!0,editableTitle:!0,editableDescription:!0,isCustom:!0,outline:[]}));let allSections=[...sectionsWithCustomTitles,...customSectionsWithDefaults];var savedOrder=state.plan?.sectionOrder||[];if(0<savedOrder.length){let sectionMap=new Map(allSections.map(s=>[s.id,s])),orderedSections=[],unorderedSections=[];savedOrder.forEach(sectionId=>{sectionMap.has(sectionId)&&(orderedSections.push(sectionMap.get(sectionId)),sectionMap.delete(sectionId))}),sectionMap.forEach(section=>{unorderedSections.push(section)}),allSections=[...orderedSections,...unorderedSections]}0<allSections.length?this.createSections(allSections):this.createDefaultSections(),this.sectionsLoading=!1}}catch(error){console.error("Failed to load sections:",error),console.warn("Creating default example sections as fallback"),this.createDefaultSections(),this.sectionsLoading=!1}}getDefaultExampleSections(){return[{id:"introduction",title:"Introduction",description:"Hook, background, and thesis statement",required:!1,allowMultiple:!1,editableTitle:!0,editableDescription:!0,outline:[]},{id:"main-arguments",title:"Main Arguments",description:"Your key points supporting your thesis",required:!1,allowMultiple:!0,editableTitle:!0,editableDescription:!0,outline:[]},{id:"conclusion",title:"Conclusion",description:"Restate thesis and summarize main points",required:!1,allowMultiple:!1,editableTitle:!0,editableDescription:!0,outline:[]}]}createDefaultSections(){var defaultSections=this.getDefaultExampleSections();this.createSections(defaultSections)}createSections(sections){this.elements.outlineItems&&(this.elements.outlineItems.innerHTML="",sections.forEach(sectionData=>{let section=new SectionComponent(sectionData);this.sections.set(section.id,section),section.originalTitle||(section.originalTitle=section.title),section.isCustom||section.defaultTitle||(sectionData=this.getDefaultExampleSections().find(s=>s.id===section.id))&&(section.defaultTitle=sectionData.title),this.setupSectionDragAndDrop(section),this.setupSectionEventListeners(section),this.elements.outlineItems.appendChild(section.element)}),this.elements.outlineItems)&&this.setupSectionSortable()}setupSectionSortable(){"undefined"!=typeof Sortable&&this.elements.outlineItems&&(this.sectionSortable&&this.sectionSortable.destroy(),this.sectionSortable=new Sortable(this.elements.outlineItems,{animation:200,ghostClass:"section-ghost",chosenClass:"section-chosen",filter:".section-title, .section-delete-btn, .outline-container, .bubble-content",preventOnFilter:!1,onEnd:evt=>{this.handleSectionReorder()}}))}setupSectionEventListeners(section){section.element.addEventListener("sectionTitleChanged",event=>{var{sectionId:event,newTitle}=event.detail,event=this.sections.get(event);event&&(event.title=newTitle,this.projectManager.scheduleAutoSave("section-title",!0))}),section.element.addEventListener("sectionDeleted",event=>{var{sectionId:event,isCustom}=event.detail;isCustom?this.deleteCustomSection(event):this.removeTemplateSection(event)})}addCustomSection(){var newSection={id:"custom-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),title:"New Section",description:"",required:!1,allowMultiple:!0,editableTitle:!0,editableDescription:!0,isCustom:!0,outline:[]},newSection=new SectionComponent(newSection);if(this.sections.set(newSection.id,newSection),this.setupSectionDragAndDrop(newSection),this.setupSectionEventListeners(newSection),this.elements.outlineItems){this.elements.outlineItems.appendChild(newSection.element);let titleElement=newSection.element.querySelector(".section-title");titleElement&&setTimeout(()=>{titleElement.focus();var range=document.createRange(),selection=(range.selectNodeContents(titleElement),window.getSelection());selection.removeAllRanges(),selection.addRange(range)},100)}else{var outlineItems=document.getElementById("outlineItems");outlineItems&&(this.elements.outlineItems=outlineItems).appendChild(newSection.element)}return this.projectManager.saveProject().catch(err=>{console.error("PlanModule.addCustomSection(): Failed to save:",err)}),newSection}deleteCustomSection(sectionId){var section=this.sections.get(sectionId);section&&(section.isCustom?(section.getBubbles().forEach(bubbleData=>{bubbleData=this.bubbles.get(bubbleData.id);bubbleData&&(bubbleData.setLocation("brainstorm",null),this.elements.ideaBubbles)&&this.elements.ideaBubbles.appendChild(bubbleData.element)}),this.sections.delete(sectionId),section.element.parentNode&&section.element.parentNode.removeChild(section.element),this.projectManager.saveProject().catch(err=>{console.error("PlanModule.deleteCustomSection(): Failed to save:",err)})):console.warn("Cannot delete required section:",sectionId))}removeTemplateSection(sectionId){var section=this.sections.get(sectionId);section?(section.getBubbles().forEach(bubbleData=>{bubbleData=this.bubbles.get(bubbleData.id);bubbleData&&(bubbleData.setLocation("brainstorm",null),this.elements.ideaBubbles)&&this.elements.ideaBubbles.appendChild(bubbleData.element)}),this.sections.delete(sectionId),section.element.parentNode&&section.element.parentNode.removeChild(section.element),this.projectManager.saveProject().catch(err=>{console.error("PlanModule.removeTemplateSection(): Failed to save:",err)})):console.warn(`PlanModule: Cannot remove section ${sectionId} - not found`)}setupSectionDragAndDrop(section){"undefined"!=typeof Sortable&&(section=section.element.querySelector(".outline-container"))&&new Sortable(section,{group:{name:"bubbles",pull:!0,put:["bubbles"]},sort:!0,animation:150,onStart:evt=>{this.isDragging=!0},onEnd:evt=>{this.isDragging=!1,this.handleDragEnd(evt)}})}handleSectionReorder(){Array.from(this.elements.outlineItems.children).map(child=>child.dataset.sectionId||child.id.replace("section-",""));this.projectManager.saveProject().catch(err=>{console.error("PlanModule.handleSectionReorder(): Failed to save:",err)})}addIdeaBubble(content=" "){let bubble=new BubbleComponent(content);if(bubble.location="brainstorm",this.bubbles.set(bubble.id,bubble),this.elements.ideaBubbles){this.elements.ideaBubbles.appendChild(bubble.element);let contentDiv=bubble.element.querySelector(".bubble-content");contentDiv&&(contentDiv.focus(),bubble.element.addEventListener("bubbleContentChanged",()=>{this.updateAskAIButtonState(),this.updateAskAIOutlineButtonState()}),contentDiv.addEventListener("input",()=>{this.updateAskAIButtonState(),this.updateAskAIOutlineButtonState()}),contentDiv.addEventListener("blur",()=>{var finalContent;this.isDragging||((finalContent=contentDiv.textContent.trim())&&"New idea"!==finalContent&&0<finalContent.length?(bubble.content=finalContent,this.triggerAutoSave()):finalContent&&"New idea"!==finalContent||(bubble.content=finalContent||""),this.updateAskAIButtonState(),this.updateAskAIOutlineButtonState())},{once:!1}))}else{content=document.getElementById("ideaBubbles");content&&(this.elements.ideaBubbles=content).appendChild(bubble.element)}this.updateAskAIButtonState()}collectBubbleData(){let allBubbles=[];return this.bubbles.forEach(bubble=>{bubble={id:bubble.id,content:bubble.content,location:bubble.location||"brainstorm",sectionId:bubble.sectionId||null,aiGenerated:bubble.aiGenerated||!1};allBubbles.push(bubble)}),allBubbles}saveAllBubbles(){return this.collectBubbleData()}updateBubbleIds(mappings){mappings&&0!==Object.keys(mappings).length&&Object.entries(mappings).forEach(([clientId,dbId])=>{var bubble;clientId!=dbId&&(dbId=String(dbId),bubble=this.bubbles.get(clientId))&&(this.bubbles.delete(clientId),this.bubbles.delete(clientId),bubble.id=dbId,this.bubbles.set(dbId,bubble),bubble.element)&&(bubble.element.dataset.id=dbId)})}collectData(){var currentBubbles=this.collectBubbleData();let outline=[],customSectionTitles={},customSections=[],removedSections=[];this.sections.forEach(section=>{var titleElement=section.element.querySelector(".section-title"),titleElement=titleElement?titleElement.textContent.trim():section.title,defaultSection=(section.originalTitle||(section.originalTitle=section.title||titleElement),section.isCustom||section.defaultTitle||(defaultSection=this.getDefaultExampleSections().find(s=>s.id===section.id))&&(section.defaultTitle=defaultSection.title),titleElement!==section.title&&(section.title=titleElement),{id:section.id,title:titleElement,description:section.description,bubbles:section.getBubbles(),isCustom:section.isCustom||!1,required:!1!==section.required});outline.push(defaultSection),section.isCustom?customSections.push({id:section.id,title:titleElement,description:section.description}):(defaultSection=section.defaultTitle||section.originalTitle)&&titleElement!==defaultSection||!defaultSection&&titleElement?customSectionTitles[section.id]=titleElement:customSectionTitles[section.id]&&delete customSectionTitles[section.id]});var defaultSectionIds=this.getDefaultExampleSections().map(s=>s.id);let currentSectionIds=Array.from(this.sections.keys());defaultSectionIds.forEach(defaultSectionId=>{currentSectionIds.includes(defaultSectionId)||removedSections.includes(defaultSectionId)||removedSections.push(defaultSectionId)});var defaultSectionIds=customSections.filter(cs=>!removedSections.includes(cs.id)),sectionOrder=Array.from(this.elements.outlineItems.children).map(child=>child.dataset.sectionId||child.id.replace("section-","")).filter(id=>id);return{plan:{ideas:currentBubbles,outline:outline,customSectionTitles:customSectionTitles,customSections:defaultSectionIds,removedSections:removedSections,sectionOrder:sectionOrder,customSectionDescriptions:{}}}}updateAskAIButtonState(){var ideaCount,hasEnoughIdeas,askAIButton=document.getElementById("askAIButton");askAIButton?(hasEnoughIdeas=4<=(ideaCount=Array.from(this.bubbles.values()).filter(bubble=>{if("brainstorm"!==bubble.location)return!1;let content="";var contentDiv;return 0<(content=(bubble.getContent?bubble.getContent():(contentDiv=bubble.element?.querySelector(".bubble-content"))?contentDiv.textContent:bubble.content||"").trim()).length}).length),console.log("Ask AI Button State Update:",{totalBubbles:this.bubbles.size,brainstormIdeas:ideaCount,hasEnoughIdeas:hasEnoughIdeas,bubbles:Array.from(this.bubbles.values()).map(b=>({id:b.id,location:b.location,content:b.getContent?b.getContent():b.content}))}),askAIButton.disabled=!hasEnoughIdeas,hasEnoughIdeas?(askAIButton.title="Ask AI for additional ideas",askAIButton.classList.remove("disabled")):(askAIButton.title="You have to add atleast 4 ideas before",askAIButton.classList.add("disabled"))):console.log("Ask AI button not found")}async handleAskAIClick(){console.log("=== handleAskAIClick called ===");var askAIButton=document.getElementById("askAIButton");if(console.log("Button found:",!!askAIButton),console.log("Button disabled:",askAIButton?.disabled),askAIButton)if(askAIButton.disabled)console.log("Ask AI button is disabled");else{console.log("Ask AI button clicked, collecting ideas...");askAIButton=Array.from(this.bubbles.values()).filter(bubble=>{if("brainstorm"!==bubble.location)return!1;let content="";var contentDiv;return 0<(content=(bubble.getContent?bubble.getContent():(contentDiv=bubble.element?.querySelector(".bubble-content"))?contentDiv.textContent:bubble.content||"").trim()).length}).map(bubble=>{var contentDiv;return(bubble.getContent?bubble.getContent():(contentDiv=bubble.element?.querySelector(".bubble-content"))?contentDiv.textContent:bubble.content||"").trim()});if(console.log("Brainstorm ideas collected:",askAIButton),askAIButton.length<4)console.log("Not enough ideas:",askAIButton.length);else{let thesis="";var goalElement=document.getElementById("assignmentGoal"),goalElement=(thesis=goalElement?goalElement.textContent.trim():this.globalState.getState()?.metadata?.goal||"",console.log("Thesis/goal:",thesis),askAIButton.join(", ")),askAIButton=`I am a student working on a writing assignment, and this is my thesis [${thesis||"No thesis provided"}]. I have come up with some ideas already [${goalElement}]. Please provide me with 5-10 additional ideas that are related to what I've come up with to help me plan what I want to write about.`;console.log("Prompt created:",askAIButton),window.aiWritingAssistant&&window.aiWritingAssistant.chatSystem?((goalElement=document.querySelector(".chat-section"))&&goalElement.scrollIntoView({behavior:"smooth",block:"nearest"}),console.log("Sending message to chat system..."),await window.aiWritingAssistant.chatSystem.sendMessage(askAIButton),console.log("Message sent successfully")):console.error("Chat system not available",{aiWritingAssistant:window.aiWritingAssistant,chatSystem:window.aiWritingAssistant?.chatSystem})}}else console.error("Ask AI button not found in DOM")}updateAskAIOutlineButtonState(){var ideaCount,hasEnoughIdeas,askAIOutlineButton=document.getElementById("askAIOutlineButton");askAIOutlineButton?(hasEnoughIdeas=5<=(ideaCount=Array.from(this.bubbles.values()).filter(bubble=>{if("brainstorm"!==bubble.location)return!1;let content="";var contentDiv;return 0<(content=(bubble.getContent?bubble.getContent():(contentDiv=bubble.element?.querySelector(".bubble-content"))?contentDiv.textContent:bubble.content||"").trim()).length}).length),console.log("Ask AI Outline Button State Update:",{totalBubbles:this.bubbles.size,brainstormIdeas:ideaCount,hasEnoughIdeas:hasEnoughIdeas,bubbles:Array.from(this.bubbles.values()).map(b=>({id:b.id,location:b.location,content:b.getContent?b.getContent():b.content}))}),askAIOutlineButton.disabled=!hasEnoughIdeas,console.log("Outline button disabled state:",askAIOutlineButton.disabled,"hasEnoughIdeas:",hasEnoughIdeas),hasEnoughIdeas?(askAIOutlineButton.title="Ask AI to generate an outline based on your brainstorm ideas",askAIOutlineButton.classList.remove("disabled")):(askAIOutlineButton.title="You have to add atleast 4 ideas in brainstorm before",askAIOutlineButton.classList.add("disabled"))):console.log("Ask AI Outline button not found")}async handleAskAIOutlineClick(){console.log("=== handleAskAIOutlineClick called ===");var askAIOutlineButton=document.getElementById("askAIOutlineButton");if(console.log("Button found:",!!askAIOutlineButton),console.log("Button disabled:",askAIOutlineButton?.disabled),askAIOutlineButton)if(askAIOutlineButton.disabled)console.log("Ask AI Outline button is disabled");else{console.log("Ask AI Outline button clicked, collecting ideas...");askAIOutlineButton=Array.from(this.bubbles.values()).filter(bubble=>{if("brainstorm"!==bubble.location)return!1;let content="";var contentDiv;return 0<(content=(bubble.getContent?bubble.getContent():(contentDiv=bubble.element?.querySelector(".bubble-content"))?contentDiv.textContent:bubble.content||"").trim()).length}).map(bubble=>{var contentDiv;return(bubble.getContent?bubble.getContent():(contentDiv=bubble.element?.querySelector(".bubble-content"))?contentDiv.textContent:bubble.content||"").trim()});if(console.log("Brainstorm ideas collected:",askAIOutlineButton),askAIOutlineButton.length<4)console.log("Not enough ideas:",askAIOutlineButton.length);else{let topic="";var goalElement=document.getElementById("assignmentGoal"),goalElement=(topic=goalElement?goalElement.textContent.trim():this.globalState.getState()?.metadata?.goal||"",console.log("Topic/goal:",topic),askAIOutlineButton.join(", ")),askAIOutlineButton=Math.max(3,Math.min(8,Math.ceil(askAIOutlineButton.length/2.5))),goalElement=`I am a student completing a writing assignment on the topic of [${topic||"No topic provided"}]. I have come up with some ideas that are related to this topic: [${goalElement}]. Provide me with an outline that incorporates my ideas into a ${askAIOutlineButton}-paragraph essay, where the ideas are tied into related groups that will then become my body paragraphs.`;console.log("Prompt created:",goalElement),window.aiWritingAssistant&&window.aiWritingAssistant.chatSystem?((askAIOutlineButton=document.querySelector(".chat-section"))&&askAIOutlineButton.scrollIntoView({behavior:"smooth",block:"nearest"}),console.log("Sending message to chat system..."),await window.aiWritingAssistant.chatSystem.sendMessage(goalElement),console.log("Message sent successfully")):console.error("Chat system not available",{aiWritingAssistant:window.aiWritingAssistant,chatSystem:window.aiWritingAssistant?.chatSystem})}}else console.error("Ask AI Outline button not found in DOM")}}class BaseEditorModule{constructor(globalState,projectManager,editorId,moduleName){this.globalState=globalState,this.projectManager=projectManager,this.editorId=editorId,this.moduleName=moduleName,this.editor=null,this.init()}init(){this.initializeEditor(),this.setupEventListeners()}initializeEditor(){var editorContainer=document.getElementById(this.editorId);if(editorContainer)try{this.editor=new Quill("#"+this.editorId,quillConfig),this.editor.format("size","12pt"),editorContainer.classList.add("quill-page"),this.setupEditorEvents()}catch(error){console.error(`Failed to initialize ${this.moduleName} editor:`,error)}}setupEditorEvents(){if(this.editor){let debounceTimer=null;this.editor.on("text-change",(delta,oldDelta,source)=>{"user"===source&&(debounceTimer&&clearTimeout(debounceTimer),debounceTimer=setTimeout(()=>{console.log(this.moduleName+": Triggering autosave after text-change"),this.projectManager.saveProject().catch(e=>{console.error(this.moduleName+": Autosave failed:",e)})},300))}),"Write"===this.moduleName&&this.setupSelectionTracking()}else console.warn(this.moduleName+": Editor not initialized, cannot setup autosave")}setupSelectionTracking(){this.editor&&setTimeout(()=>{this.editor.on("selection-change",range=>{this.updateAIToolButtons(range)});var editorElement=this.editor.root,editorElement=(editorElement.addEventListener("mouseup",()=>{setTimeout(()=>{var range=this.editor.getSelection();this.updateAIToolButtons(range)},10)}),editorElement.addEventListener("keyup",()=>{setTimeout(()=>{var range=this.editor.getSelection();this.updateAIToolButtons(range)},10)}),this.setupAIToolButtons(),this.editor.getSelection());this.updateAIToolButtons(editorElement)},100)}updateAIToolButtons(range){var transitionBtn=document.getElementById("transitionBtn"),rephraseBtn=document.getElementById("rephraseBtn");if(transitionBtn&&rephraseBtn){if(range&&0<range.length){var selectedText=this.editor.getText(range.index,range.length).trim();if(0<selectedText.length)return this.selectedText=selectedText,this.selectedRange=range,2<=(range=this.countSentences(selectedText))?(transitionBtn.disabled=!1,transitionBtn.classList.remove("disabled"),transitionBtn.title=`Get transition suggestions for ${range} selected sentences`):(transitionBtn.disabled=!0,transitionBtn.classList.add("disabled"),transitionBtn.title=`Select at least 2 sentences (currently ${range})`),rephraseBtn.disabled=!1,rephraseBtn.classList.remove("disabled"),range=this.detectTextType(selectedText),void(rephraseBtn.title="Rephrase "+range)}this.selectedText="",this.selectedRange=null,transitionBtn.disabled=!0,transitionBtn.classList.add("disabled"),transitionBtn.title="Select at least two sentences to get transition suggestions",rephraseBtn.disabled=!0,rephraseBtn.classList.add("disabled"),rephraseBtn.title="Select a sentence or paragraph to rephrase"}}detectTextType(text){var sentenceCount=this.countSentences(text),text=text.split(/\s+/).filter(w=>0<w.length).length;return 1===sentenceCount?"sentence":1<sentenceCount||20<text?"paragraph":"text"}countSentences(text){var sentences,text=text.trim();return text?0===(sentences=text.split(/[.!?]+(?:\s+|$)/).filter(s=>0<s.trim().length)).length&&0<text.length?/[.!?]$/.test(text)?1:0:(text=text[text.length-1],0<sentences.length&&/[.!?]/.test(text),sentences.length):0}setupActionButtons(){var saveExitBtn=document.getElementById("saveExitBtn");saveExitBtn&&saveExitBtn.addEventListener("click",()=>this.handleSaveAndExit())}async handleSaveAndExit(){await this._handleSaveOperation("saveExitBtn",!0)}setupAIToolButtons(){var transitionBtn=document.getElementById("transitionBtn"),rephraseBtn=document.getElementById("rephraseBtn");transitionBtn&&transitionBtn.addEventListener("click",()=>this.handleTransitionHelper()),rephraseBtn&&rephraseBtn.addEventListener("click",()=>this.handleRephrase())}async handleTransitionHelper(){var sentenceCount,chatSection;this.selectedText&&0!==this.selectedText.trim().length?(sentenceCount=this.countSentences(this.selectedText))<2?alert(`Please select at least 2 sentences. Currently selected: ${sentenceCount} sentence(s).`):(sentenceCount=`I am a student writing an essay. I have selected two sentences from my writing and need help connecting them smoothly. Please provide some words that I can use to tie these two sentences together to make a smooth transition.

Selected sentences:
${this.selectedText}

Please provide:
1. A list of transition words/phrases (e.g., "Furthermore", "In addition", "However", "On the other hand", etc.)
2. A brief explanation of when each transition would be most appropriate
3. An example of how to use one of the transitions to connect the sentences`,window.aiWritingAssistant&&window.aiWritingAssistant.chatSystem?((chatSection=document.querySelector(".chat-section"))&&chatSection.scrollIntoView({behavior:"smooth",block:"nearest"}),await window.aiWritingAssistant.chatSystem.sendMessage(sentenceCount)):(console.error("Chat system not available"),alert("Chat system is not available. Please try again later."))):alert("Please select at least two sentences to get transition suggestions.")}escapeHtml(text){var div=document.createElement("div");return div.textContent=text,div.innerHTML}async handleRephrase(){var prompt,chatSection;this.selectedText&&0!==this.selectedText.trim().length?(prompt=`I am a student writing an essay. Here is a phrase that I have written: ["${this.selectedText}"]. I have used the words in this phrase previously and would like you to provide some options on how I can reword this phrase, while keeping the original meaning.`,window.aiWritingAssistant&&window.aiWritingAssistant.chatSystem?((chatSection=document.querySelector(".chat-section"))&&chatSection.scrollIntoView({behavior:"smooth",block:"nearest"}),await window.aiWritingAssistant.chatSystem.sendMessage(prompt)):(console.error("Chat system not available"),alert("Chat system is not available. Please try again later."))):alert("Please select a sentence or paragraph to rephrase.")}setupEventListeners(){this.globalState.subscribe("ready",state=>{state=state[this.moduleName.toLowerCase()];state&&this.editor&&(this.editor.root.innerHTML=state.content||"")})}calculateWordCount(){return this.editor?this.editor.getText().trim().split(/\s+/).filter(word=>0<word.length).length:0}}class WriteModule extends BaseEditorModule{constructor(globalState,projectManager){super(globalState,projectManager,"writeEditor","Write"),this.projectManager.registerModule("write",this),this.lastSaveWasManual=!1,this.templateInserted=!1,this.selectedText="",this.selectedRange=null}handleTextChange(content){}insertOutlineTemplate(){if(this.editor){var currentContent=this.editor.root.innerHTML.trim(),currentContent=!currentContent||"<p><br></p>"===currentContent||"<p></p>"===currentContent||"<br>"===currentContent||""===currentContent.replace(/<[^>]*>/g,"").trim();let sections=[];if(window.aiWritingAssistant&&window.aiWritingAssistant.modules&&window.aiWritingAssistant.modules.plan){let planModule=window.aiWritingAssistant.modules.plan;planModule.sections&&0<planModule.sections.size&&((outlineItems=document.getElementById("outlineItems"))?Array.from(outlineItems.children).map(child=>child.dataset.sectionId||child.id.replace("section-","")).filter(id=>id).forEach(sectionId=>{sectionId=planModule.sections.get(sectionId);sectionId&&sectionId.title&&sections.push({id:sectionId.id,title:sectionId.title,description:sectionId.description||""})}):planModule.sections.forEach((section,id)=>{section&&section.title&&sections.push({id:section.id,title:section.title,description:section.description||""})}))}if(0===(sections=0===sections.length&&window.templateData&&window.templateData.sections?window.templateData.sections:sections).length)console.log("WriteModule: No outline sections found, skipping template insertion");else if(currentContent){var outlineItems=sections.map((section,index)=>{let html=`<h2>${this.escapeHtml(section.title)}</h2>`;return section.description&&section.description.trim()&&(html+=`<p><em>${this.escapeHtml(section.description)}</em></p>`),html+="<p><br></p>",index<sections.length-1&&(html+="<p><br></p>"),html}).join("");this.editor.clipboard.dangerouslyPasteHTML(outlineItems),this.templateInserted=!0,console.log("WriteModule: Outline template inserted with",sections.length,"sections")}else{let existingHeadings=this.extractExistingHeadings();var Delta,length,currentContent=sections.filter(section=>{let sectionTitle=section.title.trim().toLowerCase();return!existingHeadings.some(existing=>existing.toLowerCase()===sectionTitle)});0===currentContent.length?console.log("WriteModule: All outline sections already exist in editor"):(outlineItems=currentContent.map((section,index)=>{let html="<p><br></p>";return html+=`<h2>${this.escapeHtml(section.title)}</h2>`,section.description&&section.description.trim()&&(html+=`<p><em>${this.escapeHtml(section.description)}</em></p>`),html+="<p><br></p>"}).join(""),length=this.editor.getLength(),Delta=(this.editor.setSelection(length-1),Quill.import("delta")),outlineItems=this.editor.clipboard.convert({html:outlineItems}),Delta=(new Delta).retain(length-1).concat(outlineItems),length=(this.editor.updateContents(Delta,"user"),this.editor.getLength()),this.editor.setSelection(length-1),console.log("WriteModule: Appended",currentContent.length,"missing sections to editor"))}}else console.warn("WriteModule: Editor not initialized, cannot insert template")}extractExistingHeadings(){if(!this.editor)return[];let headings=[];return this.editor.root.querySelectorAll("h2").forEach(h2=>{h2=h2.textContent.trim();h2&&headings.push(h2)}),headings}escapeHtml(text){var div=document.createElement("div");return div.textContent=text,div.innerHTML}collectData(){var content=this.editor?this.editor.root.innerHTML:"",wordCount=this.calculateWordCount(),wasManual=(this.lastSaveWasManual,this.lastSaveWasManual),content=(this.lastSaveWasManual=!1,{write:{content:content,wordCount:wordCount,changeSummary:wasManual?"Manual save":"Auto-saved"}});return content}}class EditModule extends BaseEditorModule{constructor(globalState,projectManager,api){super(globalState,projectManager,"editEditor","Edit"),this.projectManager.registerModule("edit",this),this.api=api,this.lastSaveWasManual=!1,this.reviewSuggestions=[],this.activeHighlights=new Map,this.reviewPanel=null,this.reviewStats=null,this.reviewSuggestionsContainer=null,this.isReviewing=!1,setTimeout(()=>{this.setupAIReview(),this.setupImportWriteContent(),this.moveToolbarToContainer()},500)}moveToolbarToContainer(){var customToolbar,quillToolbar;this.editor&&(customToolbar=document.getElementById("editToolbar"),quillToolbar=this.editor.container.querySelector(".ql-toolbar"),customToolbar)&&quillToolbar&&customToolbar.appendChild(quillToolbar)}handleTextChange(content){}collectData(){var content=this.editor?this.editor.root.innerHTML:"",wordCount=this.calculateWordCount(),currentState=this.globalState.getState(),wasManual=this.lastSaveWasManual,content=(this.lastSaveWasManual=!1,{edit:{content:content,wordCount:wordCount,suggestions:currentState.edit?.suggestions||[],changeSummary:wasManual?"Manual save":"Auto-saved"}});return content}setupAIReview(){var reviewBtn=document.getElementById("aiReviewBtn"),reviewPanel=document.getElementById("editReviewPanel"),reviewPanelClose=document.getElementById("reviewPanelClose"),reviewStats=document.getElementById("reviewStats"),reviewSuggestionsContainer=document.getElementById("reviewSuggestions");reviewBtn&&reviewPanel&&(this.reviewPanel=reviewPanel,this.reviewStats=reviewStats,this.reviewSuggestionsContainer=reviewSuggestionsContainer,reviewBtn.addEventListener("click",()=>this.handleAIReview()),reviewPanelClose?.addEventListener("click",()=>this.closeReviewPanel()),setTimeout(()=>{this.loadSavedReviewResults()},1e3))}setupImportWriteContent(){var importBtn=document.getElementById("importWriteContentBtn");importBtn&&!importBtn.hasAttribute("data-listener-attached")&&(importBtn.addEventListener("click",()=>this.importWriteContent()),importBtn.setAttribute("data-listener-attached","true"))}importWriteContent(){if(this.editor){var writeContent=this.globalState.getState().write?.content;if(writeContent&&writeContent.trim()&&"<p><br></p>"!==writeContent&&"<p></p>"!==writeContent&&"<br>"!==writeContent&&""!==writeContent.replace(/<[^>]*>/g,"").trim()){var currentEditContent=this.editor.root.innerHTML.trim();if(!(!currentEditContent||"<p><br></p>"===currentEditContent||"<p></p>"===currentEditContent||"<br>"===currentEditContent||""===currentEditContent.replace(/<[^>]*>/g,"").trim()))if(!confirm("The editor already contains content. Importing from Write tab will replace the current content. Do you want to continue?"))return;this.editor.clipboard.dangerouslyPasteHTML(writeContent),window.aiWritingAssistant&&window.aiWritingAssistant.activityTracker&&(currentEditContent=writeContent.replace(/<[^>]*>/g,"").length,window.aiWritingAssistant.activityTracker.trackImport("edit",currentEditContent));let importBtn=document.getElementById("importWriteContentBtn");if(importBtn){let originalText=importBtn.querySelector("span").textContent;importBtn.querySelector("span").textContent="Imported!",importBtn.style.opacity="0.7",setTimeout(()=>{importBtn.querySelector("span").textContent=originalText,importBtn.style.opacity="1"},2e3)}}else alert("No content available in the Write tab. Please write some content first.")}else alert("Editor not ready. Please try again in a moment.")}getReviewStorageKey(){return"writeassist_ai_review_"+(this.globalState.getState().currentProject?.id||"default")}saveReviewResults(){if(this.reviewSuggestions&&0!==this.reviewSuggestions.length){var reviewData={suggestions:this.reviewSuggestions,timestamp:(new Date).toISOString()};try{localStorage.setItem(this.getReviewStorageKey(),JSON.stringify(reviewData))}catch(error){console.error("EditModule: Error saving review results:",error)}}else localStorage.removeItem(this.getReviewStorageKey())}loadSavedReviewResults(){if(this.editor)try{var reviewData,currentText,storageKey=this.getReviewStorageKey(),savedData=localStorage.getItem(storageKey);savedData&&(reviewData=JSON.parse(savedData)).suggestions&&0!==reviewData.suggestions.length&&(currentText=this.editor.getText())&&0!==currentText.trim().length&&(this.reviewSuggestions=reviewData.suggestions,this.applyHighlights(),this.displayReviewResults(),this.showReviewPanel())}catch(error){console.error("EditModule: Error loading saved review results:",error)}}async handleAIReview(){if(this.editor){var text=this.editor.getText();if(text&&0!==text.trim().length){if(!this.isReviewing){this.isReviewing=!0;var originalHTML,text=document.getElementById("aiReviewBtn");text&&(text.disabled=!0,originalHTML=text.innerHTML,text.innerHTML=`
                <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M8 2L2 6v8h12V6L8 2z" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M6 8h4M6 11h2" stroke-linecap="round"/>
                </svg>
                <span>Reviewing...</span>
            `,text.dataset.originalHTML=originalHTML);try{this.clearHighlights();var plainText=this.editor.getText(),suggestions=await this.requestAIReview(plainText);suggestions&&0<suggestions.length?(this.reviewSuggestions=Array.isArray(suggestions)?JSON.parse(JSON.stringify(suggestions)):[JSON.parse(JSON.stringify(suggestions))],console.log("EditModule: Received suggestions from AI:",this.reviewSuggestions.length),console.log("EditModule: Full suggestions array:",JSON.stringify(this.reviewSuggestions,null,2)),console.log("EditModule: Count by type:",{spelling:this.reviewSuggestions.filter(s=>"spelling"===s.type).length,grammar:this.reviewSuggestions.filter(s=>"grammar"===s.type).length,run_on_sentence:this.reviewSuggestions.filter(s=>"run_on_sentence"===s.type).length}),this.applyHighlights(),console.log("EditModule: Suggestions after applyHighlights:",this.reviewSuggestions.length),this.displayReviewResults(),this.showReviewPanel()):this.showSuccessNotification("No suggestions found. Your document looks good!"),this.saveReviewResults()}catch(error){console.error("EditModule: AI Review error:",error),alert("Error performing AI review. Please try again.")}finally{this.isReviewing=!1,text&&(text.disabled=!1,text.dataset.originalHTML?(text.innerHTML=text.dataset.originalHTML,delete text.dataset.originalHTML):text.innerHTML=`
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M8 2L2 6v8h12V6L8 2z" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M6 8h4M6 11h2" stroke-linecap="round"/>
                        </svg>
                        <span>AI Review</span>
                    `)}}}else alert("Please add some content to review.")}else console.error("EditModule: Editor not initialized")}async requestAIReview(text){text=`Please review the following document and check for ONLY clear, objective errors in three categories:
1. Spelling errors - Only flag words that are clearly misspelled (e.g., "recieve" instead of "receive")
2. Grammar mistakes - Only flag clear grammatical errors (e.g., "it's" vs "its" when incorrect, subject-verb disagreement, missing punctuation that creates confusion)
3. Run-on sentences - Only flag sentences that are genuinely run-on (two independent clauses joined without proper punctuation or conjunction)

IMPORTANT GUIDELINES:
- Do NOT suggest stylistic changes or preferences
- Do NOT flag sentences that are long but grammatically correct
- Do NOT suggest changes to word choice unless it's a clear spelling error
- Only flag errors that are objectively wrong, not matters of style or preference
- If the text is well-written with no clear errors, return an empty array []

Return your response as a JSON array where each suggestion has:
- "type": one of "spelling", "grammar", "run_on_sentence"
- "original": the exact text that needs improvement (quote it exactly as it appears)
- "suggestion": the improved version
- "reason": brief explanation of the objective error
- "position": approximate position in text (character index or sentence number)

Document to review:
${text}

Return ONLY a valid JSON array, no other text. If there are no clear errors, return an empty array: []. Example format:
[
  {
    "type": "spelling",
    "original": "recieve",
    "suggestion": "receive",
    "reason": "Incorrect spelling",
    "position": 45
  },
  {
    "type": "grammar",
    "original": "The cat sat on it's mat",
    "suggestion": "The cat sat on its mat",
    "reason": "Incorrect use of apostrophe - 'it's' means 'it is', should be possessive 'its'",
    "position": 120
  },
  {
    "type": "run_on_sentence",
    "original": "I went to the store I bought some milk.",
    "suggestion": "I went to the store. I bought some milk.",
    "reason": "Run-on sentence - two independent clauses need proper punctuation",
    "position": 200
  }
]`;try{if(!this.api)throw new Error("API not available");var currentProject=this.globalState.getState(),result=await this.api.sendChatMessage(text,currentProject);if(!result||!result.assistantReply)throw new Error("No response from AI");var jsonStr,suggestions,aiResponse=result.assistantReply;let jsonMatch=aiResponse.match(/\[[\s\S]*\]/);if(jsonMatch=jsonMatch||(jsonMatch=aiResponse.match(/```json\s*([\s\S]*?)\s*```/)||aiResponse.match(/```\s*([\s\S]*?)\s*```/))&&[jsonMatch[0],jsonMatch[1]])return jsonStr=jsonMatch[1]||jsonMatch[0],suggestions=JSON.parse(jsonStr),Array.isArray(suggestions)?suggestions:[];try{let suggestions=JSON.parse(aiResponse);return Array.isArray(suggestions)?suggestions:[]}catch(e){return console.warn("EditModule: Could not parse AI response as JSON:",aiResponse),[]}}catch(error){throw console.error("EditModule: Error requesting AI review:",error),error}}applyHighlights(){if(this.editor&&this.reviewSuggestions.length){let fullText=this.editor.getText();this.editor.getContents();let usedPositions=new Set;var suggestionsWithPositions=this.reviewSuggestions.map((suggestion,originalIndex)=>{var originalText=suggestion.original.trim();return{suggestion:suggestion,originalIndex:originalIndex,position:this.findTextPosition(fullText,originalText,null),originalText:originalText}}).filter(item=>-1!==item.position);suggestionsWithPositions.sort((a,b)=>b.position-a.position),suggestionsWithPositions.forEach((item,sortedIndex)=>{var{suggestion:item,originalIndex,originalText}=item,position=this.findTextPosition(fullText,originalText,usedPositions);-1===position?console.warn("EditModule: Could not find available position for suggestion:",originalText):(usedPositions.add(position),-1!==(position=this.textPositionToQuillIndex(position,originalText.length))&&this.highlightText(position,originalText.length,"review-"+originalIndex,item))})}}findTextPosition(text,searchText,usedPositions=null){var normalizedText=text.toLowerCase(),normalizedSearch=searchText.toLowerCase().trim();let position=normalizedText.indexOf(normalizedSearch);if(usedPositions&&-1!==position)for(;-1!==position&&usedPositions.has(position);)position=normalizedText.indexOf(normalizedSearch,position+1);if(-1===position){text=normalizedSearch.split(/\s+/);if(1<text.length&&(position=normalizedText.indexOf(normalizedSearch),usedPositions)&&-1!==position)for(;-1!==position&&usedPositions.has(position);)position=normalizedText.indexOf(normalizedSearch,position+1)}return position}textPositionToQuillIndex(textPosition,length){if(!this.editor)return-1;var text=this.editor.getText();if(textPosition<0||textPosition>=text.length)return console.warn("EditModule: Invalid text position:",textPosition,"text length:",text.length),-1;var delta=this.editor.getContents();if(!delta||!delta.ops)return console.warn("EditModule: Invalid delta structure"),-1;let quillIndex=0,textIndex=0;for(let i=0;i<delta.ops.length;i++){var op=delta.ops[i];if("string"==typeof op.insert){var opLength=op.insert.length;if(textIndex+opLength>textPosition){quillIndex+=textPosition-textIndex;let editorLength=this.editor.getLength();return quillIndex>=editorLength?(console.warn("EditModule: Calculated Quill index exceeds editor length:",quillIndex,"editor length:",editorLength),-1):quillIndex}textIndex+=opLength,quillIndex+=opLength}else op.insert&&"object"==typeof op.insert&&(quillIndex+=1)}let editorLength=this.editor.getLength();return quillIndex>=editorLength?(console.warn("EditModule: Calculated Quill index exceeds editor length:",quillIndex,"editor length:",editorLength),-1):quillIndex}highlightText(index,length,highlightId,suggestion){if(this.editor)try{var editorLength=this.editor.getLength();if(index<0||editorLength<=index)console.warn("EditModule: Invalid index for highlight:",index,"editor length:",editorLength);else{var maxLength=editorLength-index-1,actualLength=Math.max(1,Math.min(length,maxLength));if(actualLength<=0||editorLength<index+actualLength)console.warn("EditModule: Invalid length for highlight:",length,"at index:",index,"max length:",maxLength,"editor length:",editorLength);else{var formatLength=Math.min(actualLength,editorLength-index-1);if(formatLength<=0)console.warn("EditModule: Format length is invalid:",formatLength,"index:",index,"editor length:",editorLength);else{try{this.editor.formatText(index,formatLength,{background:this.getHighlightColor(suggestion.type),color:"#000"},"silent")}catch(formatError){return void console.error("EditModule: Error in formatText:",formatError,"index:",index,"length:",formatLength)}this.activeHighlights.set(highlightId,{index:index,length:formatLength,suggestion:suggestion,highlightId:highlightId}),this.setupHighlightClick(index,formatLength,highlightId,suggestion)}}}}catch(error){console.error("EditModule: Error highlighting text:",error),console.error("EditModule: Index:",index,"Length:",length,"Editor length:",this.editor?.getLength())}}getHighlightColor(type){return{spelling:"#ffeb3b",grammar:"#ff9800",run_on_sentence:"#f44336"}[type]||"#ffeb3b"}setupHighlightClick(index,length,highlightId,suggestion){}clearHighlights(){this.editor&&(this.activeHighlights.forEach((data,highlightId)=>{try{this.editor.formatText(data.index,data.length,{background:"",color:""},"user")}catch(error){}}),this.activeHighlights.clear(),this.reviewSuggestions=[],this.saveReviewResults())}displayReviewResults(){if(this.reviewStats&&this.reviewSuggestionsContainer)if(Array.isArray(this.reviewSuggestions)){console.log("EditModule: Displaying review results, total suggestions:",this.reviewSuggestions.length);let counts={spelling:0,grammar:0,run_on_sentence:0};this.reviewSuggestions.forEach(s=>{s&&s.type&&counts.hasOwnProperty(s.type)&&counts[s.type]++}),this.reviewStats.innerHTML=`
            <div class="review-stat-item">
                <span class="stat-label">Total Issues:</span>
                <span class="stat-value">${this.reviewSuggestions.length}</span>
            </div>
            ${Object.entries(counts).filter(([,count])=>0<count).map(([type,count])=>`
                <div class="review-stat-item">
                    <span class="stat-label">${this.formatTypeName(type)}:</span>
                    <span class="stat-value">${count}</span>
                </div>
            `).join("")}
        `,console.log("EditModule: All suggestions to display:",this.reviewSuggestions),console.log("EditModule: Count by type:",{spelling:this.reviewSuggestions.filter(s=>"spelling"===s.type).length,grammar:this.reviewSuggestions.filter(s=>"grammar"===s.type).length,run_on_sentence:this.reviewSuggestions.filter(s=>"run_on_sentence"===s.type).length});var suggestionHTMLs=this.reviewSuggestions.map((suggestion,index)=>{var highlightId;return suggestion&&suggestion.original?(highlightId="review-"+index,console.log(`EditModule: Rendering suggestion ${index}:`,{type:suggestion.type,original:suggestion.original.substring(0,50)+"...",highlightId:highlightId}),`
                <div class="review-suggestion-item" data-highlight-id="${highlightId}" data-suggestion-index="${index}">
                    <div class="suggestion-header">
                        <span class="suggestion-type ${suggestion.type}">${this.formatTypeName(suggestion.type)}</span>
                    </div>
                    <div class="suggestion-content">
                        <div class="suggestion-original">
                            <strong>Original:</strong> "${suggestion.original}"
                        </div>
                        <div class="suggestion-improved">
                            <strong>Suggested:</strong> "${suggestion.suggestion||suggestion.suggested||"N/A"}"
                        </div>
                        <div class="suggestion-reason">
                            ${suggestion.reason||"No reason provided"}
                        </div>
                    </div>
                </div>
            `):(console.warn("EditModule: Invalid suggestion at index",index,suggestion),"")}).filter(html=>""!==html),suggestionHTMLs=(console.log("EditModule: Generated",suggestionHTMLs.length,"HTML items"),this.reviewSuggestionsContainer.innerHTML=suggestionHTMLs.join(""),this.reviewSuggestionsContainer.querySelectorAll(".review-suggestion-item"));console.log("EditModule: Actually rendered",suggestionHTMLs.length,"suggestion items in DOM"),suggestionHTMLs.forEach((item,idx)=>{var type=item.querySelector(".suggestion-type")?.textContent,item=item.querySelector(".suggestion-original")?.textContent?.substring(0,50);console.log(`EditModule: Rendered item ${idx}:`,{type:type,original:item+"..."})}),this.reviewSuggestionsContainer.querySelectorAll(".review-suggestion-item").forEach(item=>{item.addEventListener("click",e=>{var highlightId=item.dataset.highlightId;this.scrollToHighlight(highlightId)})})}else console.error("EditModule: reviewSuggestions is not an array:",this.reviewSuggestions),this.reviewSuggestions=[]}formatTypeName(type){return{spelling:"Spelling",grammar:"Grammar",run_on_sentence:"Run-on Sentence"}[type]||type}showSuccessNotification(message){let modal=document.getElementById("successNotificationModal");var messageEl=document.getElementById("successNotificationMessage"),closeBtn=document.getElementById("successNotificationClose");if(modal&&messageEl){messageEl.textContent=message||"Your document looks good!",modal.style.display="flex";let closeModal=()=>{modal.style.display="none"},escapeHandler=(closeBtn&&(closeBtn.onclick=closeModal),modal.onclick=e=>{e.target===modal&&closeModal()},e=>{"Escape"===e.key&&(closeModal(),document.removeEventListener("keydown",escapeHandler))});document.addEventListener("keydown",escapeHandler)}}scrollToHighlight(highlightId){var selection,highlightId=this.activeHighlights.get(highlightId);highlightId&&(this.editor.setSelection(highlightId.index,highlightId.length),highlightId=this.editor.root,0<(selection=window.getSelection()).rangeCount)&&((selection=selection.getRangeAt(0)).getBoundingClientRect(),highlightId.scrollTop=selection.getBoundingClientRect().top-highlightId.getBoundingClientRect().top+highlightId.scrollTop-100)}showReviewPanel(){this.reviewPanel&&(this.reviewPanel.style.display="block")}closeReviewPanel(){this.reviewPanel&&(this.reviewPanel.style.display="none"),this.clearHighlights(),this.reviewSuggestions=[],this.activeHighlights.clear()}setupEventListeners(){super.setupEventListeners(),this.editor&&this.editor.root.addEventListener("click",e=>{let selection=this.editor.getSelection();selection&&this.activeHighlights.forEach((data,highlightId)=>{selection.index>=data.index&&selection.index<data.index+data.length&&(highlightId=parseInt(highlightId.replace("review-","")),this.showSuggestionPopup(highlightId,data.suggestion))})})}showSuggestionPopup(index,suggestion){let popup=document.getElementById("suggestionPopup");popup||((popup=document.createElement("div")).id="suggestionPopup",popup.className="suggestion-popup",document.body.appendChild(popup)),popup.innerHTML=`
            <div class="popup-header">
                <span class="popup-type ${suggestion.type}">${this.formatTypeName(suggestion.type)}</span>
                <button class="popup-close" onclick="this.closest('.suggestion-popup').remove()">×</button>
            </div>
            <div class="popup-content">
                <div><strong>Original:</strong> "${suggestion.original}"</div>
                <div><strong>Suggested:</strong> "${suggestion.suggestion}"</div>
                <div>${suggestion.reason||""}</div>
            </div>
        `;var suggestion=this.editor.getSelection();suggestion&&(suggestion=this.editor.getBounds(suggestion.index))&&(popup.style.top=suggestion.top+suggestion.height+10+"px",popup.style.left=suggestion.left+"px")}}class AIWritingAssistant{constructor(){this.globalState=new GlobalState,this.api=new ProjectAPI,this.projectManager=new ProjectManager(this.globalState,this.api),this.chatSystem=new CompleteChatSystem(this.globalState,this.api,this.projectManager),this.saveStatus=null,this.activityTracker=null,this.modules={plan:null,write:null,edit:null},this.tabManager=null,this.init()}async init(){try{console.log("AIWritingAssistant.init() called"),document.body.classList.add("activity-plan"),console.log("Initializing modules..."),this.initializeModules(),console.log("Modules initialized"),console.log("Creating TabManager..."),console.log("TabManager available:",typeof TabManager),this.tabManager=new TabManager(this.globalState,this.projectManager),console.log("TabManager created:",this.tabManager),await this.waitForProjectManager(),this.setupActionButtons(),this.setupSubmission(),this.setupExport(),this.setupGlobalEvents(),this.setupChatResizer(),this.setupSaveStatusIndicator()}catch(error){console.error("Failed to initialize application:",error)}}async waitForProjectManager(){if(!this.projectManager.ready())return new Promise(resolve=>{this.globalState.subscribe("ready",resolve)})}initializeModules(){this.modules.plan=new PlanModule(this.globalState,this.projectManager,this.api),this.modules.write=new WriteModule(this.globalState,this.projectManager),this.modules.edit=new EditModule(this.globalState,this.projectManager,this.api),window.editModule=this.modules.edit,this.projectManager.registerModule("chat",this.chatSystem),this.versionHistory=new VersionHistoryManager(this.api),"undefined"!=typeof ActivityTracker&&window.researchflowId&&window.userId&&(this.activityTracker=new ActivityTracker(this.globalState,this.api,window.researchflowId,window.userId),this.activityTracker.setupUnloadHandler()),this.setupChatManagerConnection()}setupChatManagerConnection(){}setupActionButtons(){var saveExitBtn=document.getElementById("saveExitBtn");saveExitBtn&&saveExitBtn.addEventListener("click",()=>this.handleSaveAndExit())}setupSubmission(){let submitBtn=document.getElementById("submitAssignmentBtn");submitBtn&&("submitted"===window.submissionStatus&&this.setSubmittedState(submitBtn),submitBtn.addEventListener("click",async()=>{if(confirm("Are you sure you want to submit your assignment? You will not be able to make further changes."))try{submitBtn.disabled=!0,submitBtn.innerHTML="Submitting...",await this.projectManager.saveProject(),await this.api.submitProject()?(window.submissionStatus="submitted",this.setSubmittedState(submitBtn),this.modules.edit.showSuccessNotification("Assignment submitted successfully!")):(alert("Failed to submit assignment. Please try again."),submitBtn.disabled=!1,submitBtn.innerHTML=`
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            <span>Submit Assignment</span>
                        `)}catch(error){console.error("Submission error:",error),alert("An error occurred during submission."),submitBtn.disabled=!1,submitBtn.innerHTML="Submit Assignment"}}))}setupExport(){let exportBtn=document.getElementById("exportWorkBtn");if(exportBtn){let dropdown=document.createElement("div");dropdown.className="export-dropdown",dropdown.style.cssText="position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 8px 0; min-width: 150px; z-index: 1000; display: none;";var docxOption=document.createElement("a"),pdfOption=(docxOption.href="#",docxOption.className="export-option",docxOption.style.cssText="display: block; padding: 8px 16px; text-decoration: none; color: #333; cursor: pointer;",docxOption.innerHTML="📄 Export as DOCX",docxOption.addEventListener("click",e=>{e.preventDefault(),this.exportWork("docx"),dropdown.style.display="none"}),document.createElement("a"));pdfOption.href="#",pdfOption.className="export-option",pdfOption.style.cssText="display: block; padding: 8px 16px; text-decoration: none; color: #333; cursor: pointer; border-top: 1px solid #eee;",pdfOption.innerHTML="📑 Export as PDF",pdfOption.addEventListener("click",e=>{e.preventDefault(),this.exportWork("pdf"),dropdown.style.display="none"}),dropdown.appendChild(docxOption),dropdown.appendChild(pdfOption),document.body.appendChild(dropdown);exportBtn.addEventListener("click",e=>{e.stopPropagation(),e=exportBtn.getBoundingClientRect(),dropdown.style.top=e.bottom+5+"px",dropdown.style.left=e.left+"px",dropdown.style.display="none"===dropdown.style.display?"block":"none"}),document.addEventListener("click",e=>{exportBtn.contains(e.target)||dropdown.contains(e.target)||(dropdown.style.display="none")}),[docxOption,pdfOption].forEach(option=>{option.addEventListener("mouseenter",()=>{option.style.backgroundColor="#f5f5f5"}),option.addEventListener("mouseleave",()=>{option.style.backgroundColor="transparent"})})}}exportWork(format){this.projectManager.saveProject().then(()=>{var url=window.location.origin+window.location.pathname.substring(0,window.location.pathname.indexOf("/mod/researchflow/"))+"/mod/researchflow/export.php",params=new URLSearchParams({id:window.cmid||new URLSearchParams(window.location.search).get("id"),format:format});window.open(url+"?"+params.toString(),"_blank")}).catch(error=>{console.error("Error saving before export:",error);var error=window.location.origin+window.location.pathname.substring(0,window.location.pathname.indexOf("/mod/researchflow/"))+"/mod/researchflow/export.php",params=new URLSearchParams({id:window.cmid||new URLSearchParams(window.location.search).get("id"),format:format});window.open(error+"?"+params.toString(),"_blank")})}setSubmittedState(btn){btn.disabled=!0,btn.innerHTML=`
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span>Submitted</span>
        `,btn.style.backgroundColor="#6c757d",this.modules.write&&this.modules.write.editor&&this.modules.write.editor.disable(),this.modules.edit&&this.modules.edit.editor&&this.modules.edit.editor.disable(),document.querySelectorAll(".ai-tool-btn, #addIdeaBubble, #addCustomSection").forEach(el=>{el.disabled=!0,el.classList.add("disabled")})}async handleSaveAndExit(){await this._handleSaveOperation("saveExitBtn",!0)}async _handleSaveOperation(buttonId,shouldExit=!1){let button=document.getElementById(buttonId);if(button){let originalText=button.innerHTML;try{button.disabled=!0,button.innerHTML="Saving...",this.modules.write&&(this.modules.write.lastSaveWasManual=!0),this.modules.edit&&(this.modules.edit.lastSaveWasManual=!0),this.updateUIState(),await this.projectManager.saveProject()?(button.innerHTML="Saved!",setTimeout(()=>{shouldExit?this.handleExit():(button.innerHTML=originalText,button.disabled=!1)},shouldExit?1e3:2e3)):this._resetButton(button,originalText)}catch(error){console.error("Save error:",error),this._resetButton(button,originalText)}}}updateUIState(){}_resetButton(button,originalText){button.innerHTML="Save Failed",setTimeout(()=>{button.innerHTML=originalText,button.disabled=!1},3e3)}handleExit(){var courseUrl=window.location.href.split("/mod/researchflow/")[0]+"/course/view.php?id="+window.courseId;window.location.href=courseUrl}setupGlobalEvents(){this.globalState.subscribe("ready",state=>{this.restoreUIFromState(state)}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.projectManager.saveProject().catch(()=>{})}),window.addEventListener("beforeunload",()=>{this.projectManager.saveProject().catch(()=>{})})}setupChatResizer(){let resizer=document.getElementById("chatResizer"),chatSection=document.querySelector(".chat-section");if(resizer&&chatSection){var savedWidth=localStorage.getItem("researchflow_chat_width");savedWidth&&250<=(savedWidth=parseInt(savedWidth,10))&&savedWidth<=600&&document.documentElement.style.setProperty("--chat-width",savedWidth+"px");let isResizing=!1,startX=0,startWidth=0;var savedWidth=e=>{isResizing=!0,startX=e.clientX||e.touches?.[0]?.clientX,startWidth=chatSection.offsetWidth,document.body.style.cursor="col-resize",document.body.style.userSelect="none",resizer.style.background="var(--accent-primary)",e.preventDefault()},resize=e=>{var diff;isResizing&&(diff=(e.clientX||e.touches?.[0]?.clientX)-startX,diff=startWidth+diff,diff=Math.max(250,Math.min(600,diff)),document.documentElement.style.setProperty("--chat-width",diff+"px"),e.preventDefault())},stopResize=()=>{var currentWidth;isResizing&&(isResizing=!1,document.body.style.cursor="",document.body.style.userSelect="",resizer.style.background="",currentWidth=chatSection.offsetWidth,localStorage.setItem("researchflow_chat_width",currentWidth.toString()))};resizer.addEventListener("mousedown",savedWidth),document.addEventListener("mousemove",resize),document.addEventListener("mouseup",stopResize),resizer.addEventListener("touchstart",savedWidth),document.addEventListener("touchmove",resize),document.addEventListener("touchend",stopResize),console.log("Chat resizer initialized")}else console.warn("Chat resizer elements not found")}setupSaveStatusIndicator(){var el=document.createElement("div");el.id="saveStatusIndicator",el.style.cssText=`
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            box-shadow: var(--shadow-sm);
            opacity: 0.85;
            display: none;
            z-index: 9999;`,document.body.appendChild(el),this.saveStatus=el;let show=text=>{this.saveStatus&&(this.saveStatus.textContent=text,this.saveStatus.style.display="block")},hideLater=(ms=1500)=>{this.saveStatus&&setTimeout(()=>{this.saveStatus.style.display="none"},ms)};this.globalState.subscribe("autosave_saving",()=>show("Saving…")),this.globalState.subscribe("autosave_saved",()=>{show("Saved"),hideLater()}),this.globalState.subscribe("autosave_error",()=>{show("Save error"),hideLater(3e3)}),this.globalState.subscribe("autosave_offline",()=>show("Offline - will save later"))}restoreUIFromState(state){console.log("=== restoreUIFromState START ==="),console.log("Full state:",JSON.stringify(state,null,2)),console.log("Metadata:",state?.metadata),console.log("Goal value:",state?.metadata?.goal),console.log("Goal type:",typeof state?.metadata?.goal);var goalToRestore=null!=state?.metadata?.goal?String(state.metadata.goal):"";console.log("Goal to restore:",goalToRestore),state.metadata&&state.metadata.currentTab&&(this.tabManager.switchTab(state.metadata.currentTab),goalToRestore=document.getElementById("plan"))&&!goalToRestore.classList.contains("active")&&goalToRestore.classList.add("active"),console.log("Goal restoration skipped - goals are instructor-set and come from backend")}handleProjectUpdates(updatedProject){updatedProject.plan&&updatedProject.plan.ideas&&this.handleNewIdeas(updatedProject.plan.ideas),updatedProject.edit&&updatedProject.edit.suggestions&&this.handleNewSuggestions(updatedProject.edit.suggestions),updatedProject.write&&updatedProject.write.content&&this.handleContentUpdates(updatedProject.write.content)}handleNewIdeas(ideas){this.modules.plan&&Array.isArray(ideas)&&ideas.filter(idea=>idea.aiGenerated&&"brainstorm"===idea.location).forEach(idea=>{idea=new BubbleComponent(idea.content,idea.id,!0);this.modules.plan.bubbles.set(idea.id,idea),this.modules.plan.elements.ideaBubbles&&this.modules.plan.elements.ideaBubbles.appendChild(idea.element)})}handleNewSuggestions(suggestions){this.modules.edit&&Array.isArray(suggestions)&&suggestions.filter(suggestion=>suggestion.aiGenerated).forEach(suggestion=>{console.log("New AI suggestion:",suggestion)})}handleContentUpdates(content){this.modules.write&&this.modules.write.editor&&this.modules.write.editor.root.innerHTML!==content&&(this.modules.write.editor.root.innerHTML=content)}async saveProject(){try{await this.projectManager.saveProject()?(console.log("Project saved successfully"),this.showSaveFeedback("Project saved successfully!","success")):(console.error("Save project failed"),this.showSaveFeedback("Failed to save project","error"))}catch(error){console.error("Save project error:",error),this.showSaveFeedback("Error saving project: "+error.message,"error")}}showSaveFeedback(message,type){let feedback=document.createElement("div");feedback.className="save-feedback "+type,feedback.textContent=message,feedback.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            ${"success"===type?"background: #28a745;":"background: #dc3545;"}
        `,document.body.appendChild(feedback),setTimeout(()=>{feedback.style.animation="slideOut 0.3s ease-in",setTimeout(()=>{feedback.parentNode&&feedback.parentNode.removeChild(feedback)},300)},3e3)}}function initializeApp(){if(console.log("Initializing AI Writing Assistant..."),window.aiWritingAssistant)console.log("AI Writing Assistant already initialized, skipping...");else try{void 0===TabManager?console.error("TabManager not available"):(window.aiWritingAssistant=new AIWritingAssistant,console.log("AI Writing Assistant initialized successfully"))}catch(error){console.error("Failed to initialize application:",error),console.error("Error details:",error.stack)}}function waitForReady(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(initializeApp,100)}):setTimeout(initializeApp,100)}waitForReady(),window.checkVersions=function(){return window.versionInfo?(console.log("Plugin Version:",window.versionInfo.plugin_version),window.versionInfo):(console.log("Version information not available"),null)};class VersionHistoryManager{constructor(api){this.api=api,this.currentPhase="write",this.selectedVersion=null,this.elements={modal:document.getElementById("versionHistoryModal"),closeBtn:document.getElementById("versionModalClose"),openBtn:document.getElementById("versionHistoryBtn"),phaseTabs:document.querySelectorAll(".version-tab-btn"),versionList:document.getElementById("versionList"),previewBtn:document.getElementById("versionPreviewBtn"),restoreBtn:document.getElementById("versionRestoreBtn")},this.init()}init(){this.elements.modal&&(this.elements.openBtn&&this.elements.openBtn.addEventListener("click",()=>this.open()),this.elements.closeBtn&&this.elements.closeBtn.addEventListener("click",()=>this.close()),this.elements.modal&&this.elements.modal.addEventListener("click",e=>{e.target===this.elements.modal&&this.close()}),this.elements.phaseTabs.forEach(btn=>{btn.addEventListener("click",()=>{this.switchPhase(btn.dataset.phase)})}),this.elements.previewBtn&&this.elements.previewBtn.addEventListener("click",()=>this.previewVersion()),this.elements.restoreBtn)&&this.elements.restoreBtn.addEventListener("click",()=>this.restoreVersion())}async open(){this.elements.modal&&(this.elements.modal.style.display="flex",await this.loadVersions(this.currentPhase))}close(){this.elements.modal&&(this.elements.modal.style.display="none",this.selectedVersion=null,this.updateButtons())}async switchPhase(phase){this.currentPhase=phase,this.elements.phaseTabs.forEach(btn=>{btn.classList.toggle("active",btn.dataset.phase===phase)}),this.selectedVersion=null,await this.loadVersions(phase),this.updateButtons()}async loadVersions(phase){if(this.elements.versionList){this.elements.versionList.innerHTML='<div class="version-loading">Loading versions...</div>';try{var listHtml,versions=await this.api.getVersionHistory(phase);0===versions.length?this.elements.versionList.innerHTML='<div class="version-empty">No version history yet</div>':(listHtml=versions.map(v=>{var dateStr=new Date(1e3*v.created_at).toLocaleString();return`
                    <div class="version-item ${this.selectedVersion===v.version_number?"selected":""}" data-version="${v.version_number}">
                        <div class="version-number">Version ${v.version_number}</div>
                        <div class="version-summary">${v.change_summary||"Auto-saved"}</div>
                        <div class="version-meta">
                            <span class="version-date">${dateStr}</span>
                            <span class="version-words">${v.word_count||0} words</span>
                        </div>
                    </div>
                `}).join(""),this.elements.versionList.innerHTML=listHtml,this.elements.versionList.querySelectorAll(".version-item").forEach(item=>{item.addEventListener("click",()=>{this.elements.versionList.querySelectorAll(".version-item").forEach(i=>i.classList.remove("selected")),item.classList.add("selected"),this.selectedVersion=parseInt(item.dataset.version),this.updateButtons()})}))}catch(e){console.error("Failed to load versions:",e),this.elements.versionList.innerHTML='<div class="version-error">Failed to load versions</div>'}}}updateButtons(){var hasSelection=null!==this.selectedVersion;this.elements.previewBtn&&(this.elements.previewBtn.disabled=!hasSelection),this.elements.restoreBtn&&(this.elements.restoreBtn.disabled=!hasSelection)}async previewVersion(){if(this.selectedVersion)try{var version=await this.api.getVersion(this.currentPhase,this.selectedVersion);version&&window.open("","_blank").document.write(`
                    <html>
                        <head><title>Version ${version.version_number} Preview</title></head>
                        <body style="padding: 20px; font-family: Arial;">
                            <h2>Version ${version.version_number} Preview</h2>
                            <p><strong>Saved:</strong> ${new Date(1e3*version.created_at).toLocaleString()}</p>
                            <p><strong>Summary:</strong> ${version.change_summary||"Auto-saved"}</p>
                            <p><strong>Words:</strong> ${version.word_count||0}</p>
                            <hr>
                            <div>${version.content}</div>
                        </body>
                    </html>
                `)}catch(e){console.error("Failed to preview version:",e),alert("Failed to preview version")}}async restoreVersion(){if(this.selectedVersion&&confirm(`Restore Version ${this.selectedVersion}? This will replace your current content.`))try{var module,phaseData;await this.api.restoreVersion(this.currentPhase,this.selectedVersion)?(alert("Version restored successfully! Refreshing content..."),window.aiWritingAssistant&&window.aiWritingAssistant.projectManager&&(await window.aiWritingAssistant.projectManager.loadProject(),module="write"===this.currentPhase?window.aiWritingAssistant.modules.write:window.aiWritingAssistant.modules.edit)&&module.editor&&(phaseData=window.aiWritingAssistant.globalState.getState()[this.currentPhase])&&phaseData.content&&(module.editor.root.innerHTML=phaseData.content),this.close()):alert("Failed to restore version")}catch(e){console.error("Failed to restore version:",e),alert("Failed to restore version")}}}