/*! writeassistdev - v1.0.0 - 2025-11-03 */
window.versionInfo&&console.log("Utils.js module loaded");let DEFAULT_PROJECT_SCHEMA={metadata:{title:"",description:"",goal:"",created:null,modified:null,version:"1.0"},plan:{templateName:"",templateDisplayName:"",ideas:[],outline:[],customSectionTitles:{},customSectionDescriptions:{}},write:{content:"",wordCount:0},edit:{content:"",suggestions:[]},chatHistory:[],ui:{currentTab:"plan"}};function createElement(tag,className,textContent=""){tag=document.createElement(tag);return className&&(tag.className=className),textContent&&(tag.textContent=textContent),tag}function generateId(){return Date.now().toString()+Math.random().toString(36).substr(2,9)}function formatDate(date){return new Date(date).toISOString()}function calculateWordCount(text){return text.trim().split(/\s+/).filter(word=>0<word.length).length}function deepClone(obj){return JSON.parse(JSON.stringify(obj))}function mergeObjects(target,source){return{...target,...source}}function validateRequiredFields(obj,requiredFields){requiredFields=requiredFields.filter(field=>!obj[field]);if(0<requiredFields.length)throw new Error("Missing required fields: "+requiredFields.join(", "));return!0}function sanitizeHtml(html){var div=document.createElement("div");return div.innerHTML=html,div.textContent||div.innerText||""}function truncateText(text,maxLength=100){return text.length<=maxLength?text:text.substr(0,maxLength)+"..."}function isElementInViewport(element){element=element.getBoundingClientRect();return 0<=element.top&&0<=element.left&&element.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&element.right<=(window.innerWidth||document.documentElement.clientWidth)}function scrollToElement(element,offset=0){element=element.getBoundingClientRect().top+window.pageYOffset-offset;window.scrollTo({top:element,behavior:"smooth"})}function throttle(func,limit){let inThrottle;return function(){var args=arguments;inThrottle||(func.apply(this,args),inThrottle=!0,setTimeout(()=>inThrottle=!1,limit))}}window.versionInfo&&console.log("API.js module loaded");class ProjectAPI{constructor(){this.ajaxUrl=window.ajaxUrl,this.apiEndpoint=window.apiEndpoint,this.sesskey=window.sesskey,this.cmId=window.cmId,null===this.apiEndpoint||""===this.apiEndpoint||"null"===this.apiEndpoint?(console.warn("⚠️ API Endpoint is not configured. AI features will not be available."),console.warn("Please configure the API endpoint in Site Administration → Plugins → Activity modules → AI Writing Assistant"),this.apiEndpoint=null):console.log("API Endpoint configured:",this.apiEndpoint),this.ajaxUrl&&this.sesskey&&this.cmId||console.error("Missing required API configuration")}async loadProject(){try{var result,formData=new URLSearchParams,response=(formData.append("action","load_project"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success?result.project:null;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(error){return console.error("Failed to load project:",error),null}}async loadChatHistoryOnly(){try{var result,formData=new URLSearchParams,response=(formData.append("action","load_chat_history_only"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success?result.chatHistory:[];throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(error){return console.error("Failed to load chat history:",error),[]}}async loadChatHistoryPage(limit=50,beforeTimestamp=null,timeoutMs=0){try{var formData=new URLSearchParams;formData.append("action","load_chat_history_only"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("limit",String(limit)),null!==beforeTimestamp&&formData.append("before",String(beforeTimestamp));let controller=0<timeoutMs?new AbortController:null,timeoutId=null;controller&&(timeoutId=setTimeout(()=>controller.abort(),timeoutMs));var response=await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData,signal:controller?controller.signal:void 0});if(timeoutId&&clearTimeout(timeoutId),!response.ok)throw new Error(`HTTP ${response.status}: `+response.statusText);var result=await response.json();let filtered=Array.isArray(result.chatHistory)?result.chatHistory:[];return filtered=(filtered=null!==beforeTimestamp?filtered.filter(m=>(m.timestamp||0)<beforeTimestamp):filtered).length>limit?filtered.slice(-limit):filtered}catch(e){return console.error("Failed to load chat history page:",e),[]}}async appendChatMessage(sessionId,role,content,timestamp=Math.floor(Date.now()/1e3)){try{var result,formData=new URLSearchParams,response=(formData.append("action","append_message"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("session_id",sessionId||"default"),formData.append("role",role),formData.append("content",content),formData.append("timestamp",String(timestamp)),console.log("appendChatMessage sending:",{sessionId:sessionId,role:role,contentLength:content.length,timestamp:timestamp}),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success||console.error("appendChatMessage returned success=false:",result),!!result.success;var errorText=await response.text();console.error("appendChatMessage HTTP error:",response.status,errorText);try{var errorJson=JSON.parse(errorText);console.error("appendChatMessage error details:",errorJson)}catch(e){}throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to append chat message:",e),!1}}async deleteIdea(ideaOrId){try{var formData=new URLSearchParams;if(formData.append("action","delete_idea"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),"number"==typeof ideaOrId||"string"==typeof ideaOrId&&/^\d+$/.test(ideaOrId))formData.append("idea_id",String(ideaOrId));else{if(!ideaOrId||"object"!=typeof ideaOrId)throw new Error("Invalid deleteIdea payload");var{content="",location="brainstorm",sectionId=""}=ideaOrId;formData.append("content",content),formData.append("location",location),sectionId&&formData.append("sectionId",sectionId)}var response=await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData});if(response.ok)return!!(await response.json()).success;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to delete idea:",e),!1}}async saveProject(projectData){try{projectData.metadata&&(projectData.metadata.modified=formatDate(new Date));var formData=new URLSearchParams,response=(formData.append("action","save_project"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("project_data",JSON.stringify(projectData)),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(!response.ok)throw new Error(`HTTP ${response.status}: `+response.statusText);var result=await response.json();if(result.success)return!0===result.success;throw console.error("Save failed:",result.error||"Unknown error"),new Error(result.error||"Save failed")}catch(error){return console.error("Failed to save project:",error),!1}}async deleteProject(){try{var formData=new URLSearchParams,response=(formData.append("action","delete_project"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return!0===(await response.json()).success;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(error){return console.error("Failed to delete project:",error),!1}}async loadTemplate(templateId){try{if(window.templateData&&window.templateData.sections)return console.log("Using embedded template data"),window.templateData;var templateUrl=window.location.origin+`/mod/writeassistdev/data/templates/${templateId}.json`,response=await fetch(templateUrl,{cache:"no-store",credentials:"same-origin"});if(response.ok)return await response.json();throw new Error("Failed to load template: "+response.status)}catch(error){return console.error("Failed to load template:",error),{name:"Empty Template",sections:[]}}}async testConnection(){try{var result=await(await fetch(this.ajaxUrl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin",body:new URLSearchParams({action:"test",cmid:this.cmId,sesskey:this.sesskey})})).json();return console.log("AJAX test result:",result),result.success}catch(error){return console.error("AJAX test failed:",error),!1}}async sendChatMessage(userMessage,currentProject=null){if(!this.apiEndpoint||null===this.apiEndpoint||""===this.apiEndpoint||"null"===this.apiEndpoint)return console.error("API endpoint is not configured"),{assistantReply:"The AI Writing Assistant API endpoint has not been configured. Please contact your site administrator to configure the API endpoint in Site Administration → Plugins → Activity modules → AI Writing Assistant.",updatedProject:null};var fullUrl=this.apiEndpoint+"/api/chat",currentProject=this.sanitizeProjectForAPI(currentProject);try{var requestBody={userInput:userMessage,currentProject:currentProject};let jsonString;try{jsonString=JSON.stringify(requestBody)}catch(serializeError){return console.error("Failed to serialize request data:",serializeError),{assistantReply:"Error: Could not prepare request data for AI service.",updatedProject:null}}var result,response=await fetch(fullUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:jsonString}),contentType=response.headers.get("content-type");return contentType&&contentType.includes("application/json")?(result=await response.json(),response.ok?{assistantReply:result.assistantReply||null,updatedProject:result.project||null}:{assistantReply:result.assistantReply||"API Error: "+response.status,updatedProject:null}):{assistantReply:`API Error: Received ${response.status} ${response.statusText}. Expected JSON but got `+contentType,updatedProject:null}}catch(error){return console.error("Chat message failed:",error),{assistantReply:null,updatedProject:null}}}sanitizeProjectForAPI(project){if(!project)return null;project=JSON.parse(JSON.stringify(project));let htmlToText=html=>{var tempDiv;return html&&"string"==typeof html?((tempDiv=document.createElement("div")).innerHTML=html,tempDiv.textContent||tempDiv.innerText||""):html};if(project.write&&project.write.content&&(project.write.content=htmlToText(project.write.content)),project.edit&&project.edit.content&&(project.edit.content=htmlToText(project.edit.content)),project.plan&&project.plan.ideas){let ideasArray;ideasArray=Array.isArray(project.plan.ideas)?project.plan.ideas:"object"==typeof project.plan.ideas&&null!==project.plan.ideas?Object.values(project.plan.ideas):[],project.plan.ideas=ideasArray.map(idea=>({...idea,content:htmlToText(idea.content)}))}project.plan&&project.plan.outline&&(project.plan.outline=project.plan.outline.map(section=>({...section,title:htmlToText(section.title),description:htmlToText(section.description),bubbles:section.bubbles?section.bubbles.map(bubble=>({...bubble,content:htmlToText(bubble.content)})):[]})));let cleanObject=obj=>{if(null===obj||"object"!=typeof obj)return obj;if(Array.isArray(obj))return obj.map(cleanObject);var key,value,cleaned={};for([key,value]of Object.entries(obj))"function"==typeof value||value instanceof HTMLElement||(cleaned[key]=cleanObject(value));return cleaned};return cleanObject(project)}mergeUpdatedProject(currentProject,updatedProject){if(!updatedProject)return currentProject;let merged=JSON.parse(JSON.stringify(currentProject));return Object.keys(updatedProject).forEach(key=>{if("chatHistory"===key){if(Array.isArray(updatedProject[key])){let existingMessages=merged[key]||[];updatedProject[key].forEach(newMsg=>{existingMessages.some(existingMsg=>existingMsg.role===newMsg.role&&existingMsg.content===newMsg.content&&existingMsg.timestamp===newMsg.timestamp)||existingMessages.push(newMsg)}),merged[key]=existingMessages}}else"object"==typeof updatedProject[key]&&null!==updatedProject[key]?merged[key]=this.deepMerge(merged[key]||{},updatedProject[key]):merged[key]=updatedProject[key]}),merged}deepMerge(target,source){var key,result={...target};for(key in source)source[key]&&"object"==typeof source[key]&&!Array.isArray(source[key])?result[key]=this.deepMerge(target[key]||{},source[key]):result[key]=source[key];return result}async getVersionHistory(phase){try{var result,formData=new URLSearchParams,response=(formData.append("action","get_version_history"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("phase",phase),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success?result.versions:[];throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to get version history:",e),[]}}async getVersion(phase,versionNumber){try{var result,formData=new URLSearchParams,response=(formData.append("action","get_version"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("phase",phase),formData.append("version_number",String(versionNumber)),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return(result=await response.json()).success?result.version:null;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to get version:",e),null}}async restoreVersion(phase,versionNumber){try{var formData=new URLSearchParams,response=(formData.append("action","restore_version"),formData.append("cmid",this.cmId),formData.append("sesskey",this.sesskey),formData.append("phase",phase),formData.append("version_number",String(versionNumber)),await fetch(this.ajaxUrl,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/x-www-form-urlencoded"},credentials:"same-origin",body:formData}));if(response.ok)return!0===(await response.json()).success;throw new Error(`HTTP ${response.status}: `+response.statusText)}catch(e){return console.error("Failed to restore version:",e),!1}}async checkAIHealth(){if(!this.apiEndpoint||null===this.apiEndpoint||""===this.apiEndpoint||"null"===this.apiEndpoint)return{available:!1,message:"AI endpoint not configured. Please contact your site administrator."};var cleanEndpoint=this.apiEndpoint;try{var response=await fetch(cleanEndpoint+"/health",{method:"GET",timeout:5e3});return{available:response.ok,message:response.ok?"AI endpoint is available":"AI endpoint not responding"}}catch(error){return{available:!1,message:"AI endpoint error: "+error.message}}}}window.versionInfo&&console.log("DOM.js module loaded");let Size=Quill.import("attributors/style/size"),quillConfig=(Size.whitelist=["8pt","10pt","12pt","14pt","16pt","18pt","24pt","36pt"],Quill.register(Size,!0),{theme:"snow",modules:{toolbar:[["bold","italic","underline","strike"],["blockquote","code-block"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{size:["8pt","10pt","12pt","14pt","16pt","18pt","24pt","36pt"]}],[{header:[1,2,3,4,5,6,!1]}],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],["clean"]]}});class DOMManager{constructor(){this.elements={},this.eventListeners=new Map}getElement(id,selector=null){return this.elements[id]||=selector?document.querySelector(selector):document.getElementById(id)}clearCache(){this.elements={}}addEventListener(element,event,handler,options={}){var key,handlers;element&&(key=`${element.id||"unknown"}_`+event,(handlers=this.eventListeners.get(key)||[]).includes(handler)||(handlers.push(handler),this.eventListeners.set(key,handlers),element.addEventListener(event,handler,options)))}removeEventListeners(element,event=null){var key=event?`${element.id||"unknown"}_`+event:element.id||"unknown",handlers=this.eventListeners.get(key);handlers&&(handlers.forEach(handler=>element.removeEventListener(event,handler)),this.eventListeners.delete(key))}cleanup(){this.eventListeners.forEach((handlers,key)=>{let[elementId,event]=key.split("_"),element=this.getElement(elementId);handlers.forEach(handler=>element?.removeEventListener(event,handler))}),this.eventListeners.clear()}}class BubbleComponent{constructor(content=" ",id=null,aiGenerated=!1){this.id=id||generateId(),this.content=content,this.aiGenerated=aiGenerated,this.element=this.createBubble()}createBubble(){let bubble=createElement("div","idea-bubble"),contentDiv=(bubble.dataset.id=this.id,this.aiGenerated&&(bubble.classList.add("ai-generated"),bubble.dataset.aiGenerated="true"),createElement("div","bubble-content",this.content));var deleteBtn=createElement("button","delete-bubble-btn","×");return deleteBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.delete()}),bubble.appendChild(contentDiv),bubble.appendChild(deleteBtn),this.aiGenerated?(deleteBtn=createElement("span","ai-label","AI"),contentDiv.appendChild(deleteBtn)):(contentDiv.contentEditable=!0,contentDiv.addEventListener("input",()=>{this.content=contentDiv.textContent,bubble.dispatchEvent(new CustomEvent("bubbleContentChanged",{detail:{bubbleId:this.id,content:this.content},bubbles:!0,composed:!0}))})),bubble}setContent(content){this.content=content;var contentDiv=this.element.querySelector(".bubble-content");contentDiv&&(contentDiv.textContent=content)}getContent(){var contentDiv=this.element.querySelector(".bubble-content");return contentDiv?contentDiv.textContent:this.content}setLocation(location,sectionId=null){this.location=location,this.sectionId=sectionId,this.element.dataset.location=location,sectionId&&(this.element.dataset.sectionId=sectionId)}delete(){this.element.dispatchEvent(new CustomEvent("bubbleDeleted",{detail:{bubbleId:this.id},bubbles:!0,composed:!0}))}destroy(){this.element.parentNode&&this.element.parentNode.removeChild(this.element)}}class SectionComponent{constructor(sectionData){this.id=sectionData.id,this.title=sectionData.title,this.description=sectionData.description,this.element=this.createSection()}createSection(){var sectionDiv=createElement("div","template-section"),sectionHeader=(sectionDiv.dataset.sectionId=this.id,createElement("div","section-header")),sectionTitle=createElement("h4","section-title",this.title),sectionHeader=(sectionTitle.contentEditable=!0,sectionTitle.dataset.sectionId=this.id,sectionHeader.appendChild(sectionTitle),sectionDiv.appendChild(sectionHeader),this.description&&(sectionTitle=createElement("p","section-description",this.description),sectionDiv.appendChild(sectionTitle)),createElement("div","outline-container outline-dropzone")),sectionTitle=(sectionHeader.dataset.sectionId=this.id,sectionHeader.classList.add("empty"),createElement("div","dropzone-placeholder","Drop ideas here to create outline items"));return sectionTitle.draggable=!1,sectionHeader.appendChild(sectionTitle),sectionDiv.appendChild(sectionHeader),sectionDiv}addBubble(bubble){var outlineContainer=this.element.querySelector(".outline-container");outlineContainer&&(outlineContainer.classList.contains("empty")&&(outlineContainer.classList.remove("empty"),outlineContainer.innerHTML=""),outlineContainer.appendChild(bubble.element))}removeBubble(bubbleId){var placeholder,bubbleId=this.element.querySelector(`[data-id="${bubbleId}"]`);bubbleId&&(bubbleId.remove(),bubbleId=this.element.querySelector(".outline-container"))&&0===bubbleId.children.length&&(bubbleId.classList.add("empty"),(placeholder=createElement("div","dropzone-placeholder","Drop ideas here to create outline items")).draggable=!1,bubbleId.appendChild(placeholder))}getBubbles(){var outlineContainer=this.element.querySelector(".outline-container");return outlineContainer?Array.from(outlineContainer.querySelectorAll(".idea-bubble")).map(bubble=>({id:bubble.dataset.id,content:bubble.querySelector(".bubble-content").textContent,aiGenerated:"true"===bubble.dataset.aiGenerated})):[]}setTitle(title){this.title=title;var titleElement=this.element.querySelector(".section-title");titleElement&&(titleElement.textContent=title)}destroy(){this.element.parentNode&&this.element.parentNode.removeChild(this.element)}}class TabManager{constructor(globalState){console.log(">>> TabManager constructor called - CACHE REFRESH TEST"),this.globalState=globalState,this.currentTab="plan",this.init(),console.log(">>> TabManager initialized - CACHE REFRESH TEST")}init(){this.setupTabs()}setupTabs(){console.log("=== Setting up tabs ===");var tabButtons=document.querySelectorAll(".tab-btn");console.log("Found",tabButtons.length,"tab buttons"),tabButtons.forEach(button=>{let tabId=button.getAttribute("data-tab");console.log("Setting up tab:",tabId,"Button:",button),button.addEventListener("click",e=>{e.preventDefault(),console.log("Tab clicked:",tabId),this.switchTab(tabId)})}),this.switchTab("plan"),console.log("=== Tab setup complete ===")}switchTab(tabId){console.log("=== Switching to tab:",tabId,"===");var allTabButtons=document.querySelectorAll(".tab-btn"),allTabButtons=(console.log("Found",allTabButtons.length,"tab buttons"),allTabButtons.forEach(btn=>{console.log("Removing active from:",btn.dataset.tab,"Classes:",btn.classList.toString()),btn.classList.remove("active")}),document.querySelector(`[data-tab="${tabId}"]`));allTabButtons?(allTabButtons.classList.add("active"),console.log("Added active to:",tabId,"Classes:",allTabButtons.classList.toString())):console.error("Could not find button for tab:",tabId);document.querySelectorAll(".tab-content").forEach(content=>{content.classList.remove("active")});allTabButtons=document.getElementById(tabId);allTabButtons&&allTabButtons.classList.add("active"),document.body.className=document.body.className.replace(/activity-\w+/g,""),document.body.classList.add("activity-"+tabId),console.log("Updated body class to:",document.body.className),"write"===tabId&&this.populateWriteOutline(),"plan"===tabId&&this.restoreGoalFromState(),this.currentTab=tabId,console.log("=== Tab switch complete ===")}restoreGoalFromState(){var currentValue,goalInput=document.getElementById("assignmentGoal");goalInput&&((currentValue=goalInput.value.trim())?console.log("TabManager: Goal input has current value, preserving:",currentValue):(currentValue=this.globalState.getState())&&currentValue.metadata&&currentValue.metadata.goal&&goalInput.value!==currentValue.metadata.goal&&(console.log("TabManager: Restoring goal from state (input was empty):",currentValue.metadata.goal),goalInput.value=currentValue.metadata.goal,console.log("TabManager: Goal restored, current value:",goalInput.value)))}populateWriteOutline(){let outlineSidebar=document.getElementById("outlineSidebar");if(outlineSidebar){var state=this.globalState.getState();if(console.log("DEBUG: populateWriteOutline - state:",state),console.log("DEBUG: populateWriteOutline - plan.ideas:",state?.plan?.ideas),state&&state.plan&&state.plan.ideas){let ideasArray;if(Array.isArray(state.plan.ideas))ideasArray=state.plan.ideas;else{if("object"!=typeof state.plan.ideas||null===state.plan.ideas)return void console.warn("Invalid ideas format:",typeof state.plan.ideas);ideasArray=Object.values(state.plan.ideas),console.log("DEBUG: Converted ideas object to array:",ideasArray)}outlineSidebar.innerHTML="<h3>My Outline</h3>";var noOutline,outlineBubbles=ideasArray.filter(bubble=>"outline"===bubble.location&&bubble.sectionId);if(console.log("DEBUG: outlineBubbles found:",outlineBubbles.length,outlineBubbles),0===outlineBubbles.length)(noOutline=document.createElement("p")).textContent="No outline items yet. Go back to Plan & Organize to add ideas to your outline.",noOutline.style.color="var(--text-secondary)",noOutline.style.fontStyle="italic",noOutline.style.padding="var(--spacing-md)",outlineSidebar.appendChild(noOutline);else{let sectionsMap=new Map;this.getOutlineSections(state).forEach(section=>{sectionsMap.set(section.id,{title:section.title,bubbles:[]})}),outlineBubbles.forEach(bubble=>{bubble.sectionId&&sectionsMap.has(bubble.sectionId)&&sectionsMap.get(bubble.sectionId).bubbles.push(bubble)}),sectionsMap.forEach((sectionData,sectionId)=>{if(0<sectionData.bubbles.length){var sectionDiv=document.createElement("div"),sectionTitle=document.createElement("h4");sectionTitle.textContent=sectionData.title,sectionDiv.appendChild(sectionTitle);let bubbleList=document.createElement("ul");sectionData.bubbles.forEach(bubble=>{var bubbleItem=document.createElement("li"),bubble=bubble.content.trim();bubbleItem.textContent=80<bubble.length?bubble.substring(0,80)+"...":bubble,bubbleItem.title=bubble,bubbleList.appendChild(bubbleItem)}),sectionDiv.appendChild(bubbleList),outlineSidebar.appendChild(sectionDiv)}})}}else console.warn("No plan data available")}else console.warn("Outline sidebar not found")}getOutlineSections(state){if(window.aiWritingAssistant&&window.aiWritingAssistant.modules.plan){var planModule=window.aiWritingAssistant.modules.plan;if(planModule.sections){let sections=[];return planModule.sections.forEach((section,id)=>{sections.push({id:section.id,title:section.title,description:section.description})}),sections}}return window.templateData&&window.templateData.sections?window.templateData.sections:[{id:"introduction",title:"Introduction"},{id:"main-arguments",title:"Main Arguments"},{id:"conclusion",title:"Conclusion"}]}getCurrentTab(){return this.currentTab}}class ChatManager{constructor(globalState){this.globalState=globalState,this.messages=[],this.elements={chatMessages:document.getElementById("chatMessages"),userInput:document.getElementById("userInput"),sendButton:document.getElementById("sendMessage"),regenerateGlobalBtn:document.getElementById("regenerateGlobalBtn")},this.elements.chatMessages&&this.elements.userInput&&this.elements.sendButton||console.warn("ChatManager: Some required elements not found"),this.init()}init(){this.setupEventListeners(),this.subscribeToGlobalState()}subscribeToGlobalState(){this.globalState&&this.globalState.subscribe("stateChanged",state=>{this.syncWithGlobalState(state)})}syncWithGlobalState(state){if(state.chatHistory&&Array.isArray(state.chatHistory)&&state.chatHistory.length>this.messages.length){console.log("ChatManager: Adding new messages, current:",this.messages.length,"total:",state.chatHistory.length);for(let i=this.messages.length;i<state.chatHistory.length;i++){var msg=state.chatHistory[i];this.messages.push(msg),this.renderMessage(msg)}}}setupEventListeners(){this.removeEventListeners(),this.elements.sendButton&&(this.sendButtonHandler=()=>this.sendMessage(),this.elements.sendButton.addEventListener("click",this.sendButtonHandler)),this.elements.userInput&&(this.userInputHandler=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())},this.elements.userInput.addEventListener("keypress",this.userInputHandler)),this.elements.regenerateGlobalBtn&&(this.regenerateButtonHandler=()=>this.regenerateLastMessage(),this.elements.regenerateGlobalBtn.addEventListener("click",this.regenerateButtonHandler))}removeEventListeners(){this.elements.sendButton&&this.sendButtonHandler&&this.elements.sendButton.removeEventListener("click",this.sendButtonHandler),this.elements.userInput&&this.userInputHandler&&this.elements.userInput.removeEventListener("keypress",this.userInputHandler),this.elements.regenerateGlobalBtn&&this.regenerateButtonHandler&&this.elements.regenerateGlobalBtn.removeEventListener("click",this.regenerateButtonHandler)}addMessage(role,content,timestamp=0){console.warn("ChatManager.addMessage() is deprecated. Messages are now handled by global state sync.")}renderMessage(message){var messageDiv;this.elements.chatMessages?(messageDiv=createElement("div","message "+message.role),message=createElement("div","message-content",message.content),messageDiv.appendChild(message),this.elements.chatMessages.appendChild(messageDiv),this.elements.chatMessages.scrollTop=this.elements.chatMessages.scrollHeight):console.error("ChatManager: chatMessages element not found, cannot render message")}sendMessage(){var message;this.elements.userInput&&(message=this.elements.userInput.value.trim())&&(console.log("ChatManager: Sending message:",message),this.elements.userInput.value="",document.dispatchEvent(new CustomEvent("messageSent",{detail:{message:message,role:"user"}})))}regenerateLastMessage(){var last,prev;this.messages.length<2||(last=this.messages[this.messages.length-1],prev=this.messages[this.messages.length-2],"assistant"===last.role&&"user"===prev.role&&(this.messages.pop(),this.elements.chatMessages.lastChild&&this.elements.chatMessages.removeChild(this.elements.chatMessages.lastChild),document.dispatchEvent(new CustomEvent("regenerateRequested",{detail:{message:prev.content}}))))}updateRegenerateButton(){var last;this.elements.regenerateGlobalBtn&&(last=this.messages[this.messages.length-1],this.elements.regenerateGlobalBtn.disabled=!(last&&"assistant"===last.role))}loadMessages(messages){this.elements.chatMessages||(console.warn("ChatManager: Reinitializing elements as chatMessages was not found"),this.elements.chatMessages=document.getElementById("chatMessages")),this.messages=[],this.elements.chatMessages?(this.elements.chatMessages.innerHTML="",this.updateRegenerateButton(),messages&&Array.isArray(messages)?messages.forEach((msg,index)=>{this.addMessage(msg.role,msg.content,msg.timestamp)}):console.warn("ChatManager: Invalid messages array")):console.error("ChatManager: chatMessages element still not found after reinit, cannot clear messages")}getMessages(){return[...this.messages]}collectData(){return{chatHistory:this.getMessages()}}}class ChatTabManager{constructor(chatSystem){this.chatSystem=chatSystem,this.chats=new Map,this.currentChatId="chat-1",this.chatCounter=1,this.elements={chatTabs:document.querySelector(".chat-tabs"),newChatBtn:document.getElementById("newChatBtn"),chatContent:document.querySelector(".chat-content"),clearChatBtn:document.getElementById("clearChatBtn")},this.init()}init(){this.currentChatId="chat-1",this.setupEventListeners(),setTimeout(()=>{this.switchToChat("chat-1")},100)}setupEventListeners(){this.elements.newChatBtn&&this.elements.newChatBtn.addEventListener("click",()=>this.createNewChat()),this.elements.chatTabs&&this.elements.chatTabs.addEventListener("click",e=>{if(e.target.classList.contains("chat-tab")){var chatId=e.target.dataset.chatId;this.switchToChat(chatId)}else if(e.target.classList.contains("chat-tab-close")){let chatId=e.target.dataset.chatId;this.deleteChat(chatId)}}),this.elements.clearChatBtn&&this.elements.clearChatBtn.addEventListener("click",()=>this.clearCurrentChat())}createNewChat(){this.chatCounter++;var chatId="chat-"+this.chatCounter,chatTitle="Chat "+this.chatCounter;this.createChat(chatId,chatTitle),this.switchToChat(chatId)}createChat(chatId,title){if("chat-1"===chatId){let chatInstance={id:chatId,title:title,messages:new Map,tab:document.querySelector(`[data-chat-id="${chatId}"]`),messagesContainer:document.getElementById("chatMessages")};return this.chats.set(chatId,chatInstance),chatInstance}var chatTab=document.createElement("div"),chatMessages=(chatTab.className="chat-tab",chatTab.dataset.chatId=chatId,chatTab.innerHTML=`
            <span class="chat-tab-title">${title}</span>
            <button class="chat-tab-close" data-chat-id="${chatId}" title="Close chat" aria-label="Close chat">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor">
                    <path d="M9 3L3 9M3 3l6 6" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
            </button>
        `,this.elements.chatTabs.insertBefore(chatTab,this.elements.newChatBtn),document.createElement("div"));chatMessages.className="chat-messages",chatMessages.id="chatMessages-"+chatId,chatMessages.dataset.chatId=chatId,this.elements.chatContent.insertBefore(chatMessages,this.elements.chatContent.querySelector(".chat-actions-row"));let chatInstance={id:chatId,title:title,messages:new Map,tab:chatTab,messagesContainer:chatMessages};return this.chats.set(chatId,chatInstance),chatInstance}switchToChat(chatId){if(!this.chats.has(chatId)){if("chat-1"!==chatId)return;this.createChat(chatId,"New Chat")}document.querySelectorAll(".chat-tab").forEach(tab=>{tab.classList.remove("active")});var activeTab=document.querySelector(`[data-chat-id="${chatId}"]`),activeTab=(activeTab&&activeTab.classList.add("active"),document.querySelectorAll(".chat-messages").forEach(container=>{container.classList.remove("active")}),"chat-1"===chatId?document.getElementById("chatMessages"):document.getElementById("chatMessages-"+chatId));activeTab&&activeTab.classList.add("active"),this.currentChatId=chatId,this.chatSystem&&(this.chatSystem.currentChatId=chatId,this.chatSystem.messages=this.chats.get(chatId).messages,this.chatSystem.elements)&&(this.chatSystem.elements.chatMessages=activeTab),console.log("Switched to chat: "+chatId)}deleteChat(chatId){var chat;this.chats.has(chatId)&&(this.chats.size<=1?console.log("Cannot delete the last chat"):((chat=this.chats.get(chatId)).tab.remove(),chat.messagesContainer.remove(),this.chats.delete(chatId),this.currentChatId===chatId&&0<(chat=Array.from(this.chats.keys())).length&&this.switchToChat(chat[0]),console.log("Deleted chat: "+chatId)))}clearCurrentChat(){var currentChat=this.chats.get(this.currentChatId);currentChat&&(currentChat.messages.clear(),currentChat.messagesContainer.innerHTML="",this.chatSystem.messages=currentChat.messages,console.log("Cleared chat: "+this.currentChatId))}updateChatTitle(chatId,newTitle){var chatId=this.chats.get(chatId);chatId&&(chatId.title=newTitle,chatId=chatId.tab.querySelector(".chat-tab-title"))&&(chatId.textContent=newTitle)}}class CompleteChatSystem{constructor(globalState,api,projectManager){this.globalState=globalState,this.api=api,this.projectManager=projectManager,this.currentChatId="chat-1",this.messages=new Map,this.isInitialized=!1,this.isProcessing=!1,this.eventHandlers=new Map,this.messageQueue=[],this.retryCount=0,this.maxRetries=3,this.chatHistoryLoaded=!1,this.isLoadingHistory=!1,this.allChatMessages=[],this.renderedMessageCount=0,this.isLoadingFromDatabase=!1,this.pageSize=20,this.isFetchingOlder=!1,this.hasMore=!0,this.oldestTimestampLoaded=null,this.messageKeys=new Set,this.makeMessageKey=m=>{var ts="string"==typeof m.timestamp?m.timestamp:String(m.timestamp||"");return m.role+`|${ts}|`+m.content},setTimeout(()=>{this.tabManager=new ChatTabManager(this)},200),this.elements={chatMessages:document.getElementById("chatMessages"),userInput:document.getElementById("userInput"),sendButton:document.getElementById("sendMessage"),clearChatButton:document.getElementById("clearChatBtn"),typingIndicator:null},this.createTypingIndicator(),setTimeout(()=>{this.init()},100)}init(){this.isInitialized?console.warn("CompleteChatSystem: Already initialized"):this.elements.chatMessages?(this.setupEventListeners(),this.subscribeToGlobalState(),this.setupAutoSave(),this.loadChatHistory(),this.isInitialized=!0):console.error("CompleteChatSystem: chatMessages element not found!")}destroy(){console.log("CompleteChatSystem: Destroying..."),this.removeAllEventListeners(),this.messages.clear(),this.messageQueue=[],this.isInitialized=!1}async sendMessage(content){if(content&&content.trim())if(this.isProcessing)this.messageQueue.push(content);else{this.isProcessing=!0,this.disableInput(!0);try{var userMessage=this.createMessage("user",content.trim()),aiResponse=(await this.addMessage(userMessage),this.showTypingIndicator(),await this.getAIResponse(content)),assistantMessage=(this.hideTypingIndicator(),this.createMessage("assistant",aiResponse));await this.addMessage(assistantMessage),this.processMessageQueue()}catch(error){console.error("CompleteChatSystem: Error sending message:",error),this.hideTypingIndicator(),await this.addMessage(this.createMessage("assistant","Sorry, I encountered an error. Please try again."))}finally{this.isProcessing=!1,this.disableInput(!1)}}}async getAIResponse(userMessage){try{var currentProject=this.globalState.getState(),response=await this.api.sendChatMessage(userMessage,currentProject);if(response&&response.assistantReply)return response.assistantReply;throw new Error("No response from AI")}catch(error){throw console.error("CompleteChatSystem: AI response error:",error),error}}processMessageQueue(){if(0<this.messageQueue.length&&!this.isProcessing){let nextMessage=this.messageQueue.shift();setTimeout(()=>this.sendMessage(nextMessage),100)}}createMessage(role,content,metadata={}){var timestamp=(new Date).toISOString();return{id:`${role}_${Date.now()}_`+Math.random().toString(36).substr(2,9),role:role,content:content,timestamp:timestamp,metadata:{...metadata,retryCount:0,status:"sent"}}}async addMessage(message){var key;return console.log("CHAT DEBUG: addMessage called with:",message),this.validateMessage(message)?this.isDuplicate(message)?(console.log("CHAT DEBUG: Duplicate message detected, skipping"),!1):(key=this.makeMessageKey(message),!this.messageKeys.has(key)&&(this.messageKeys.add(key),this.messages.set(message.id,message),this.renderMessage(message),"assistant"===message.role&&(console.log("IDEAS DEBUG: Parsing AI response for ideas:",message.content),0<(key=this.parseIdeasFromResponse(message.content)).length)&&(console.log("IDEAS DEBUG: Extracted ideas from parsing:",key),await this.addIdeasToBrainstorm(key)),await this.updateGlobalState(),"loaded"!==message.metadata?.status&&await this.saveToDatabase(message),!0)):(console.warn("CompleteChatSystem: Invalid message:",message),!1)}validateMessage(message){return message&&message.id&&message.role&&message.content&&message.timestamp&&["user","assistant"].includes(message.role)}isDuplicate(message){return!!this.messages.has(message.id)||Array.from(this.messages.values()).filter(msg=>msg.role===message.role&&Date.now()-new Date(msg.timestamp).getTime()<5e3).some(msg=>msg.content===message.content)}renderMessage(message,prepend=!1){this.elements.chatMessages?this.elements.chatMessages.querySelector(`[data-message-id="${message.id}"]`)||(message=this.createMessageElement(message),prepend?this.elements.chatMessages.insertBefore(message,this.elements.chatMessages.firstChild):(this.elements.chatMessages.appendChild(message),this.scrollToBottom())):console.error("CompleteChatSystem: Chat messages container not found")}createMessageElement(message){var messageDiv=createElement("div","message "+message.role),contentDiv=(messageDiv.setAttribute("data-message-id",message.id),createElement("div","message-content",message.content)),displayTime=message.timestamp||(new Date).toISOString(),displayTime=createElement("div","message-time",this.formatTime(displayTime));return messageDiv.appendChild(contentDiv),messageDiv.appendChild(displayTime),"assistant"===message.role&&(contentDiv=createElement("div","message-actions"),(displayTime=createElement("button","regenerate-btn","↻")).title="Regenerate this response",displayTime.addEventListener("click",()=>this.regenerateMessage(message)),contentDiv.appendChild(displayTime),messageDiv.appendChild(contentDiv)),messageDiv}createTypingIndicator(){this.elements.chatMessages&&(this.elements.typingIndicator=createElement("div","typing-indicator"),this.elements.typingIndicator.innerHTML=`
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span class="typing-text">AI is typing...</span>
        `,this.elements.typingIndicator.style.display="none",this.elements.chatMessages.appendChild(this.elements.typingIndicator))}showTypingIndicator(){this.elements.typingIndicator&&(this.elements.typingIndicator.style.display="flex",this.scrollToBottom())}hideTypingIndicator(){this.elements.typingIndicator&&(this.elements.typingIndicator.style.display="none")}scrollToBottom(){this.elements.chatMessages&&(this.elements.chatMessages.scrollTop=this.elements.chatMessages.scrollHeight)}formatTime(timestamp){let date;return"string"==typeof timestamp?(date=new Date(timestamp),isNaN(date.getTime())&&(date=new Date(1e3*parseInt(timestamp)))):date="number"==typeof timestamp?timestamp<1e10?new Date(1e3*timestamp):new Date(timestamp):new Date,isNaN(date.getTime())?(console.warn("CompleteChatSystem: Invalid timestamp:",timestamp),"Invalid time"):date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}setupEventListeners(){this.elements.sendButton&&(this.sendHandler=e=>{e.preventDefault();e=this.elements.userInput.value.trim();e&&(this.elements.userInput.value="",this.sendMessage(e))},this.elements.sendButton.addEventListener("click",this.sendHandler),this.eventHandlers.set("sendButton",{element:this.elements.sendButton,handler:this.sendHandler,event:"click"})),this.elements.userInput&&(this.keypressHandler=e=>{"Enter"===e.key&&!e.shiftKey&&(e.preventDefault(),e=this.elements.userInput.value.trim())&&(this.elements.userInput.value="",this.sendMessage(e))},this.elements.userInput.addEventListener("keypress",this.keypressHandler),this.eventHandlers.set("userInput",{element:this.elements.userInput,handler:this.keypressHandler,event:"keypress"})),this.elements.clearChatButton&&(this.clearChatHandler=e=>{e.preventDefault(),this.clearChat()},this.elements.clearChatButton.addEventListener("click",this.clearChatHandler),this.eventHandlers.set("clearChatButton",{element:this.elements.clearChatButton,handler:this.clearChatHandler,event:"click"}))}removeAllEventListeners(){this.eventHandlers.forEach(({element,handler,event})=>{element.removeEventListener(event,handler)}),this.eventHandlers.clear()}disableInput(disabled){this.elements.userInput&&(this.elements.userInput.disabled=disabled),this.elements.sendButton&&(this.elements.sendButton.disabled=disabled)}subscribeToGlobalState(){this.globalState&&(this.stateChangeHandler&&this.globalState.unsubscribe("stateChanged",this.stateChangeHandler),this.stateChangeHandler=state=>this.handleStateChange(state),this.globalState.subscribe("stateChanged",this.stateChangeHandler))}handleStateChange(state){state.chatHistory&&Array.isArray(state.chatHistory)&&this.syncWithGlobalState(state.chatHistory)}syncWithGlobalState(chatHistory){var currentCount=this.messages.size,newCount=chatHistory.length;if(currentCount<newCount)for(let i=currentCount;i<newCount;i++){var message=chatHistory[i];this.messages.has(message.id)||(this.messages.set(message.id,message),this.renderMessage(message))}}async updateGlobalState(){var currentState;this.isLoadingFromDatabase||((currentState=this.globalState.getState()).chatHistory=Array.from(this.messages.values()).map(msg=>({role:msg.role,content:msg.content,timestamp:msg.timestamp})),this.globalState.setState(currentState))}async saveToDatabase(message){try{var ts,sessionId;message&&message.role&&message.content?(ts="string"==typeof message.timestamp?Date.parse(message.timestamp)/1e3|0:message.timestamp||Math.floor(Date.now()/1e3),sessionId=this.currentChatId||"default",await this.api.appendChatMessage(sessionId,message.role,message.content,ts)||console.warn("CompleteChatSystem: appendChatMessage reported failure")):console.warn("CompleteChatSystem: saveToDatabase called with invalid message:",message)}catch(error){console.error("CompleteChatSystem: Failed to append chat message:",error)}}async loadChatHistory(){if(!this.isLoadingHistory&&!this.chatHistoryLoaded){this.isLoadingHistory=!0,this.isLoadingFromDatabase=!0;try{var loadingDiv;this.elements.chatMessages&&!this.elements.chatMessages.querySelector(".chat-loading")&&((loadingDiv=document.createElement("div")).className="chat-loading",loadingDiv.innerHTML='<div class="loading-spinner"></div><span>Loading chat history...</span>',this.elements.chatMessages.appendChild(loadingDiv)),this.api.loadChatHistoryPage(this.pageSize,null,800).then(chatHistoryArray=>{var loadingDiv=this.elements.chatMessages?.querySelector(".chat-loading");loadingDiv&&loadingDiv.remove(),chatHistoryArray&&Array.isArray(chatHistoryArray)&&0<chatHistoryArray.length?(loadingDiv=chatHistoryArray.map(m=>{let ts=m.timestamp;var parsed;return ts?"string"==typeof ts?(parsed=Date.parse(ts),ts=isNaN(parsed)?parseInt(ts)||Math.floor(Date.now()/1e3):Math.floor(parsed/1e3)):"number"==typeof ts&&(ts=ts<1e10?ts:Math.floor(ts/1e3)):ts=m.created_at||Math.floor(Date.now()/1e3),{id:m.id||`${m.role}_${ts}_`+Math.random().toString(36).substr(2,5),role:m.role,content:m.content,timestamp:ts,metadata:{status:"loaded"}}}).sort((a,b)=>(a.timestamp||0)-(b.timestamp||0)),this.allChatMessages=loadingDiv,this.oldestTimestampLoaded=loadingDiv.length?loadingDiv[0].timestamp:null,this.hasMore=loadingDiv.length===this.pageSize,this.renderedMessageCount=0,this.messages.clear(),this.elements.chatMessages&&(this.elements.chatMessages.innerHTML=""),requestAnimationFrame(()=>this.renderNextBatch(Math.min(10,this.pageSize))),this.setupScrollListener()):this.chatHistoryLoaded=!0,this.isLoadingHistory=!1,this.isLoadingFromDatabase=!1}).catch(()=>{var loadingDiv=this.elements.chatMessages?.querySelector(".chat-loading");loadingDiv&&loadingDiv.remove(),this.isLoadingHistory=!1,this.isLoadingFromDatabase=!1,this.chatHistoryLoaded=!0})}catch(error){console.error("CompleteChatSystem: Failed to start chat history load:",error),this.isLoadingHistory=!1,this.isLoadingFromDatabase=!1}}}setupScrollListener(){if(this.elements.chatMessages){let messagesContainer=this.elements.chatMessages,isScrolling=!1;messagesContainer.addEventListener("scroll",()=>{isScrolling||(isScrolling=!0,requestAnimationFrame(()=>{messagesContainer.scrollTop<100&&this.fetchOlderMessages(),isScrolling=!1}))})}}renderNextBatch(batchSize=10){var startIndex=this.renderedMessageCount,endIndex=Math.min(startIndex+batchSize,this.allChatMessages.length);if(this.elements.chatMessages){var fragment=document.createDocumentFragment();for(let i=startIndex;i<endIndex;i++){var message=this.allChatMessages[i];if(message&&message.role&&message.content){let displayTimestamp=message.timestamp;displayTimestamp="number"==typeof displayTimestamp?new Date(1e3*displayTimestamp).toISOString():displayTimestamp||(new Date).toISOString();var message={id:message.id||`${message.role}_${message.timestamp||Date.now()}_`+Math.random().toString(36).substr(2,9),role:message.role,content:message.content,timestamp:displayTimestamp,metadata:{retryCount:0,status:"loaded"}},key=this.makeMessageKey(message);this.messageKeys.has(key)||(this.messageKeys.add(key),this.messages.set(message.id,message),key=this.createMessageElement(message),fragment.appendChild(key))}}this.elements.chatMessages.appendChild(fragment),this.scrollToBottom(),this.renderedMessageCount=endIndex,this.renderedMessageCount>=this.allChatMessages.length&&(this.chatHistoryLoaded=!0)}}async fetchOlderMessages(){if(!this.isFetchingOlder&&this.hasMore){this.isFetchingOlder=!0;try{var older,normalized,before=this.oldestTimestampLoaded;before?(older=await this.api.loadChatHistoryPage(this.pageSize,before))&&0!==older.length?(normalized=older.map(m=>{let ts=m.timestamp;var parsed;return ts?"string"==typeof ts?(parsed=Date.parse(ts),ts=isNaN(parsed)?parseInt(ts)||Math.floor(Date.now()/1e3):Math.floor(parsed/1e3)):"number"==typeof ts&&(ts=ts<1e10?ts:Math.floor(ts/1e3)):ts=m.created_at||Math.floor(Date.now()/1e3),{id:m.id||`${m.role}_${ts}_`+Math.random().toString(36).substr(2,5),role:m.role,content:m.content,timestamp:ts,metadata:{status:"loaded"}}}).sort((a,b)=>(a.timestamp||0)-(b.timestamp||0)),this.allChatMessages=[...normalized,...this.allChatMessages],this.oldestTimestampLoaded=this.allChatMessages[0]?.timestamp||this.oldestTimestampLoaded,normalized.forEach(msg=>{var key;this.messages.has(msg.id)||(key=this.makeMessageKey(msg),this.messageKeys.has(key))||(this.messageKeys.add(key),this.messages.set(msg.id,msg),this.renderMessage(msg,!0))})):this.hasMore=!1:this.hasMore=!1}catch(e){console.error("fetchOlderMessages failed:",e)}finally{this.isFetchingOlder=!1}}}setupAutoSave(){}parseIdeasFromResponse(response){let ideas=[];return[/I've added ["']([^"']+)["'] to your ideas/i,/added ["']([^"']+)["'] to your ideas/i,/Here are some fresh ideas: ["']([^"']+)["']/i,/Here are some ideas: ["']([^"']+)["']/i,/Here's an idea: ["']?([^"'\n]+)["']?/i,/Here is an idea: ["']?([^"'\n]+)["']?/i,/suggestion: ["']?([^"'\n]+)["']?/i,/consider: ["']?([^"'\n]+)["']?/i,/idea: ["']?([^"'\n]+)["']?/i,/["']([^"']+)["']/g].forEach((pattern,index)=>{if(pattern.global)for(var match;null!==(match=pattern.exec(response));)match[1]&&3<(match=match[1].trim()).length&&match.length<100&&!ideas.includes(match)&&ideas.push(match);else{var matches=response.match(pattern);if(matches&&matches[1]){let idea=matches[1].trim();3<idea.length&&idea.length<100&&!ideas.includes(idea)&&ideas.push(idea)}}}),ideas}async addIdeasToBrainstorm(ideas){if(console.log("IDEAS DEBUG: addIdeasToBrainstorm called with:",ideas),ideas&&0!==ideas.length)try{console.log("IDEAS DEBUG: Getting projectManager:",this.projectManager),console.log("IDEAS DEBUG: Getting AIWritingAssistant from window:",window.aiWritingAssistant);var aiWritingAssistant=window.aiWritingAssistant,planModule=aiWritingAssistant?.modules?.plan;if(console.log("IDEAS DEBUG: PlanModule from AIWritingAssistant:",planModule),planModule&&planModule.addIdeaBubble){console.log("IDEAS DEBUG: PlanModule has addIdeaBubble method");for(var idea of ideas){console.log("IDEAS DEBUG: Processing idea:",idea);var existingIdeas=Array.from(planModule.bubbles.values()).map(bubble=>bubble.content.toLowerCase());console.log("IDEAS DEBUG: Existing ideas:",existingIdeas),existingIdeas.includes(idea.toLowerCase())?console.log("IDEAS DEBUG: Idea already exists, skipping:",idea):(console.log("IDEAS DEBUG: Adding new idea:",idea),planModule.addIdeaBubble(idea),console.log("IDEAS DEBUG: Idea added successfully"))}}else console.error("IDEAS DEBUG: PlanModule not found or addIdeaBubble method missing",{aiWritingAssistant:aiWritingAssistant,modules:aiWritingAssistant?.modules,plan:aiWritingAssistant?.modules?.plan,hasAddIdeaBubble:planModule?.addIdeaBubble})}catch(error){console.error("CompleteChatSystem: Error adding ideas to brainstorm:",error)}else console.log("IDEAS DEBUG: No ideas to add")}async regenerateMessage(message){if("assistant"===message.role)try{var userMessage,aiResponse,newAssistantMessage,messagesArray=Array.from(this.messages.values()),messageIndex=messagesArray.findIndex(msg=>msg.id===message.id);0<messageIndex&&"user"===(userMessage=messagesArray[messageIndex-1]).role&&(this.removeMessage(message.id),this.showTypingIndicator(),aiResponse=await this.getAIResponse(userMessage.content),this.hideTypingIndicator(),newAssistantMessage=this.createMessage("assistant",aiResponse),await this.addMessage(newAssistantMessage))}catch(error){console.error("CompleteChatSystem: Error regenerating message:",error),this.hideTypingIndicator()}}async regenerateLastMessage(){var messagesArray=Array.from(this.messages.values());2<=messagesArray.length&&(messagesArray=messagesArray[messagesArray.length-1],await this.regenerateMessage(messagesArray))}clearChat(){this.messages.clear(),this.elements.chatMessages&&(this.elements.chatMessages.innerHTML=""),this.updateGlobalState()}removeMessage(messageId){this.messages.delete(messageId);messageId=this.elements.chatMessages.querySelector(`[data-message-id="${messageId}"]`);messageId&&messageId.remove(),this.updateGlobalState()}getMessages(){return Array.from(this.messages.values())}getMessageCount(){return this.messages.size}clearMessages(){this.messages.clear(),this.elements.chatMessages&&(this.elements.chatMessages.innerHTML=""),this.updateGlobalState()}loadMessages(messages){Array.isArray(messages)?(this.messages.clear(),this.elements.chatMessages&&(this.elements.chatMessages.innerHTML=""),messages.forEach(message=>{message.role&&message.content&&(message={id:message.id||`${message.role}_${Date.now()}_`+Math.random().toString(36).substr(2,9),role:message.role,content:message.content,timestamp:message.timestamp||(new Date).toISOString(),metadata:message.metadata||{retryCount:0,status:"loaded"}},this.messages.set(message.id,message),this.renderMessage(message))}),this.updateGlobalState()):console.warn("CompleteChatSystem: loadMessages called with non-array:",messages)}}window.addEventListener("error",event=>{if(event.message&&event.message.includes("addRange(): The given range isn't in document"))return event.preventDefault(),console.warn("Suppressed addRange() error from Quill editor"),!1});class GlobalState{constructor(){this.state=deepClone(DEFAULT_PROJECT_SCHEMA),this.listeners=new Map,this.silentMode=!1}getState(){return deepClone(this.state)}setState(newState,silent=!1){this.state=deepClone(newState),silent||this.silentMode||this.notifyListeners("stateChanged",this.state)}updateState(updates,silent=!1){this.setState({...this.state,...updates},silent)}setSilentMode(enabled){this.silentMode=enabled}subscribe(event,callback){this.listeners.has(event)||this.listeners.set(event,[]),this.listeners.get(event).push(callback)}notifyListeners(event,data){this.silentMode||this.listeners.get(event)?.forEach(callback=>{try{callback(data)}catch(error){console.error(`Event handler error for ${event}:`,error)}})}}class ProjectManager{constructor(globalState,api){this.globalState=globalState,this.api=api,this.isReady=!1,this.isSaving=!1,this.saveQueued=!1,this.lastSaveTime=null,this.modules=new Map,this.autosaveTimer=null,this.autosavePending=!1,this.autosaveDebounceMs=1e3,this.autosaveMinIntervalMs=3e4,this.isOnline=navigator.onLine,window.addEventListener("online",()=>{this.isOnline=!0,!this.autosavePending&&null!==this.autosaveTimer||this.scheduleAutoSave("online-retry")}),window.addEventListener("offline",()=>{this.isOnline=!1,this.globalState.notifyListeners("autosave_offline",{})}),this.init()}async init(){try{console.log("Testing AJAX connection...");var connectionTest=await this.api.testConnection();console.log("AJAX connection test:",connectionTest?"PASSED":"FAILED"),await this.loadProject(),this.isReady=!0,this.globalState.notifyListeners("ready",this.globalState.getState())}catch(error){console.error("ProjectManager: Initialization failed:",error),this.globalState.notifyListeners("error",error)}}async loadProject(){try{var project=await this.api.loadProject();project?(console.log("=== ProjectManager.loadProject() START ==="),console.log("Loaded project from API:",JSON.stringify(project,null,2)),console.log("Goal in loaded project:",project.metadata?.goal),console.log("Goal type:",typeof project.metadata?.goal),project.metadata||(project.metadata={}),null==project.metadata.goal?project.metadata.goal="":project.metadata.goal=String(project.metadata.goal),console.log("Goal after normalization:",project.metadata.goal),this.globalState.setState(project),this.globalState.notifyListeners("ready",project),console.log("=== ProjectManager.loadProject() END ===")):(console.warn("No existing project found, creating new one"),this.createNewProject())}catch(error){console.error("Failed to load project:",error),this.createNewProject()}}createNewProject(){var newProject=deepClone(DEFAULT_PROJECT_SCHEMA);return newProject.metadata.created=formatDate(new Date),newProject.metadata.modified=formatDate(new Date),newProject.metadata.currentTab="plan",newProject.metadata.instructorInstructions=window.instructorDescription||"",this.globalState.setState(newProject),newProject}registerModule(name,module){this.modules.set(name,module)}collectAllData(){let collectedData=deepClone(this.globalState.getState());collectedData.metadata.modified=formatDate(new Date),this.modules.forEach((module,moduleName)=>{try{if("function"==typeof module.collectData){let moduleData=module.collectData();moduleData&&Object.keys(moduleData).forEach(key=>{collectedData[key]?collectedData[key]={...collectedData[key],...moduleData[key]}:collectedData[key]=moduleData[key]})}}catch(error){console.error(`ProjectManager: Error collecting data from ${moduleName}:`,error)}});var goalInput=document.getElementById("assignmentGoal");let goal="";return goal=goalInput?goalInput.value.trim():collectedData.metadata?.goal||"",window.aiWritingAssistant&&window.aiWritingAssistant.tabManager?(goalInput=window.aiWritingAssistant.tabManager.getCurrentTab(),collectedData.metadata={...collectedData.metadata,currentTab:goalInput,instructorInstructions:window.instructorDescription||"",goal:goal}):collectedData.metadata={...collectedData.metadata,goal:goal},collectedData.chatHistory&&delete collectedData.chatHistory,collectedData}async saveProject(){if(this.isSaving)return this.saveQueued=!0;this.isSaving=!0;try{this.globalState.notifyListeners("autosave_saving",{reason:"direct"});var completeProjectData=this.collectAllData(),success=(console.log("ProjectManager.saveProject(): write content length=",completeProjectData?.write?.content?.length||0),await this.api.saveProject(completeProjectData));if(success)return this.lastSaveTime=new Date,this.globalState.notifyListeners("saved",completeProjectData),this.globalState.notifyListeners("autosave_saved",{reason:"direct",at:(new Date).toISOString()}),!0;throw new Error("Save failed")}catch(error){return console.error("ProjectManager: Failed to save project:",error),this.globalState.notifyListeners("error",error),!1}finally{this.isSaving=!1,this.saveQueued&&(this.saveQueued=!1,this.saveProject().catch(()=>{}))}}scheduleAutoSave(reason="unspecified",force=!1){var elapsed=Date.now()-(this.lastSaveTime?this.lastSaveTime.getTime():0);if(this.isOnline){this.autosaveTimer&&(clearTimeout(this.autosaveTimer),this.autosaveTimer=null);let delay=this.autosaveDebounceMs;!force&&elapsed<this.autosaveMinIntervalMs&&(force=this.autosaveMinIntervalMs-elapsed,delay=Math.max(this.autosaveDebounceMs,force)),this.autosavePending=!0,this.globalState.notifyListeners("autosave_scheduled",{reason:reason,delay:delay}),this.autosaveTimer=setTimeout(async()=>{try{this.globalState.notifyListeners("autosave_saving",{reason:reason}),await this.saveProject(),this.globalState.notifyListeners("autosave_saved",{reason:reason,at:(new Date).toISOString()})}catch(e){this.globalState.notifyListeners("autosave_error",{reason:reason,error:e})}finally{this.autosavePending=!1,this.autosaveTimer=null}},delay)}else this.autosavePending=!0,this.globalState.notifyListeners("autosave_offline",{reason:reason})}getProject(){return this.globalState.getState()}updateMetadata(metadata){var currentState=this.globalState.getState();currentState.metadata={...currentState.metadata,...metadata,modified:formatDate(new Date)},this.globalState.setState(currentState,!0)}updatePlan(planData){var currentState=this.globalState.getState();currentState.plan={...currentState.plan,...planData},this.globalState.setState(currentState,!0)}updateWrite(writeData){var currentState=this.globalState.getState();currentState.write={...currentState.write,...writeData},this.globalState.setState(currentState,!0)}updateEdit(editData){var currentState=this.globalState.getState();currentState.edit={...currentState.edit,...editData},this.globalState.setState(currentState,!0)}updateUI(uiData){var currentState=this.globalState.getState();currentState.ui={...currentState.ui,...uiData},this.globalState.setState(currentState,!0)}async addChatMessage(role,content){var currentState=this.globalState.getState(),content={role:role,content:content,timestamp:formatDate(new Date),id:`${role}_${Date.now()}_`+Math.random().toString(36).substr(2,9)};if(currentState.chatHistory.push(content),this.globalState.setState(currentState),"assistant"===role)try{await this.saveProject()}catch(error){console.warn("ProjectManager: Failed to save project after assistant message:",error.message)}}ready(){return this.isReady}}class PlanModule{constructor(globalState,projectManager,api){this.globalState=globalState,this.projectManager=projectManager,this.api=api,this.domManager=new DOMManager,this.bubbles=new Map,this.sections=new Map,this.isInitialized=!1,this.isDragging=!1,this.restoreTimeout=null,this.handleAddIdeaClick=this.handleAddIdeaClick.bind(this),this.projectManager.registerModule("plan",this),this.init()}init(){this.setupElements(),this.setupDragAndDrop(),this.setupEventListeners(),this.setupStateSync(),this.loadTemplate(),this.isInitialized=!0}setupElements(){this.elements={ideaBubbles:this.domManager.getElement("ideaBubbles"),outlineItems:this.domManager.getElement("outlineItems"),addIdeaBubbleBtn:this.domManager.getElement("addIdeaBubble")}}setupDragAndDrop(){"undefined"==typeof Sortable?console.error("Sortable.js not loaded"):this.elements.ideaBubbles&&new Sortable(this.elements.ideaBubbles,{group:{name:"bubbles",pull:!0,put:["bubbles"]},sort:!1,animation:150,onStart:evt=>{this.isDragging=!0},onEnd:evt=>{this.isDragging=!1,this.handleDragEnd(evt)}})}setupEventListeners(){this.elements.addIdeaBubbleBtn&&this.domManager.addEventListener(this.elements.addIdeaBubbleBtn,"click",this.handleAddIdeaClick);var goalInput=document.getElementById("assignmentGoal");if(goalInput&&this.projectManager){let debounceTimer=null;goalInput.addEventListener("input",()=>{debounceTimer&&clearTimeout(debounceTimer),debounceTimer=setTimeout(()=>{console.log("PlanModule: Goal autosave triggered (debounced input)"),this.projectManager.saveProject().catch(e=>{console.error("PlanModule: Goal autosave failed:",e)})},300)}),goalInput.addEventListener("blur",()=>{debounceTimer&&(clearTimeout(debounceTimer),debounceTimer=null),console.log("PlanModule: Goal save triggered (blur)"),this.projectManager.saveProject().catch(e=>{console.error("PlanModule: Goal save on blur failed:",e)})}),window.addEventListener("beforeunload",()=>{debounceTimer&&(clearTimeout(debounceTimer),debounceTimer=null),this.projectManager.saveProject().catch(()=>{})},{once:!0})}document.addEventListener("bubbleContentChanged",event=>{var{bubbleId:event,content}=event.detail,event=this.bubbles.get(event);event&&(event.content=content)}),document.addEventListener("bubbleDeleted",event=>{event=event.detail.bubbleId;this.handleBubbleDeleted(event)})}handleAddIdeaClick(){this.addIdeaBubble()}async handleBubbleDeleted(bubbleId){try{var node,bubble=this.bubbles.get(bubbleId),payload=bubble?{id:bubbleId,content:bubble.content||"",location:bubble.location||"brainstorm",sectionId:bubble.sectionId||""}:bubbleId;await this.api.deleteIdea(payload)?(this.bubbles.delete(bubbleId),(node=document.querySelector(`.idea-bubble[data-id="${bubbleId}"]`))&&node.parentNode&&node.parentNode.removeChild(node),console.log("PlanModule: Bubble deleted from DB and UI:",bubbleId)):console.warn("PlanModule: Backend delete returned false for",bubbleId)}catch(e){console.warn("PlanModule: Delete idea failed:",e?.message||e)}}triggerAutoSave(){this.projectManager.scheduleAutoSave("plan",!0)}setupStateSync(){this.globalState.subscribe("ready",state=>{var restoreGoal;console.log("DEBUG: PlanModule received ready event with state:",state),this.isInitialized&&state.plan&&state.plan.ideas?(console.log("DEBUG: Ready event - restoring bubbles from state.plan.ideas:",state.plan.ideas),this.restoreBubblesFromState(state.plan.ideas)):(console.log("DEBUG: Ready event - no ideas to restore or not initialized"),console.log("  isInitialized:",this.isInitialized),console.log("  state.plan:",state.plan),console.log("  state.plan.ideas:",state.plan?state.plan.ideas:"N/A")),state.metadata&&state.metadata.goal&&(console.log("PlanModule: Goal found in state, will restore:",state.metadata.goal),(restoreGoal=()=>{var currentValue,goalInput=document.getElementById("assignmentGoal");return!!goalInput&&((currentValue=goalInput.value.trim())||goalInput.value===state.metadata.goal?currentValue&&console.log("PlanModule: Goal input has value, preserving user input:",currentValue):(goalInput.value=state.metadata.goal,console.log("PlanModule: Goal restored to:",goalInput.value)),!0)})()||setTimeout(restoreGoal,100),setTimeout(restoreGoal,300),setTimeout(restoreGoal,1e3))}),this.globalState.subscribe("aiUpdate",updatedProject=>{this.isInitialized&&updatedProject.plan&&updatedProject.plan.ideas&&this.handleAIUpdates(updatedProject.plan.ideas)})}handleAIUpdates(ideas){Array.isArray(ideas)&&ideas.filter(idea=>idea.aiGenerated&&"brainstorm"===idea.location&&!this.bubbles.has(idea.id)).forEach(idea=>{idea=new BubbleComponent(idea.content,idea.id,!0);this.bubbles.set(idea.id,idea),this.elements.ideaBubbles&&this.elements.ideaBubbles.appendChild(idea.element)})}restoreBubblesFromState(ideas){console.log("DEBUG: restoreBubblesFromState called with:",ideas);let ideasArray;if(Array.isArray(ideas))ideasArray=ideas;else{if("object"!=typeof ideas||null===ideas)return void console.log("DEBUG: No ideas to restore or invalid format");ideasArray=Object.values(ideas),console.log("DEBUG: Converted object ideas to array:",ideasArray)}console.log("DEBUG: Restoring",ideasArray.length,"ideas"),this.clearAllBubbles(),ideasArray.forEach((idea,index)=>{var section;console.log(`DEBUG: Processing idea ${index}:`,idea),idea.id&&idea.content?((index=new BubbleComponent(idea.content,idea.id,idea.aiGenerated||!1)).location=idea.location||"brainstorm",index.sectionId=idea.sectionId||null,this.bubbles.set(index.id,index),"brainstorm"===idea.location?this.elements.ideaBubbles&&(this.elements.ideaBubbles.appendChild(index.element),console.log("DEBUG: Added bubble to brainstorm:",idea.content)):"outline"===idea.location&&idea.sectionId?(section=this.sections.get(idea.sectionId))?(section=section.element.querySelector(".outline-container"))&&(section.appendChild(index.element),(index=section.querySelector(".dropzone-placeholder"))&&index.remove(),section.classList.remove("empty")):console.warn("Section not found for bubble:",idea.sectionId):console.warn("Invalid bubble location or missing sectionId:",idea)):console.warn("Invalid idea data:",idea)}),console.log("DEBUG: Finished restoring bubbles. Map now has",this.bubbles.size,"entries")}clearAllBubbles(){this.elements.ideaBubbles&&(this.elements.ideaBubbles.innerHTML=""),this.sections.forEach(section=>{var placeholder,section=section.element.querySelector(".outline-container");section&&(section.innerHTML="",section.classList.add("empty"),(placeholder=createElement("div","dropzone-placeholder","Drop ideas here to create outline items")).draggable=!1,section.appendChild(placeholder))}),this.bubbles.clear()}async handleDragEnd(evt){var bubbleId=evt.item.dataset.id,bubble=this.bubbles.get(bubbleId);bubble?evt.to===this.elements.ideaBubbles?bubble.setLocation("brainstorm"):(evt=evt.to.closest(".template-section"))?(evt=evt.dataset.sectionId,bubble.setLocation("outline",evt)):console.warn("Could not find section element for dropped bubble"):console.warn("Bubble not found in bubbles map:",bubbleId);try{await this.projectManager.saveProject()}catch(e){console.warn("PlanModule: Save after drag failed:",e?.message||e)}}async loadTemplate(){try{var templateId=window.selectedTemplate||"argumentative",template=await this.api.loadTemplate(templateId);template&&template.sections&&0<template.sections.length?this.createSections(template.sections):(console.warn("No template sections found, creating default sections"),this.createDefaultSections())}catch(error){console.error("Failed to load template:",error),console.warn("Creating default sections as fallback"),this.createDefaultSections()}}createDefaultSections(){this.createSections([{id:"introduction",title:"Introduction",description:"Hook, background, and thesis statement",required:!0,allowMultiple:!1,editableTitle:!0,editableDescription:!0,outline:[]},{id:"main-arguments",title:"Main Arguments",description:"Your key points supporting your thesis",required:!0,allowMultiple:!0,editableTitle:!0,editableDescription:!0,outline:[]},{id:"conclusion",title:"Conclusion",description:"Restate thesis and summarize main points",required:!0,allowMultiple:!1,editableTitle:!0,editableDescription:!0,outline:[]}])}createSections(sections){this.elements.outlineItems&&(this.elements.outlineItems.innerHTML="",sections.forEach(sectionData=>{sectionData=new SectionComponent(sectionData);this.sections.set(sectionData.id,sectionData),this.setupSectionDragAndDrop(sectionData),this.elements.outlineItems.appendChild(sectionData.element)}))}setupSectionDragAndDrop(section){"undefined"!=typeof Sortable&&(section=section.element.querySelector(".outline-container"))&&new Sortable(section,{group:{name:"bubbles",pull:!0,put:["bubbles"]},sort:!0,animation:150,onStart:evt=>{this.isDragging=!0},onEnd:evt=>{this.isDragging=!1,this.handleDragEnd(evt)}})}addIdeaBubble(content=" "){let bubble=new BubbleComponent(content);if(bubble.location="brainstorm",this.bubbles.set(bubble.id,bubble),this.elements.ideaBubbles){this.elements.ideaBubbles.appendChild(bubble.element);let contentDiv=bubble.element.querySelector(".bubble-content");contentDiv.focus(),contentDiv.addEventListener("blur",()=>{var finalContent=contentDiv.textContent.trim();finalContent&&finalContent!==0<finalContent.length?(bubble.content=finalContent,this.triggerAutoSave()):finalContent&&"New idea"!==finalContent||(bubble.content=finalContent||"")},{once:!1})}console.log("DEBUG: Added bubble to Map:",this.bubbles.size,"bubbles"),console.log("DEBUG: Bubble data:",{id:bubble.id,content:bubble.content,location:bubble.location})}collectBubbleData(){let brainstormBubbles=[],outlineBubbles=[];console.log("DEBUG: collectBubbleData - bubbles Map has",this.bubbles.size,"entries"),this.bubbles.forEach((bubble,id)=>{console.log("DEBUG: Processing bubble:",id,bubble);id={id:bubble.id,content:bubble.content,location:bubble.location||"brainstorm",sectionId:bubble.sectionId||null,aiGenerated:bubble.aiGenerated||!1};"brainstorm"===id.location?brainstormBubbles.push(id):"outline"===id.location&&outlineBubbles.push(id)});var allBubbles=[...brainstormBubbles,...outlineBubbles];return console.log("DEBUG: collectBubbleData result:",allBubbles),allBubbles}saveAllBubbles(){return this.collectBubbleData()}collectData(){var currentBubbles=this.collectBubbleData();let outline=[];this.sections.forEach(section=>{section={id:section.id,title:section.title,description:section.description,bubbles:section.getBubbles()};outline.push(section)});var templateName=window.selectedTemplate||"argumentative";return{plan:{templateName:templateName,templateDisplayName:this.getTemplateDisplayName(templateName),ideas:currentBubbles,outline:outline,customSectionTitles:{},customSectionDescriptions:{}}}}getTemplateDisplayName(templateId){return{argumentative:"Argumentative Essay",comparative:"Comparative Essay","lab-report":"Lab Report","test-template":"Test Template"}[templateId]||templateId}}class BaseEditorModule{constructor(globalState,projectManager,editorId,moduleName){this.globalState=globalState,this.projectManager=projectManager,this.editorId=editorId,this.moduleName=moduleName,this.editor=null,this.init()}init(){this.initializeEditor(),this.setupEventListeners()}initializeEditor(){var editorContainer=document.getElementById(this.editorId);if(editorContainer)try{this.editor=new Quill("#"+this.editorId,quillConfig),this.editor.format("size","12pt"),editorContainer.classList.add("quill-page"),this.setupEditorEvents()}catch(error){console.error(`Failed to initialize ${this.moduleName} editor:`,error)}}setupEditorEvents(){if(this.editor){let debounceTimer=null;this.editor.on("text-change",(delta,oldDelta,source)=>{"user"===source&&(debounceTimer&&clearTimeout(debounceTimer),debounceTimer=setTimeout(()=>{console.log(this.moduleName+": Triggering autosave after text-change"),this.projectManager.saveProject().catch(e=>{console.error(this.moduleName+": Autosave failed:",e)})},300))})}else console.warn(this.moduleName+": Editor not initialized, cannot setup autosave")}setupEventListeners(){this.globalState.subscribe("ready",state=>{state=state[this.moduleName.toLowerCase()];state&&this.editor&&(this.editor.root.innerHTML=state.content||"")})}calculateWordCount(){return this.editor?this.editor.getText().trim().split(/\s+/).filter(word=>0<word.length).length:0}}class WriteModule extends BaseEditorModule{constructor(globalState,projectManager){super(globalState,projectManager,"writeEditor","Write"),this.projectManager.registerModule("write",this),this.lastSaveWasManual=!1}handleTextChange(content){}collectData(){var content=this.editor?this.editor.root.innerHTML:"",wordCount=this.calculateWordCount(),changeSummary=this.lastSaveWasManual?"Manual save":"Auto-saved",changeSummary=(console.log("WriteModule.collectData(): content length="+content.length+", wordCount="+wordCount+", changeSummary="+changeSummary+", lastSaveWasManual="+this.lastSaveWasManual),this.lastSaveWasManual),content=(this.lastSaveWasManual=!1,{write:{content:content,wordCount:wordCount,changeSummary:changeSummary?"Manual save":"Auto-saved"}});return content}}class EditModule extends BaseEditorModule{constructor(globalState,projectManager){super(globalState,projectManager,"editEditor","Edit"),this.projectManager.registerModule("edit",this),this.lastSaveWasManual=!1}handleTextChange(content){}collectData(){var content=this.editor?this.editor.root.innerHTML:"",wordCount=this.calculateWordCount(),currentState=this.globalState.getState(),wasManual=this.lastSaveWasManual,content=(this.lastSaveWasManual=!1,{edit:{content:content,wordCount:wordCount,suggestions:currentState.edit?.suggestions||[],changeSummary:wasManual?"Manual save":"Auto-saved"}});return content}}class AIWritingAssistant{constructor(){this.globalState=new GlobalState,this.api=new ProjectAPI,this.projectManager=new ProjectManager(this.globalState,this.api),this.chatSystem=new CompleteChatSystem(this.globalState,this.api,this.projectManager),this.saveStatus=null,this.modules={plan:null,write:null,edit:null},this.tabManager=null,this.init()}async init(){try{console.log("AIWritingAssistant.init() called"),document.body.classList.add("activity-plan"),console.log("Initializing modules..."),this.initializeModules(),console.log("Modules initialized"),console.log("Creating TabManager..."),console.log("TabManager available:",typeof TabManager),this.tabManager=new TabManager(this.globalState),console.log("TabManager created:",this.tabManager),await this.waitForProjectManager(),this.setupActionButtons(),this.setupGlobalEvents(),this.setupSaveStatusIndicator()}catch(error){console.error("Failed to initialize application:",error)}}async waitForProjectManager(){if(!this.projectManager.ready())return new Promise(resolve=>{this.globalState.subscribe("ready",resolve)})}initializeModules(){this.modules.plan=new PlanModule(this.globalState,this.projectManager,this.api),this.modules.write=new WriteModule(this.globalState,this.projectManager),this.modules.edit=new EditModule(this.globalState,this.projectManager),this.projectManager.registerModule("chat",this.chatSystem),this.versionHistory=new VersionHistoryManager(this.api),this.setupChatManagerConnection()}setupChatManagerConnection(){this.globalState.subscribe("stateChanged",state=>{state.chatHistory&&Array.isArray(state.chatHistory)&&this.chatSystem.getMessages().length!==state.chatHistory.length&&this.chatSystem.loadMessages(state.chatHistory)}),this.globalState.subscribe("ready",state=>{state.chatHistory&&Array.isArray(state.chatHistory)&&this.chatSystem.loadMessages(state.chatHistory)})}setupActionButtons(){var saveBtn=document.getElementById("saveBtn"),saveExitBtn=document.getElementById("saveExitBtn"),exitBtn=document.getElementById("exitBtn");saveBtn&&saveBtn.addEventListener("click",()=>this.handleSave()),saveExitBtn&&saveExitBtn.addEventListener("click",()=>this.handleSaveAndExit()),exitBtn&&exitBtn.addEventListener("click",()=>this.handleExit())}async handleSave(){await this._handleSaveOperation("saveBtn",!1)}async handleSaveAndExit(){await this._handleSaveOperation("saveExitBtn",!0)}async _handleSaveOperation(buttonId,shouldExit=!1){let button=document.getElementById(buttonId);if(button){let originalText=button.innerHTML;try{button.disabled=!0,button.innerHTML="Saving...",this.modules.write&&(this.modules.write.lastSaveWasManual=!0),this.modules.edit&&(this.modules.edit.lastSaveWasManual=!0),this.updateUIState(),await this.projectManager.saveProject()?(button.innerHTML="Saved!",setTimeout(()=>{shouldExit?this.handleExit():(button.innerHTML=originalText,button.disabled=!1)},shouldExit?1e3:2e3)):this._resetButton(button,originalText)}catch(error){console.error("Save error:",error),this._resetButton(button,originalText)}}}updateUIState(){}_resetButton(button,originalText){button.innerHTML="Save Failed",setTimeout(()=>{button.innerHTML=originalText,button.disabled=!1},3e3)}handleExit(){var courseUrl=window.location.href.split("/mod/writeassistdev/")[0]+"/course/view.php?id="+window.courseId;window.location.href=courseUrl}setupGlobalEvents(){this.globalState.subscribe("ready",state=>{this.restoreUIFromState(state)}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.projectManager.saveProject().catch(()=>{})}),window.addEventListener("beforeunload",()=>{this.projectManager.saveProject().catch(()=>{})})}setupSaveStatusIndicator(){var el=document.createElement("div");el.id="saveStatusIndicator",el.style.cssText=`
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 12px;
            box-shadow: var(--shadow-sm);
            opacity: 0.85;
            display: none;
            z-index: 9999;`,document.body.appendChild(el),this.saveStatus=el;let show=text=>{this.saveStatus&&(this.saveStatus.textContent=text,this.saveStatus.style.display="block")},hideLater=(ms=1500)=>{this.saveStatus&&setTimeout(()=>{this.saveStatus.style.display="none"},ms)};this.globalState.subscribe("autosave_saving",()=>show("Saving…")),this.globalState.subscribe("autosave_saved",()=>{show("Saved"),hideLater()}),this.globalState.subscribe("autosave_error",()=>{show("Save error"),hideLater(3e3)}),this.globalState.subscribe("autosave_offline",()=>show("Offline - will save later"))}restoreUIFromState(state){console.log("=== restoreUIFromState START ==="),console.log("Full state:",JSON.stringify(state,null,2)),console.log("Metadata:",state?.metadata),console.log("Goal value:",state?.metadata?.goal),console.log("Goal type:",typeof state?.metadata?.goal);let goalToRestore=null!=state?.metadata?.goal?String(state.metadata.goal):"";var planTab;console.log("Goal to restore:",goalToRestore),state.metadata&&state.metadata.currentTab&&(this.tabManager.switchTab(state.metadata.currentTab),planTab=document.getElementById("plan"))&&!planTab.classList.contains("active")&&planTab.classList.add("active");let restoreGoal=()=>{let goalInput=document.getElementById("assignmentGoal");if(goalInput){console.log("=== restoreGoal() called ==="),console.log("Found goal input element"),console.log("Element is visible:",null!==goalInput.offsetParent),console.log("Element display:",window.getComputedStyle(goalInput).display),console.log("Element in DOM:",document.body.contains(goalInput)),console.log("Current input value BEFORE:",goalInput.value),console.log("Goal to restore:",goalToRestore),console.log("Goal length:",goalToRestore?goalToRestore.length:0);var currentValue=goalInput.value.trim();if(currentValue)console.log("⚠️ Goal input has current value, preserving user input:",currentValue),console.log("Not restoring from state to avoid overwriting user input");else{goalToRestore&&0<goalToRestore.length?(goalInput.value=goalToRestore,console.log("Input value AFTER assignment:",goalInput.value),console.log("Input value length:",goalInput.value.length),goalInput.value!==goalToRestore&&(console.error("⚠️ Value assignment failed! Expected:",goalToRestore,"Got:",goalInput.value),(currentValue=goalInput.cloneNode(!1)).value=goalToRestore,goalInput.parentNode.replaceChild(currentValue,goalInput),currentValue.id="assignmentGoal",currentValue.className=goalInput.className,console.log("Replaced element, new value:",currentValue.value))):console.warn("Goal to restore is empty, skipping");currentValue=document.getElementById("assignmentGoal")?.value||"";console.log("FINAL Input value after restore:",currentValue),console.log("FINAL Input value length:",currentValue.length),console.log("Placeholder visible?",!currentValue&&document.getElementById("assignmentGoal")?.hasAttribute("placeholder"));let watchCount=0,watcher=setInterval(()=>{watchCount++,goalInput.value!==goalToRestore&&goalToRestore&&(console.error("🚨 GOAL VALUE WAS CLEARED! Attempt #"+watchCount),console.error("Expected:",goalToRestore),console.error("Actual:",goalInput.value),console.trace("Stack trace:"),goalInput.value=goalToRestore),50<=watchCount&&(clearInterval(watcher),console.log("Stopped watching goal input"))},100);setTimeout(()=>{goalInput.value!==goalToRestore&&goalToRestore?(console.warn("⚠️ Goal value was cleared after 50ms! Re-setting..."),goalInput.value=goalToRestore):console.log("✅ Goal value confirmed after 50ms:",goalInput.value)},50),setTimeout(()=>{goalInput.value!==goalToRestore&&goalToRestore?(console.warn("⚠️ Goal value was cleared after 200ms! Re-setting..."),goalInput.value=goalToRestore):console.log("✅ Goal value confirmed after 200ms:",goalInput.value)},200),setTimeout(()=>{goalInput.value!==goalToRestore&&goalToRestore?(console.warn("⚠️ Goal value was cleared after 1000ms! Re-setting..."),goalInput.value=goalToRestore):(console.log("✅ Goal value confirmed after 1000ms:",goalInput.value),console.log("Final check - Input visible:",null!==goalInput.offsetParent),console.log("Final check - Display style:",window.getComputedStyle(goalInput).display))},1e3)}return!0}return console.warn("Goal input element not found, will retry"),!1};requestAnimationFrame(()=>{requestAnimationFrame(()=>{restoreGoal()?console.log("=== restoreUIFromState END (success) ==="):setTimeout(()=>{restoreGoal()?console.log("=== restoreUIFromState END (retry 2) ==="):setTimeout(()=>{restoreGoal()?console.log("=== restoreUIFromState END (retry 3) ==="):setTimeout(()=>{var restored=restoreGoal();restored||(console.error("❌ FAILED to restore goal after all attempts!"),console.error("Element exists:",!!document.getElementById("assignmentGoal")),console.error("Tab active:",document.getElementById("plan")?.classList.contains("active"))),console.log("Final restore attempt result:",restored),console.log("=== restoreUIFromState END ===")},500)},300)},200)})}),state.chatHistory&&Array.isArray(state.chatHistory)&&this.chatSystem.loadMessages(state.chatHistory)}handleProjectUpdates(updatedProject){updatedProject.plan&&updatedProject.plan.ideas&&this.handleNewIdeas(updatedProject.plan.ideas),updatedProject.edit&&updatedProject.edit.suggestions&&this.handleNewSuggestions(updatedProject.edit.suggestions),updatedProject.write&&updatedProject.write.content&&this.handleContentUpdates(updatedProject.write.content)}handleNewIdeas(ideas){this.modules.plan&&Array.isArray(ideas)&&ideas.filter(idea=>idea.aiGenerated&&"brainstorm"===idea.location).forEach(idea=>{idea=new BubbleComponent(idea.content,idea.id,!0);this.modules.plan.bubbles.set(idea.id,idea),this.modules.plan.elements.ideaBubbles&&this.modules.plan.elements.ideaBubbles.appendChild(idea.element)})}handleNewSuggestions(suggestions){this.modules.edit&&Array.isArray(suggestions)&&suggestions.filter(suggestion=>suggestion.aiGenerated).forEach(suggestion=>{console.log("New AI suggestion:",suggestion)})}handleContentUpdates(content){this.modules.write&&this.modules.write.editor&&this.modules.write.editor.root.innerHTML!==content&&(this.modules.write.editor.root.innerHTML=content)}async saveProject(){try{await this.projectManager.saveProject()?(console.log("Project saved successfully"),this.showSaveFeedback("Project saved successfully!","success")):(console.error("Save project failed"),this.showSaveFeedback("Failed to save project","error"))}catch(error){console.error("Save project error:",error),this.showSaveFeedback("Error saving project: "+error.message,"error")}}showSaveFeedback(message,type){let feedback=document.createElement("div");feedback.className="save-feedback "+type,feedback.textContent=message,feedback.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            ${"success"===type?"background: #28a745;":"background: #dc3545;"}
        `,document.body.appendChild(feedback),setTimeout(()=>{feedback.style.animation="slideOut 0.3s ease-in",setTimeout(()=>{feedback.parentNode&&feedback.parentNode.removeChild(feedback)},300)},3e3)}}function initializeApp(){if(console.log("Initializing AI Writing Assistant..."),window.aiWritingAssistant)console.log("AI Writing Assistant already initialized, skipping...");else try{void 0===TabManager?console.error("TabManager not available"):(window.aiWritingAssistant=new AIWritingAssistant,console.log("AI Writing Assistant initialized successfully"))}catch(error){console.error("Failed to initialize application:",error),console.error("Error details:",error.stack)}}function waitForReady(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(initializeApp,100)}):setTimeout(initializeApp,100)}waitForReady(),window.checkVersions=function(){return window.versionInfo?(console.log("Plugin Version:",window.versionInfo.plugin_version),window.versionInfo):(console.log("Version information not available"),null)};class VersionHistoryManager{constructor(api){this.api=api,this.currentPhase="write",this.selectedVersion=null,this.elements={modal:document.getElementById("versionHistoryModal"),closeBtn:document.getElementById("versionModalClose"),openBtn:document.getElementById("versionHistoryBtn"),phaseTabs:document.querySelectorAll(".version-tab-btn"),versionList:document.getElementById("versionList"),previewBtn:document.getElementById("versionPreviewBtn"),restoreBtn:document.getElementById("versionRestoreBtn")},this.init()}init(){this.elements.modal&&(this.elements.openBtn&&this.elements.openBtn.addEventListener("click",()=>this.open()),this.elements.closeBtn&&this.elements.closeBtn.addEventListener("click",()=>this.close()),this.elements.modal&&this.elements.modal.addEventListener("click",e=>{e.target===this.elements.modal&&this.close()}),this.elements.phaseTabs.forEach(btn=>{btn.addEventListener("click",()=>{this.switchPhase(btn.dataset.phase)})}),this.elements.previewBtn&&this.elements.previewBtn.addEventListener("click",()=>this.previewVersion()),this.elements.restoreBtn)&&this.elements.restoreBtn.addEventListener("click",()=>this.restoreVersion())}async open(){this.elements.modal&&(this.elements.modal.style.display="flex",await this.loadVersions(this.currentPhase))}close(){this.elements.modal&&(this.elements.modal.style.display="none",this.selectedVersion=null,this.updateButtons())}async switchPhase(phase){this.currentPhase=phase,this.elements.phaseTabs.forEach(btn=>{btn.classList.toggle("active",btn.dataset.phase===phase)}),this.selectedVersion=null,await this.loadVersions(phase),this.updateButtons()}async loadVersions(phase){if(this.elements.versionList){this.elements.versionList.innerHTML='<div class="version-loading">Loading versions...</div>';try{var listHtml,versions=await this.api.getVersionHistory(phase);0===versions.length?this.elements.versionList.innerHTML='<div class="version-empty">No version history yet</div>':(listHtml=versions.map(v=>{var dateStr=new Date(1e3*v.created_at).toLocaleString();return`
                    <div class="version-item ${this.selectedVersion===v.version_number?"selected":""}" data-version="${v.version_number}">
                        <div class="version-number">Version ${v.version_number}</div>
                        <div class="version-summary">${v.change_summary||"Auto-saved"}</div>
                        <div class="version-meta">
                            <span class="version-date">${dateStr}</span>
                            <span class="version-words">${v.word_count||0} words</span>
                        </div>
                    </div>
                `}).join(""),this.elements.versionList.innerHTML=listHtml,this.elements.versionList.querySelectorAll(".version-item").forEach(item=>{item.addEventListener("click",()=>{this.elements.versionList.querySelectorAll(".version-item").forEach(i=>i.classList.remove("selected")),item.classList.add("selected"),this.selectedVersion=parseInt(item.dataset.version),this.updateButtons()})}))}catch(e){console.error("Failed to load versions:",e),this.elements.versionList.innerHTML='<div class="version-error">Failed to load versions</div>'}}}updateButtons(){var hasSelection=null!==this.selectedVersion;this.elements.previewBtn&&(this.elements.previewBtn.disabled=!hasSelection),this.elements.restoreBtn&&(this.elements.restoreBtn.disabled=!hasSelection)}async previewVersion(){if(this.selectedVersion)try{var version=await this.api.getVersion(this.currentPhase,this.selectedVersion);version&&window.open("","_blank").document.write(`
                    <html>
                        <head><title>Version ${version.version_number} Preview</title></head>
                        <body style="padding: 20px; font-family: Arial;">
                            <h2>Version ${version.version_number} Preview</h2>
                            <p><strong>Saved:</strong> ${new Date(1e3*version.created_at).toLocaleString()}</p>
                            <p><strong>Summary:</strong> ${version.change_summary||"Auto-saved"}</p>
                            <p><strong>Words:</strong> ${version.word_count||0}</p>
                            <hr>
                            <div>${version.content}</div>
                        </body>
                    </html>
                `)}catch(e){console.error("Failed to preview version:",e),alert("Failed to preview version")}}async restoreVersion(){if(this.selectedVersion&&confirm(`Restore Version ${this.selectedVersion}? This will replace your current content.`))try{var module,phaseData;await this.api.restoreVersion(this.currentPhase,this.selectedVersion)?(alert("Version restored successfully! Refreshing content..."),window.aiWritingAssistant&&window.aiWritingAssistant.projectManager&&(await window.aiWritingAssistant.projectManager.loadProject(),module="write"===this.currentPhase?window.aiWritingAssistant.modules.write:window.aiWritingAssistant.modules.edit)&&module.editor&&(phaseData=window.aiWritingAssistant.globalState.getState()[this.currentPhase])&&phaseData.content&&(module.editor.root.innerHTML=phaseData.content),this.close()):alert("Failed to restore version")}catch(e){console.error("Failed to restore version:",e),alert("Failed to restore version")}}}